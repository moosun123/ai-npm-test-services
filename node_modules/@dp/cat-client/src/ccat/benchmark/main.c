#include <stdio.h>

#include "lib/cat_time_util.h"
#include "lib/cat_thread.h"

#include "cat/client.h"

#define PROCESS_PER_THREAD 400

/**
 * Decode api params from binary sequence, which use cpu resources.
 */
void decode(char* buf) {
    logEvent("RPC", "before-decode", CAT_SUCCESS, "");
    for (int i = 0; i < 1000; i++) {
        int n = 0;
        for (int j = 0; j < 4; j++) {
            n <<= 8;
            n += buf[4 * i + j];
        }
    }
    logEvent("RPC", "after-decode", CAT_SUCCESS, "");
}

/**
 * Most Api contains several remote-calls, which can cause context-switch.
 * So we use sleep to simulate these procedures.
 */
void process(CatTransaction *t) {
    t->setStatus(t, CAT_SUCCESS);
    logEvent("RPC", "before-sleep", CAT_SUCCESS, "");
    Sleep(3);
    logEvent("RPC", "after-sleep", CAT_SUCCESS, "");
}

/**
 * Encode api result to binary sequence, which use cpu resources.
 */
void encode(char* buf) {
    logEvent("RPC", "before-encode", CAT_SUCCESS, "");
    for (int i = 0; i < 10000; i++) {
        for (int j = 0, n = i; j < 4; j++, n >>= 8) {
            buf[(i % 1000) * 4 + j] = (char) (n | 0b11111111);
        }
    }
    logEvent("RPC", "after-encode", CAT_SUCCESS, "");
}

/**
 * simulate a rpc service procedure.
 */
void task() {
    char buf[4000];
    CatTransaction *t = newTransaction("RPC", "test");
    decode(buf);
    process(t);
    encode(buf);
    t->setComplete(t);
}

PTHREAD run(PVOID para) {
    for(int i = 0; i < PROCESS_PER_THREAD; i++) {
        task();
    }
    return NULL;
}

void test(int threadNum) {
    pthread_t threads[threadNum];

    u_int64 s = GetTime64();

    for (int i = 0; i < threadNum; i++) {
        pthread_create(&threads[i], NULL, run, NULL);
    }
    for (int i = 0; i < threadNum; i++) {
        pthread_join(threads[i], NULL);
    }

    u_int64 t = GetTime64();

    double qps = (double) (threadNum * PROCESS_PER_THREAD) / (t - s) * 1000;

    printf("Thread Num: %5d, qps: %lf\n", threadNum, qps);
}

int main() {
    catClientInit("ccat");
    test(1);
    test(2);
    test(4);
    test(8);
    test(16);
    test(32);
    test(64);
    test(128);
    test(256);
}

