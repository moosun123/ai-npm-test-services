rm -rf cmake-unittest
rm -rf html
mkdir cmake-unittest

cd cmake-unittest
cmake -DBUILD_TEST=1 ..
make -j

./unittest --gtest_output=xml:gtestreport.xml
mv gtestreport.xml ../

if [[ "$OSTYPE" == "darwin"* ]]; then
    gcovr -r ../src/ --object-directory ./CMakeFiles/unittest.dir/src --html -o coverage.html
    open coverage.html
else
    lcov -d ./CMakeFiles/unittest.dir/src/ -c -o application.raw.info --rc lcov_branch_coverage=1
    export _UD=`pwd` && export _S=`dirname $_UD`
    lcov -e application.raw.info "$_S*" -o application.info --rc lcov_branch_coverage=1
    genhtml -o html --legend --show-details -t "ccat test coverage" application.info --rc lcov_branch_coverage=1
    tar -czf html.tar.gz html/
    mv html ../ && mv html.tar.gz ../
fi

cd ..
