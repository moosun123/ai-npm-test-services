#include "properties.h"
#include <stdio.h>
#include <string.h>
#include <cat/client_config.h>
#include "cat_clog.h"

int extractKv(char *src, char *key, char *value) {
    char *p, *q;

    if (*src == '#') return 0;

    p = strchr(src, '=');
    q = strchr(src, '\n');

    if (p != NULL && q != NULL) {
        *q = '\0';
        strncpy(key, src, p - src);
        strcpy(value, p + 1);
        return 1;
    } else {
        return 0;
    }
}

catsds getEnvProperty(const char *filename, const char *key) {
    FILE *fd;
    catsds env = catsdsnew("unknown");
    char buf[50] = "";
    char keyBuf[50] = "";
    char valueBuf[100] = "";

    fd = fopen(filename, "r");

    if (fd == NULL) {
        g_config.logger->warning("Cannot open file '%s', using '%s' as default env!", filename, env);
        return env;
    }

    while (fgets(buf, 50, fd)) {
        if (extractKv(buf, keyBuf, valueBuf)) {
            if (strcmp(keyBuf, key) == 0) {
                env = catsdscpy(env, valueBuf);
                g_config.logger->info("Env: %s.", env);
            }
            memset(keyBuf, 0, strlen(keyBuf));
            memset(valueBuf, 0, strlen(valueBuf));
        }
    }
    fclose(fd);

    return env;
}