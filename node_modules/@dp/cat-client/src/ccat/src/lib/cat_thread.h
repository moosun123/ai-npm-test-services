//
// Created by Terence on 2018/8/22.
//

#ifndef CCAT_CAT_THREAD_H
#define CCAT_CAT_THREAD_H

#include "headers.h"

#ifdef _WIN32

typedef HANDLE pthread_t;

#define PTHREAD DWORD WINAPI

#define pthread_create(thrp, attr, func, arg)                               \
    (((*(thrp) = CreateThread(NULL, 0,                                     \
        (LPTHREAD_START_ROUTINE)(func), (arg), 0, NULL)) == NULL) ? -1 : 0)

#define pthread_join(thr, statusp)                                          \
    ((WaitForSingleObject((thr), INFINITE) == WAIT_OBJECT_0) &&            \
    ((statusp == NULL) ? 0 :                            \
    (GetExitCodeThread((thr), (LPDWORD)(statusp)) ? 0 : -1)))

#else

#define PTHREAD void*
#define PVOID void*

#endif

/**
 * Get current thread id
 * @return
 */
static inline pid_t cat_get_thread_id() {
    pid_t pid = 0;
#if defined(__linux__)
    pid = syscall(SYS_gettid);
#elif defined(__APPLE__) && defined(__MACH__)
    uint64_t tid64;
    pthread_threadid_np(NULL, &tid64);
    pid = (pid_t) tid64;
#endif
    return pid;
}

/**
 * Set name to the current thread.
 * @param name
 * @return
 */
static inline int cat_set_thread_name(const char* name) {
#if defined(__linux__)
    return prctl(PR_SET_NAME, name, NULL, NULL, NULL);
#elif defined(__APPLE__) && defined(__MACH__)
    return pthread_setname_np(name);
#else
    return 0;
#endif
}

/**
 * Get current thread name.
 * @return
 */
static inline char* cat_get_thread_name() {
    pthread_t self = pthread_self();
    char* name = malloc(128);
    pthread_getname_np(self, name, 128);
    return name;
}

#ifdef WIN32
#define CATTHREADLOCAL __declspec(thread)
#elif defined(__linux__) || defined(__APPLE__)
#define CATTHREADLOCAL __thread
#else
#define CATTHREADLOCAL
#endif

#endif //CCAT_CAT_THREAD_H
