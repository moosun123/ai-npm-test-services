#include "cat/client_config.h"
#include "cat_clog.h"
#include "cat_mutex.h"

#if defined(__linux__) || defined(__APPLE__)
static char* logDir = "/data/applogs/cat/ccat";
static char* tmpDir = "/tmp/ccat";
#else
static char *logDir = "CatInnerLog";
static char *tmpDir = "CatInnerLog";
#endif

static int MillisIn1Hour = 60 * 60 * 1000;
static u_int64 localCurrentHour = 0;
static volatile FILE* logfile = NULL;
CatCriticalSection catInnerLogFileLock = NULL;

enum CatLoggingType {
    DEBUG = 0,
    INFO = 1,
    WARNING = 2,
    ERROR = 3,
};

static char* CatLoggingTypeNames[] = {
        [DEBUG] = "debug",
        [INFO] = "info",
        [WARNING] = "warning",
        [ERROR] = "error",
};


void default_cat_info_log(const char *format, ...);
void default_cat_debug_log(const char *format, ...);
static void innerLog(const char* loggingLevel, const char* content);

static unsigned int isInfoEnabled() {
    return g_config.loggingLevelForDefaultCatLogger & CAT_LOG_INFO;
}

static unsigned int isDebugEnabled() {
    return g_config.loggingLevelForDefaultCatLogger & CAT_LOG_DEBUG;
}

inline void _CLog_datePostfix(char *tmp, size_t size) {
    time_t t = time(0);
    struct tm tm_now = cat_nolocks_localtime(t);
    strftime(tmp, size, "_%Y_%m_%d", &tm_now);
}

inline void _CLog_timePrefix(char *tmp, size_t size) {
    time_t t = time(0);
    struct tm tm_now = cat_nolocks_localtime(t);
    strftime(tmp, size, "%Y-%m-%d %X", &tm_now);
}

static FILE* openLogFile(char* dir) {
    char filename[512] = {'\0'};

    strncat(filename, dir, 256);
    _CLog_datePostfix(filename + strlen(filename), 128);
    strncat(filename, ".log", 64);

    FILE* output = fopen(filename, "a+");
    if (NULL == output) {
        printf("Cannot open %s for logging.\n", filename);
    } else {
        printf("Writing log to file: %s\n", filename);
    }
    return output;
}

static int CLogUpdateSaveFile() {
    if (!isInfoEnabled() && !isDebugEnabled()) {
        return 0;
    }

    if (NULL != logfile) {
        fclose(logfile);
        logfile = NULL;
    }

    FILE* output = NULL;
    if (NULL != (output = openLogFile(logDir))) {
        logfile = output;
        return 0;
    }
    if (NULL != (output = openLogFile(tmpDir))) {
        logfile = output;
        return 0;
    }

    logfile = NULL;
    printf("Log has been disabled.\n");
    return -1;
}

static void writeLog(const char* loggingLevel, const char* content) {
    char tmpTime[64] = {0};
    _CLog_timePrefix(tmpTime, sizeof(tmpTime));
    char tmpBuf[1024 + 128] = {0};
    snprintf(tmpBuf, 1024 + 128, "%s [%d][%s] %s\n", tmpTime, getpid(), loggingLevel, content);

    u_int64 currentHour = GetTime64() / MillisIn1Hour;

    CATCS_ENTER(catInnerLogFileLock);
    if (currentHour > localCurrentHour) {
        CLogUpdateSaveFile();
        localCurrentHour = currentHour;
    }
    CATCS_LEAVE(catInnerLogFileLock);

    if (NULL != logfile) {
        fputs(tmpBuf, logfile);
        fflush((FILE*)logfile);
    }
}

static void ensureLogFile() {
    if (logfile) {
        return;
    }

    catInnerLogFileLock = CatCreateCriticalSection();
    CATCS_ENTER(catInnerLogFileLock);
    if (logfile == NULL) {
        localCurrentHour = GetTime64() / MillisIn1Hour;
        if (CLogUpdateSaveFile() == 0) {
            writeLog(CatLoggingTypeNames[INFO], "Cat log module has been successfully initialized");
        }
    }
    CATCS_LEAVE(catInnerLogFileLock);
}

static void innerLog(const char* loggingLevel, const char* content) {
    ensureLogFile();
    writeLog(loggingLevel, content);
}

void default_cat_info_log(const char *format, ...) {
    if (!isInfoEnabled() && !isDebugEnabled()) {
        return;
    }

    char szBuffer[1024];

    va_list args;
    va_start(args, format);
    vsnprintf(szBuffer, 1024, format, args);
    va_end(args);

    innerLog(CatLoggingTypeNames[INFO], szBuffer);
}

void default_cat_error_log(const char *format, ...) {
    if (!isInfoEnabled() && !isDebugEnabled()) {
        return;
    }

    char szBuffer[1024];

    va_list args;
    va_start(args, format);
    vsnprintf(szBuffer, 1024, format, args);
    va_end(args);

    innerLog(CatLoggingTypeNames[ERROR], szBuffer);
}

void default_cat_warning_log(const char *format, ...) {
    if (!isInfoEnabled() && !isDebugEnabled()) {
        return;
    }

    char szBuffer[1024];

    va_list args;
    va_start(args, format);
    vsnprintf(szBuffer, 1024, format, args);
    va_end(args);

    innerLog(CatLoggingTypeNames[WARNING], szBuffer);
}

void default_cat_debug_log(const char *format, ...) {
    if (!isDebugEnabled()) {
        return;
    }

    char szBuffer[1024];

    va_list args;
    va_start(args, format);
    vsnprintf(szBuffer, 1024, format, args);
    va_end(args);

    innerLog(CatLoggingTypeNames[DEBUG], szBuffer);
}

