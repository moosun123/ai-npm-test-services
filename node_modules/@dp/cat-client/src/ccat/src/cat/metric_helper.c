#include "cat/metric_helper.h"

#include <stdio.h>
#include <stdlib.h>

#include "aggregator_metric_tag.h"

#include "lib/cat_sds.h"

int isCatEnabled();

static inline CatMetricHelper *CatAddTags(CatMetricHelper *pHelper, int tagCount, ...);

static inline CatMetricHelper *CatAddTag(CatMetricHelper *pHelper, const char *key, const char *val);

static inline CatMetricHelper *CatAddCount(CatMetricHelper *pHelper, int count);

static inline CatMetricHelper *CatAddDuration(CatMetricHelper *pHelper, unsigned long long durationMs);

static inline CatMetricHelper *CatAddName(CatMetricHelper *pHelper, const char *name);


typedef struct _CatMetricHelperInner {
    catDict *tagMap;
    catsds name;
} CatMetricHelperInner;

#define getInnerHelper(pHelper) ((CatMetricHelperInner*)(((char*)(pHelper)) + sizeof(CatMetricHelper)))


static inline void destroyMetricHelper(CatMetricHelper *pHelper) {
    if (pHelper != NULL) {
        CatMetricHelperInner *pInner = getInnerHelper(pHelper);
        if (pInner->tagMap != NULL) {
            catDictRelease(pInner->tagMap);
        }
        if (pInner->name != NULL) {
            catsdsfree(pInner->name);
        }
        free(pHelper);
    }
}

CatMetricHelper *CatBuildMetricHelper(const char *name) {
    CatMetricHelper *pHelper = (CatMetricHelper *) malloc(sizeof(CatMetricHelper) + sizeof(CatMetricHelperInner));
    if (pHelper == NULL) {
        return NULL;
    }
    pHelper->AddCount = CatAddCount;
    pHelper->AddTags = CatAddTags;
    pHelper->AddTag = CatAddTag;
    pHelper->AddDuration = CatAddDuration;
    pHelper->AddName = CatAddName;
    CatMetricHelperInner *pInner = getInnerHelper(pHelper);
    pInner->name = catsdsnew(name);

    pInner->tagMap = NULL;
    return pHelper;
}

static inline CatMetricHelper *CatAddTag(CatMetricHelper *pHelper, const char *key, const char *val) {
    if (!isCatEnabled() || NULL == pHelper) {
        return NULL;
    }
    CatMetricHelperInner *pInner = getInnerHelper(pHelper);
    pInner->tagMap = CatTagMapAdd(pInner->tagMap, key, val);
    return pHelper;
}

static inline CatMetricHelper *CatAddTags(CatMetricHelper *pHelper, int tagCount, ...) {
    if (!isCatEnabled() || NULL == pHelper) {
        return NULL;
    }
    CatMetricHelperInner *pInner = getInnerHelper(pHelper);
    va_list arg_ptr;
    va_start(arg_ptr, tagCount);
    int i = 0;
    for (i = 0; i < tagCount; ++i) {
        const char *key = va_arg(arg_ptr, const char *);
        const char *val = va_arg(arg_ptr, const char *);
        pInner->tagMap = CatTagMapAdd(pInner->tagMap, key, val);
    }
    va_end(arg_ptr);
    return pHelper;
}

static inline CatMetricHelper *CatAddName(CatMetricHelper *pHelper, const char *name) {
    if (!isCatEnabled() || NULL == pHelper) {
        return NULL;
    }
    CatMetricHelperInner *pInner = getInnerHelper(pHelper);
    if (pInner->name != NULL) {
        pInner->name = catsdscpy(pInner->name, name);
    } else {
        pInner->name = catsdsnew(name);
    }
    return pHelper;
}

static inline CatMetricHelper *CatAddCount(CatMetricHelper *pHelper, int count) {
    if (NULL == pHelper) {
        return NULL;
    }
    if (!isCatEnabled()) {
        destroyMetricHelper(pHelper);
        return NULL;
    }

    CatMetricHelperInner *pInner = getInnerHelper(pHelper);

    addCountMetricToTagAggregator(pInner->name, count, pInner->tagMap);
    destroyMetricHelper(pHelper);
    return NULL;
}

static inline CatMetricHelper *CatAddDuration(CatMetricHelper *pHelper, unsigned long long durationMs) {
    if (NULL == pHelper) {
        return NULL;
    }
    if (!isCatEnabled()) {
        destroyMetricHelper(pHelper);
        return NULL;
    }

    CatMetricHelperInner *pInner = getInnerHelper(pHelper);
    addTimerMetricToTagAggregator(pInner->name, durationMs, pInner->tagMap);
    destroyMetricHelper(pHelper);
    return NULL;
}
