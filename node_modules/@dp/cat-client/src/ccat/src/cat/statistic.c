//
// Created by Terence Fan on 3/8/19.
//

#include <lib/cat_atomic.h>

#include "statistic.h"

catStatistic statistic;

static CAT_ATOMICLONG _bytes;
static CAT_ATOMICLONG _overflowed;
static CAT_ATOMICLONG _discarded;
static CAT_ATOMICLONG _produced;

static void onBytes(long bytes) {
    CAT_ATOMICLONG_ADD(&_bytes, bytes);
}

static void onOverflowed() {
    CAT_ATOMICLONG_INC(&_overflowed);
}

static void onDiscarded() {
    CAT_ATOMICLONG_INC(&_discarded);
}

static void onProduced() {
    CAT_ATOMICLONG_INC(&_produced);
}

static inline long atomicGet(CAT_ATOMICLONG *p) {
    while (1) {
        long expected = *p;
        if (CAT_ATOMICLONG_CAS(p, expected, 0)) {
            return expected;
        }
    }
}

static long getBytes() {
    return atomicGet(&_bytes);
}

static long getOverflowed() {
    return atomicGet(&_overflowed);
}

static long getDiscarded() {
    return atomicGet(&_discarded);
}

static long getProduced() {
    return atomicGet(&_produced);
}

void initCatStatistic() {
    statistic.onBytes = onBytes;
    statistic.onDiscarded = onDiscarded;
    statistic.onOverflowed = onOverflowed;
    statistic.onProduced = onProduced;

    statistic.getBytes = getBytes;
    statistic.getDiscarded = getDiscarded;
    statistic.getOverflowed = getOverflowed;
    statistic.getProduced = getProduced;
}
