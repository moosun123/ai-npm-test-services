#include "monitor.h"

#include "version.h"

#include "client_config.h"
#include "context.h"
#include "message_id.h"
#include "message_manager.h"
#include "monitor_collector.h"
#include "problem_filter.h"
#include "router.h"

#include "lib/cat_thread.h"
#include "lib/cat_time_util.h"

extern CatMessageManager g_cat_messageManager;

extern CatProblemFilter g_problem_filter;

static volatile int g_cat_monitorStop = 0;

static pthread_t g_cat_monitorHandle = NULL;

CatClientInfo g_client_info = {"c", ""};

void buildAndSendHeartbeat();

void logVersionAndLanguage();

static PTHREAD catMonitorFun(PVOID para) {
    cat_set_thread_name("cat-monitor");

    CatTransaction *reboot = newTransaction("System", "Reboot");
    logEvent("Reboot", g_cat_messageManager.ip, CAT_SUCCESS, NULL);
    reboot->setComplete((CatMessage *) reboot);

    long startSec = (long) GetTime64() / 1000;
    g_config.logger->info("Cat monitor started at %d seconds.", startSec);

    int runCount = 0;
    while (!g_cat_monitorStop) {
        // check connection status every 1s.
        checkCatActiveConn();

        // reset problem filter
        g_problem_filter.clearCache();

        // Collect and upload heartbeat info every minute.
        if (runCount % 60 == 0 && g_config.enableHeartbeat) {
            logVersionAndLanguage();
            buildAndSendHeartbeat();
        }

        // Update router list every 3m.
        // But the first tick will be triggered after 60s.
        if (runCount % 180 == 60) {
            updateMetaConfig();
        }

        runCount++;
        long delta = (long) (GetTime64() / 1000) - startSec;
        if (delta < runCount) {
            sleepToNextSecond();
        }
    }

    clearCatContext();
    return 0;
}

void logVersionAndLanguage() {
    logEvent("Cat_C_Client_Version", CCAT_VERSION, CAT_SUCCESS, NULL);
    if (strcmp(g_client_info.language, "c") != 0) {
        catsds name = catsdsnew("");
        name = catsdscatfmt(name, "Cat_%s_Client_Version", g_client_info.language);
        logEvent(name, g_client_info.language_version, CAT_SUCCESS, NULL);
        catsdsfree(name);
    }
}

void buildAndSendHeartbeat() {
    // Collect system status
    CatTransaction *t = newTransaction("System", "Status");
    CatTransactionInner * innerT = getInnerTrans(t);
    innerT->inner.ignoreSampleRatio = 1;

    CatHeartBeat *h = newHeartBeat("Heartbeat", g_cat_messageManager.ip);
    char *xmlContent = get_status_report();
    h->addDataPair(h, xmlContent);
    free(xmlContent);
    h->setComplete(h);

    t->setStatus((CatMessage *) t, CAT_SUCCESS);
    t->setComplete((CatMessage *) t);
}

void initCatMonitor() {
    g_cat_monitorStop = 0;
}

void startCatMonitorThread() {
    pthread_create(&g_cat_monitorHandle, NULL, catMonitorFun, NULL);
}

void clearCatMonitor() {
    g_cat_monitorStop = 1;
    pthread_join(g_cat_monitorHandle, NULL);
}

