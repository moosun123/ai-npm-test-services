#include "message_tree.h"

#include "message/message_imp.h"

CatMessageTree* newCatMessageTree() {
    CatMessageTree* tree = (CatMessageTree*) calloc(1, sizeof(CatMessageTree));
    tree->canDiscard = 1;
    return tree;
}

/**
 * Duplicate a similar message tree from an existing message tree.
 * Remain the thread information and reset everything else.
 * @param tree
 * @return
 */
CatMessageTree* duplicateCatMessageTree(CatMessageTree* tree) {
    if (NULL == tree) {
        return newCatMessageTree();
    }
    CatMessageTree* newTree = (CatMessageTree*) calloc(1, sizeof(CatMessageTree));
    newTree->threadGroupName = catsdsdup(tree->threadGroupName);
    newTree->threadId = catsdsdup(tree->threadId);
    newTree->threadName = catsdsdup(tree->threadName);
    newTree->canDiscard = 1;
    return newTree;
}

static void clearCatMessageTree(CatMessageTree* tree) {
    tree->root = NULL;
    if (tree->messageId != NULL) {
        catsdsfree(tree->messageId);
        tree->messageId = NULL;
    }
    if (tree->parentMessageId != NULL) {
        catsdsfree(tree->parentMessageId);
        tree->parentMessageId = NULL;
    }
    if (tree->rootMessageId != NULL) {
        catsdsfree(tree->rootMessageId);
        tree->rootMessageId = NULL;
    }
    if (tree->threadGroupName != NULL) {
        catsdsfree(tree->threadGroupName);
        tree->threadGroupName = NULL;
    }
    if (tree->threadId != NULL) {
        catsdsfree(tree->threadId);
        tree->threadId = NULL;
    }
    if (tree->threadName != NULL) {
        catsdsfree(tree->threadName);
        tree->threadName = NULL;
    }
}

void deleteCatMessageTree(CatMessageTree* tree) {
    if (tree->root != NULL) {
        deleteCatMessage(tree->root);
        tree->root = NULL;
    }
    clearCatMessageTree(tree);
    free(tree);
}
