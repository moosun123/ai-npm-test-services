#include "message_imp.h"

#include "lib/cat_time_util.h"

static void* emptyCall(CatMessage* m) {
    return NULL;
}

static void addData(CatMessage* message, const char* data) {
    CatMessageInner* pInner = getInnerMsg(message);
    if (NULL == pInner->data) {
        pInner->data = catsdsnew(data);
    } else {
        pInner->data = catsdscat(pInner->data, "&");
        pInner->data = catsdscat(pInner->data, data);
    }
}

static void addKV(CatMessage* message, const char* dataKey, const char* dataValue) {
    CatMessageInner* pInner = getInnerMsg(message);

    if (NULL == pInner->data) {
        pInner->data = catsdsnew(dataKey);
        pInner->data = catsdscat(pInner->data, "=");
        pInner->data = catsdscat(pInner->data, dataValue);
    } else {
        pInner->data = catsdscat(pInner->data, "&");
        pInner->data = catsdscat(pInner->data, dataKey);
        pInner->data = catsdscat(pInner->data, "=");
        pInner->data = catsdscat(pInner->data, dataValue);
    }
}

static void setStatus(CatMessage* message, const char* status) {
    CatMessageInner* pInner = getInnerMsg(message);
    if (pInner->status == NULL) {
        pInner->status = catsdsnew(status);
    } else {
        pInner->status = catsdscpy(pInner->status, status);
    }
}

void* clearCatMessage(CatMessage* message) {
    CatMessageInner* pInner = getInnerMsg(message);
    if (pInner->status != NULL) {
        catsdsfree(pInner->status);
        pInner->status = NULL;
    }
    if (pInner->data != NULL) {
        catsdsfree(pInner->data);
        pInner->data = NULL;
    }
    if (pInner->type != NULL) {
        catsdsfree(pInner->type);
        pInner->type = NULL;
    }
    if (pInner->name != NULL) {
        catsdsfree(pInner->name);
        pInner->name = NULL;
    }
    return pInner;
}

CatHeartBeat* createHeartBeat(const char* type, const char* name, flusher flush) {
    return createMessage(CatMessageType_HeartBeat, type, name, flush);
}

CatHeartBeat* createEvent(const char* type, const char* name, flusher flush) {
    return createMessage(CatMessageType_Event, type, name, flush);
}

CatMetric* createMetric(const char* type, const char* name, flusher flush) {
    return createMessage(CatMessageType_Metric, type, name, flush);
}

void initCatMessage(CatMessage* pMsg, char msgType, const char* type, const char* name, flusher flush) {
    CatMessageInner* pInner = getInnerMsg(pMsg);
    memset(pInner, 0, sizeof(CatMessage) + sizeof(CatMessageInner));

    pInner->h.msgType = msgType;
    pInner->timestampInMillis = GetTime64();
    pInner->ignoreSampleRatio = 0;
    pInner->type = catsdsnew(type);
    pInner->name = catsdsnew(name);
    pInner->flush = flush;

    pMsg->addData = addKV;
    pMsg->addDataPair = addData;
    pMsg->setComplete = setMessageComplete;
    pMsg->setStatus = setStatus;

    pMsg->clear = emptyCall;
}

