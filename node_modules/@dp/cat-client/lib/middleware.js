/**
 * middleware for KOA
 * */
var Cat = require('./cat')
var stream = require('stream')

module.exports = async function(ctx, next) {
    ctx.cat = new Cat(true)
    await next()
    const isStream = ctx.body instanceof stream.Stream
    if (isStream) {
        ctx.body.on('end', () => {
            ctx.cat.complete()
        })
        ctx.body.on('error', () => {
            ctx.cat.complete()
        })
    } else {
        ctx.cat.complete()
    }
}
