'use strict'
const HeartBeat = require('./message/heartbeat')
const os = require('os')

const systemCollect = require('./sys/collect').collectSysInfo
const interval = require('@dp/simple-util').interval
let config = require('./config')()

const fs = require('fs')
const path = require('path')

const Cat_C_Client_Version = fs.readFileSync(path.join(__dirname, '../ccat/version')).toString().trim()
const Cat_Node_Client_Version = require(path.join(__dirname, '../package.json')).version

exports.collectStart = function(cat) {
    // not working in pm2 cluster mod
    // if (cluster.isWorker) {
    //    //仅让master发心跳, cat server只会保存60条心跳
    //    return;
    // }

    // check pm2 id
    if (process.env && process.env.pm_id) {
        // in pm2 , only one worker does this collection
        try {
            if (process.env.pm_id % os.cpus().length !== 0) {
                return
            }
        } catch (e) {

        }
    }
    cat.logEvent('Reboot', '' + config.ip)

    async function sys() {
        cat.logEvent('Cat_C_Client_Version', Cat_C_Client_Version)
        cat.logEvent('Cat_Node_Client_Version', Cat_Node_Client_Version)
        let status = await systemCollect()
        var t = cat.newTransaction('System', 'Status')

        cat.treeManager.addMessage(new HeartBeat({
            data: '<?xml version="1.0" encoding="utf-8"?>\n' + status.toString()
        }))

        t.setStatus(cat.STATUS.SUCCESS)
        t.complete()
    }

    interval(sys, 60, true)
}
