# cat-client

cat监控 Node 客户端

## 项目简介

cat-client 提供给业务以及中间层埋点的底层sdk。

cat-client通过c语言编译提供c版cat版本的接口，在性能和接口能力上都比js版cat丰富

## 当前版本

![@dp/cat-client version](http://npm.sankuai.com/badge/v/@dp/cat-client.svg?style=flat-square)

如果使用koa1， 请使用v1.x版本

## 支持环境

node >= 8

v2.3.1开始同时支持node v8和v10，如果日志显示无法使用ccat，你确认`/data/appdatas`有读写权限

## Install

### 环境配置

#### cat client.xml 配置 (optional)

如果你本地机器需要查看cat的log, 需要配置文件`/data/appdatas/cat/client.xml`.

具体配置参见[cat client.xml配置](http://docs.sankuai.com/doc/arch_dp/cat/#cat_2)

#### set npm registry

```shell
npm config set registry http://r.npm.sankuai.com/
```

或在项目里添加 `.npmrc`

```runcontrol
@dp:registry=http://r.npm.sankuai.com/
@mtfe:registry=http://r.npm.sankuai.com/
@hfe:registry=http://r.npm.sankuai.com/
@osx:registry=http://r.npm.sankuai.com/

registry=http://r.npm.sankuai.com/

SASS_BINARY_SITE=http://npm.sankuai.com/mirrors/node-sass
sass_binary_site=http://npm.sankuai.com/mirrors/node-sass
```

### install

```shell
# using npm
npm install @dp/cat-client --save

# using yarn
yarn add @dp/cat-client
```

## 使用 Cat-Client

### 初始化

如果你使用了[node-server](http://code.dianpingoa.com/node/node-server/tree/master) ,忽略这步初始化.

如果未使用, 则需要在应用启动阶段手动调用

```js
cat.init({
    appName:"your app name"
});

// 如果使用了koa2，可以使用cat中间件，中间件会有ctx.cat实例
app.use(cat.middleware);

// 如果使用了express ，可以使用cat中间件，中间件会有req.cat实例
app.use(cat.expressMiddleware)
```

### Api Use Case

```js
//log event
Cat.logEvent("URL","/index");

//log error
Cat.logError("error userId not found",e);

//transaction
var t = Cat.newTransaction("URL","/index");

//处理业务逻辑, 推荐使用generator同步写法，以确保其他调用setStatus complete 是在业务逻辑处理之后
//例如 yield biz();

t.setStatus(Cat.STATUS.SUCCESS);
t.complete();
```

### 获取cat实例的3种方式

- `let cat = require('@dp/cat-client')`; 获取全局实例

- `this.cat`; 使用node-server 或者 cat.middleware的推荐使用此方式，以确保每个请求都是单独的实例，相互log没有影响; express对应的是req.cat

- `let cat = new (require('@dp/cat-client')).Cat()` ; 其他应用框架可以在每次请求中手动实例化cat，确保相互log没有影响

## API

### Cat.logEvent(type , name , status, data)

log event , 可以在Cat监控页面的Event中查看

- `type` - {string} required. Event的type.

- `name` - {string} required. Event的name.

- `status` - {string} optional. Event的status，请使用`Cat.STATUS`常量, 默认成功

- `data` - {string} optional. Event的data，默认值为''

### Cat.logError(msg,error)

log error , 可以在Cat监控页面的Problem中查看

- `msg` - {string} optional. 用户需要记录的信息，默认值是Error

- `error` - {string|Error} 2.4.0版本支持error是一个string，将直接作为堆栈信息，否则读取Error.stack

### Cat.newTransaction(type,name)

初始化生成一个transaction handler实例，包含一系列Transaction操作接口。

- `type` - {string} required. Transaction的type，默认值为undefined。

- `name` - {string} required. Transaction的name，默认值为undefined。

#### transactionHandler.setStatus(status)

设置transaction的状态。

`status`: {string} , 参见 `Cat.STATUS`常量

#### transactionHandler.addData(data)

添加transaction的数据，默认值为undefined。

`data`: {string}

#### transactionHandler.complete()

完成transaction。

## Cat.STATUS

`logEvent` ,`transaction.setStatus` 所使用的状态码

- `SUCCESS` 成功
- `FAIL`    失败

## 开发者说明

1. 从3.0.0开始，针对ccat的依赖开始使用submodule的形式，对于一个新的开发者，如果想要重新构建这个项目的话需要进行以下操作

   ```shell
   git clone ssh://..
   git submodule update --remote src/ccat
   ```

## 发布checklist

1. 修改package.json中的version
2. 修改package.json中的ccat_version

## 文档链接

<https://km.sankuai.com/page/63043924>

## ChangeLog

[ChangeLog](./CHANGELOG.md)
