<template>
  <div class="check-apply-wrap">
    <div v-if="loading" class="loading-wrap">
      <mtd-loading size="large" type="line-scale" message="正在检测申请任务..." />
    </div>
    <div v-else class="content-wrap">
      <div v-if="list.length">以下资源您已经发起申请流程，请勿重复申请：</div>
      <div class="progress-wrap">
        <div v-for="(item, idx) in list" :key="idx" class="apply-progress-group">
          <div class="apply-process-header">
            申请ID（{{ item.processId }}）
            <mtd-button size="small" @click="handleCopyText(item.url)">复制催办链接</mtd-button>
          </div>
          <div class="progressList-wrap">
            <Progress :progress="item.progressList" />
            <div class="auth-apply-detail">{{ item.title }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script lang="ts">
import { Component, Vue, Prop } from 'vue-property-decorator';
import Progress from './Progress.vue';

const applyProgressStatusDict = new Map()
  .set(-2, { label: '撤销', status: 'cancel' })
  .set(-1, { label: '驳回', status: 'error' })
  .set(0, { label: '待审批', status: 'wait' })
  .set(1, { label: '通过', status: 'finish' })
  .set(2, { label: '审批中', status: 'process' })
  .set(3, { label: '提交申请', status: 'finish' });

@Component({
  components: {
    Progress
  }
})
export default class CheckedModal extends Vue {
  @Prop({
    required: true,
    type: String
  })
  public env!: string;

  @Prop({
    type: Boolean
  })
  public loading!: false;

  @Prop({
    required: true,
    type: String
  })
  public system!: string;

  @Prop({
    required: true,
    type: Array
  })
  public processList!: any[];

  get isMoshuIframe() {
    return this.system === 'moshu';
  }

  get currMoshuHost(): string {
    switch (this.env) {
      case 'development':
        return 'http://mdbi.bi.dev.sankuai.com';
      case 'test':
        return 'http://mdbi.bi.test.sankuai.com';
      case 'staging':
        return 'http://mdbi.bi.st.sankuai.com';
      case 'production':
        return 'https://bi.sankuai.com';
      default:
        return 'https://bi.sankuai.com';
    }
  }

  get list() {
    return (this.processList || []).map((item: any) => {
      item.title = `${item.startTime}申请过【${item.resourceTitle}】权限，申请ID：${item.processId}`;
      item.url = this.genApproveLink(item.processId);
      item.progressList = item.progressList.map((d: any) => {
        d.taskStatusDesc = applyProgressStatusDict.get(d.taskStatus).label || '';
        d.taskStatusDescTag = applyProgressStatusDict.get(d.taskStatus).status;
        d.auditorsDesc = d.auditors.map((a: User) => a.userName + '/' + a.misId).join(',');
        return d;
      });
      return item;
    });
  }

  private genApproveLink(processId: string) {
    // http://auth.bi.test.sankuai.com/mobile/approval/detail/1605932671565
    // ?orderType=to_approve&source=notify
    // &pcUrl=http%3A%2F%2Fauth.bi.test.sankuai.com%2Fapprove%3FprocessId%3D1605932671565%26source%3Dnotify
    let origin = '';

    switch (this.env) {
      case 'development':
        origin = 'http://auth.bi.dev.sankuai.com';
        break;
      case 'test':
        origin = 'http://auth.bi.test.sankuai.com';
        break;
      case 'staging':
        origin = 'http://auth.bi.st.sankuai.com';
        break;
      case 'production':
        origin = 'https://auth.sankuai.com';
        break;
    }
    // type: urge 为催办链接
    let pcUrl = `${origin}/approve?processId=${processId}&source=notify&type=urge`;
    // 魔数连接
    // pcUrl = `https://bi.sankuai.com/dacs/permission-approval/%s?isNewApply=1&source=notify`;
    // pcUrl = `http://mdbi.bi.st.sankuai.com/dacs/permission-approval/%s?isNewApply=1&source=notify`;
    // pcUrl = `http://mdbi.bi.test.sankuai.com/dacs/permission-approval/%s?isNewApply=1&source=notify`;
    if (this.isMoshuIframe) {
      pcUrl = `${this.currMoshuHost}/dacs/permission-approval/${processId}?isNewApply=1&source=notify&type=urge`;
    }
    return (
      `${origin}/mobile/approval/detail/${processId}` +
      '?orderType=to_approve&source=notify&type=urge' +
      `&pcUrl=${encodeURIComponent(pcUrl)}`
    );
  }

  private handleCopyText(url: string) {
    const input = document.createElement('input'); // js创建一个input输入框
    input.value = url; // 将需要复制的文本赋值到创建的input输入框中，this.ruleForm.url这个是我要复制的内容
    document.body.appendChild(input); // 将输入框暂时创建到实例里面
    input.select(); // 选中输入框中的内容
    document.execCommand('Copy'); // 执行复制操作
    document.body.removeChild(input); // 最后删除实例中临时创建的input输入框，完成复制操作
    this.$mtd.message({ type: 'success', message: '复制成功' });
  }
}
</script>

<style lang="scss">
.check-apply-wrap {
  margin: 10px 0;
  max-width: 560px;
  width: 80vw;
  top: 70px;
  bottom: 50px;
  z-index: 100;
  background: white;
  overflow: auto;
  .loading-wrap {
    padding: 20px;
  }
  .content-wrap {
    .process-title-warp {
      margin-top: 10px;
      word-break: break-all;
      div {
        margin-bottom: 10px;
      }
    }
    .progress-wrap {
      margin-top: 10px;
      border: 1px solid #e0e3eb;
      border-radius: 6px;
      .process-title {
        margin: 10px;
        font-weight: 700;
      }
      .auth-apply-detail {
        padding: 0 10px;
        font-size: 10px;
        color: #999;
      }
      .apply-progress-group {
        .apply-process-header {
          padding: 10px;
          border-bottom: 1px solid #e0e3eb;
          border-top: 1px solid #e0e3eb;
        }
        &:first-child .apply-process-header {
          border-top: none;
        }
      }
      .progressList-wrap {
        margin: 10px;
        .progress-wrapper {
          overflow: auto;
        }
      }
    }
    .btn-wrap {
      justify-content: flex-end;
    }
  }
}
</style>
