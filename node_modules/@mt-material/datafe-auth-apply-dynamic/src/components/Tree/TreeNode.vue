<template>
  <div
    :title="item[props.title]"
    :class="getNodeClass(item)"
    :style="{
      paddingLeft: item.level - 1 ? 24 * (item.level - 1) + 'px' : 0,
      height: option.itemHeight + 'px'
    }"
    @click.stop="e => $emit('node-click', item, e)"
    :draggable="draggable"
    @dragstart="e => handleDragStart(item, e)"
    @dragover="e => handleDragOver(item, e)"
    @drop="e => handleDrop(item, e)"
  >
    <div class="tree-expand-icon-wrap">
      <!-- 非异步加载 -->
      <i
        class="mtdicon mtdicon-triangle-right auth-apply-mtdicon-triangle-right"
        :class="{
          expandTransform: item.expand,
          expandTransformReturn: !item.expand
        }"
        @click.stop="$emit('toggle-expand', item)"
        v-if="!loadData && item.childLen"
      />
      <!-- 异步加载时，未点击，或者点击加载完毕并且有数据 -->
      <i
        class="mtdicon mtdicon-triangle-right auth-apply-mtdicon-triangle-right"
        :class="{
          expandTransform: item.expand,
          expandTransformReturn: !item.expand
        }"
        @click.stop="$emit('toggle-expand', item)"
        v-if="loadData && !item.loading && (item.hasAsyncChildren === undefined || item.hasAsyncChildren === 1)"
      />
      <i v-if="item.loading" class="mtdicon mtdicon-loading"></i>
    </div>

    <!-- 禁用且有禁用文案 -->
    <mtd-tooltip
      v-if="checkable && item[props.checkable] && item[props.disableCheckbox] && item[props.disableCheckboxHoverText]"
      :content="item[props.disableCheckboxHoverText]"
      placement="top"
    >
      <mtd-checkbox
        v-model="item[props.checked]"
        :indeterminate="item[props.indeterminate]"
        :disabled="item[props.disableCheckbox]"
      ></mtd-checkbox>
    </mtd-tooltip>
    <!-- 禁用 -->
    <mtd-checkbox
      v-if="checkable && item[props.checkable] && item[props.disableCheckbox] && !item[props.disableCheckboxHoverText]"
      v-model="item[props.checked]"
      :indeterminate="item[props.indeterminate]"
      :disabled="item[props.disableCheckbox]"
    ></mtd-checkbox>
    <!-- 未禁用 -->
    <mtd-checkbox
      v-if="checkable && item[props.checkable] && !item[props.disableCheckbox]"
      v-model="item[props.checked]"
      :indeterminate="item[props.indeterminate]"
      :disabled="treeDisabled"
      @click.native="stopDefault($event)"
      @input="$emit('toggle-checked', item)"
    ></mtd-checkbox>
    <!-- 默认插槽 -->
    <slot v-bind:treeNode="item">
      <div class="tree-list-content">
        {{ item[props.title] }}
      </div>
    </slot>
  </div>
</template>

<script lang="ts">
import { Component, Vue, Prop } from 'vue-property-decorator';

@Component
export default class TreeNode extends Vue {
  @Prop(Object)
  public item!: ITreeNode;
  @Prop(Object)
  public props!: IProps;
  @Prop(Object)
  public option!: IOption;
  @Prop(Boolean)
  public draggable!: boolean;
  @Prop(Boolean)
  public checkable!: boolean;
  @Prop([Function, Boolean])
  public loadData!: (item: ITreeNode, getAsyncData: Function, flatData: ITreeNode[]) => void | boolean; // 异步加载
  @Prop([String, Function])
  public nodeClass!: (item: ITreeNode) => string | string; // 节点的 class
  @Prop(Boolean)
  public treeDisabled!: boolean; // 是否整棵树禁用

  public stopDefault(e: Event) {
    // 阻止 checkout 冒泡
    e.stopPropagation();
  }

  public getNodeClass(item: ITreeNode) {
    let className = 'tree-list-view ';
    if (item.active) {
      className += 'active ';
    }
    const isFun = typeof this.nodeClass === 'function';
    if (isFun) {
      className += this.nodeClass(item);
    } else {
      className += this.nodeClass || '';
    }
    return className;
  }

  public handleDragStart(item: ITreeNode, e: DragEvent) {
    if (!this.draggable) return;
    e.stopPropagation();
    this.$emit('drag-start', item);
  }

  public handleDragOver(item: ITreeNode, e: DragEvent) {
    if (!this.draggable) return;
    e.stopPropagation();
    this.$emit('drag-over', item, e);
  }

  public handleDrop(item: ITreeNode, e: DragEvent) {
    if (!this.draggable) return;
    e.stopPropagation();
    this.$emit('drop', item);
  }
}
</script>

<style scoped lang="scss">
.tree-list-view {
  position: relative;
  display: flex;
  align-items: center;
  cursor: pointer;
  justify-content: flex-start;
  font-size: 14px;
  color: #111;
  padding-right: 10px;
  .tree-list-content {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    min-width: 50px;
    max-width: calc(100% - 70px);
    text-align: left;
    margin-left: 5px;
  }
  .tree-expand-icon-wrap {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
    .auth-apply-mtdicon-triangle-right {
      color: #c0c4cc;
      font-size: 20px;
    }
    .mtdicon-loading {
      color: #c0c4cc;
      font-size: 16px;
    }
    .expandTransform {
      transition: 0.2s;
      transform-origin: center;
      transform: rotateZ(90deg);
    }
    .expandTransformReturn {
      transition: 0.2s;
      transform-origin: center;
      transform: rotateZ(0deg);
    }
  }
}
.tree-list-view.active {
  background-color: rgb(232, 241, 252);
  color: #1b77ec;
}
.tree-list-view.active:hover {
  background-color: rgb(232, 241, 252);
  color: #1b77ec;
}
.tree-list-view:hover {
  color: #000000;
  background: #e0e0e0;
}
</style>
