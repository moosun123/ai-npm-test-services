<template>
  <div class="tree" ref="scroller" :style="{ height: option.height }" @scroll="handleScroll">
    <div :style="{ height: `${allVisibleHeight}px` }">
      <div :style="{ transform: `translateY(${offset}px)` }">
        <tree-node
          v-for="item in visibleData"
          :key="item[_props_.id]"
          :item="item"
          :props="_props_"
          :option="option"
          :checkable="checkable"
          :load-data="loadData"
          :inheritable="inheritable"
          :treeDisabled="treeDisabled"
          @toggle-expand="toggleExpand"
          @toggle-checked="toggleChecked"
          @toggle-inherit="toggleInherit"
        >
          <!-- 默认插槽 -->
          <template #default="slotProps">
            <slot v-bind:treeNode="slotProps.treeNode"></slot>
          </template>
          <template #treeNodeCenter="slotProps">
            <slot name="treeNodeCenter" v-bind:treeNode="slotProps.treeNode"></slot>
          </template>
          <template #treeNodeRight="slotProps">
            <slot name="treeNodeRight" v-bind:treeNode="slotProps.treeNode"></slot>
          </template>
        </tree-node>
      </div>
    </div>
  </div>
</template>

<script lang="ts">
import { Component, Prop } from 'vue-property-decorator';
import TreeNode from './TreeNode.vue';
import Tree from '../../Tree/Tree.vue';
import { findElders } from '../../Tree/utils';

@Component({
  components: {
    TreeNode
  }
})
export default class TableBaseTree extends Tree {
  @Prop(Boolean)
  public inheritable!: boolean; // 是否展示继承

  public treeNodeCheckedHandler(item: ITreeNode) {
    const { id, checked, indeterminate, disableCheckbox } = this._props_;
    const { flatData } = this;
    const itemIndex = flatData.findIndex(node => node[id] === item[id]);
    // 父子节点选中状态不再关联
    if (this.checkStrictly) {
      this.$set(flatData, itemIndex, {
        ...flatData[itemIndex],
        [checked]: item[checked]
      });
      return;
    }
    // 获取选择项的父辈
    const itemElders = findElders(flatData, item, itemIndex, this._props_).map(node => node[id]);
    // 获取选择项子孙
    for (let i = 0; i < flatData.length; i++) {
      if (i < itemIndex) {
        if (!item[checked] && itemElders.includes(flatData[i][id])) {
          // 取消勾选时，所有的父辈节点的继承都关闭
          this.$set(flatData, i, { ...flatData[i], inherit: false });
        }
      }
      if (i > itemIndex) {
        // 等级比自身相等或者变小了，说明已经找到全部子孙节点
        if (flatData[i].level <= item.level) {
          break;
        }
        if ((item[checked] && !flatData[i][disableCheckbox]) || !item[checked]) {
          this.$set(flatData, i, {
            ...flatData[i],
            [checked]: item[checked],
            [indeterminate]: false,
            // 取消勾选时，关闭继承
            inherit: !item[checked] ? false : flatData[i].inherit
          });
        }
      }
    }
    this.$set(flatData, itemIndex, {
      ...flatData[itemIndex],
      [checked]: item[checked],
      [indeterminate]: false,
      // 取消勾选时，关闭继承
      inherit: !item[checked] ? false : item.inherit
    });
    // 处理父辈节点数据
    this.eldersNodeCheckedHandler(itemElders);
  }

  private toggleInherit(item: ITreeNode) {
    const { flatData } = this;
    const { id, checked, indeterminate, disableCheckbox } = this._props_;
    // 获取子孙节点
    const itemIndex = flatData.findIndex(node => node[id] === item[id]);
    // 获取选择项的父辈
    const itemElders = findElders(flatData, item, itemIndex, this._props_).map(node => node[id]);
    for (let i = 0; i < flatData.length; i++) {
      if (i < itemIndex) {
        // 取消当前选中，会关闭当前节点继承和所有父级节点继承
        if (!item.inherit && itemElders.includes(flatData[i][id])) {
          this.$set(flatData, i, { ...flatData[i], inherit: false });
        }
      }
      if (i === itemIndex) {
        this.$set(flatData, i, { ...flatData[i], inherit: item.inherit });
      }
      if (i > itemIndex) {
        // 等级比自身相等或者变小了，说明已经找到全部子孙节点
        if (flatData[i].level <= item.level) {
          break;
        }
        // 开启继承，则子孙节点全部开启，关闭继承则不改变子孙节点的继承状态
        if (item.inherit && flatData[i].showInherit && !flatData[i].disableInherit && !flatData[i][disableCheckbox]) {
          this.$set(flatData, i, {
            ...flatData[i],
            inherit: item.inherit
          });
        }
      }
    }
    // 继承则选择当前节点
    if (item.inherit && !item[checked]) {
      item[checked] = true;
      item[indeterminate] = false;
      this.toggleChecked(item);
    }
    this.$emit('toggle-inherit', item);
  }

  public getAsyncData(data: ITreeNode[]) {
    const { title, id, checkable, checked, indeterminate, disableCheckbox, disableCheckboxHoverText } = this._props_;
    const { flatData } = this;
    let index = 0;
    flatData.forEach((node, i) => {
      if (this.asyncItem[id] === node[id]) {
        // 为了判断加载完之后，是否展示展开收起按钮
        this.$set(flatData, i, {
          ...flatData[i],
          loading: false,
          hasAsyncChildren: data.length ? 1 : 0
        });
        index = i;
      }
    });
    const arr: ITreeNode[] = [];
    data &&
      data.length &&
      data.forEach((item: ITreeNode) => {
        const itemDisableCheckbox = disableCheckbox in item ? item[disableCheckbox] : false;
        const newItem: ITreeNode = {
          $origin_data: item,
          [title]: title in item ? item[title] : '',
          [id]: id in item ? item[id] : '',
          [checkable]: checkable in item ? item[checkable] : true,
          // 继承父节点勾选状态
          [checked]: itemDisableCheckbox ? false : this.asyncItem[checked],
          [indeterminate]: false,
          [disableCheckbox]: itemDisableCheckbox,
          [disableCheckboxHoverText]: disableCheckboxHoverText in item ? item[disableCheckboxHoverText] : '',
          inherit: this.asyncItem.inherit || item.inherit,
          showInherit: item.showInherit,
          disableInherit: item.disableInherit,
          level: this.asyncItem.level + 1,
          expand: false,
          visible: true,
          pid: this.asyncItem[id],
          childLen: 0
        };
        arr.push(newItem);
      });
    this.$set(flatData, index, {
      ...flatData[index],
      childLen: data.length,
      expand: !!data.length
    });
    flatData.splice(index + 1, 0, ...arr);
    this.updateExpandSyncKeys();
  }
}
</script>

<style scoped lang="scss">
.tree {
  width: 100%;
  overflow: auto;
}
</style>
