<template>
  <div class="df-authApplyModal">
    <AuthApplyModal
      :env="env"
      :btnSize="btnSize"
      :viewModel.sync="viewModal"
      :params="params"
      :modalProps="modalProps"
      @initFail="handleLoadFail"
      :treeDisable="treeDisable"
      @success="handleSuccess"
      @fail="handleFail"
    />
  </div>
</template>
<script lang="ts">
import { Vue, Component, Prop } from 'vue-property-decorator';
import AuthApplyModal from './components/auth-apply-modal/index.vue';
import getReportInstance, { DATA_REPORT_CID } from './utils/dataReport.js';
import scFunction from './utils/scWeb.js';

declare global {
  interface Window {
    DataReportSDK: any;
  }
}

@Component({
  components: {
    AuthApplyModal
  }
})
export default class AuthApplyWrap extends Vue {
  private userId = 0;
  private sc: Function = scFunction;

  @Prop({
    type: Object,
    default: () => {
      return {};
    },
    required: true
  })
  params!: any;

  @Prop({
    required: true,
    type: String,
    default: 'test'
  })
  env!: string;

  @Prop({
    type: Boolean,
    default: false,
    required: true
  })
  value!: boolean;

  @Prop({
    type: String,
    default: 'small'
  })
  btnSize!: string;

  @Prop({
    type: Boolean,
    default: false
  })
  treeDisable!: boolean;

  // 透传给 mtd-modal 的参数
  @Prop({
    type: Object,
    default: () => ({})
  })
  modalProps?: any;

  get viewModal() {
    if (this.value) {
      if (this.userId) {
        const localUid = Number(this.userId);
        window.DataReportSDK['auth-user'].setUid(localUid);
      }
      const { system } = this.params;
      window.DataReportSDK['auth-user'].run(
        'moduleView',
        'b_techportal_vs46qgk5_mv',
        {
          custom: {
            system
          }
        },
        {
          cid: DATA_REPORT_CID
        }
      );
      window.DataReportSDK['auth-user'].run('pageView', null, null, 'c_techportal_pu6o9i4n');
    }
    return this.value;
  }

  set viewModal(val: boolean) {
    this.$emit('input', val);
  }

  handleLoadFail() {
    this.$emit('initFail');
  }

  handleSuccess() {
    this.$emit('status', 'success');
  }

  handleFail() {
    this.$emit('status', 'fail');
  }

  created() {
    getReportInstance(this.env);
    const { env } = this;
    // TODO: 待移除该字段
    let fetchUrl = 'localhost:7070';
    switch (env) {
      case 'development':
        fetchUrl = 'proxy.fe.dev.sankuai.com';
        break;
      case 'test':
        fetchUrl = 'proxy.fe.test.sankuai.com';
        break;
      case 'staging':
        fetchUrl = 'proxy.fe.st.sankuai.com';
        break;
      case 'production':
        fetchUrl = 'proxy-pub.sankuai.com';
        break;
    }
    const sc = scFunction(env);
    sc.fetch({
      url: `https://${fetchUrl}/api/login-status`, // 只填写接口地址，最终SDK会把请求发送到：service-component.sankuai.com/sc-proxy/+你的接口地址
      method: 'GET'
    })
      .then((res: any) => {
        const { data = {} } = res.data;
        const { id = '' } = data;
        this.userId = id;
      })
      .catch((err: any) => {
        console.log('请求错误', err);
      });
  }
}
</script>
