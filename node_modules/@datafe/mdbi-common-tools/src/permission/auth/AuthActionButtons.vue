<template>
  <div class="auth-action-buttons">
    <AuthWrapper
      v-for="(item, index) in tiledList"
      :key="index"
      :options="getOptions(item)"
      @auth-click="handleAuthClick(item)"
    >
      <template #default="scoped">
        <mtd-button
          class="tiled-btn"
          :style="{ 'font-size': fontSize }"
          type="text"
          :loading="scoped.loading"
          :disabled="scoped.disabled"
        >
          {{ item.text }}
        </mtd-button>
      </template>
    </AuthWrapper>
    <mtd-dropdown v-if="moreList.length > 0" class="more-dropdown" popper-class="auth-action-buttons-dropdown">
      <mtd-button type="text" class="more-btn" :style="{ 'font-size': fontSize }">更多</mtd-button>
      <mtd-dropdown-menu slot="dropdown">
        <AuthWrapper
          v-for="(item, index) in moreList"
          :key="index"
          class="more-auth-wrapper"
          :options="getOptions(item)"
          @auth-click="handleAuthClick(item)"
        >
          <template #default="scoped">
            <mtd-dropdown-menu-item @click.native.capture.stop>
              <mtd-button
                type="text"
                class="more-dropdown-item__btn"
                :style="{ 'font-size': fontSize }"
                :loading="scoped.loading"
                :disabled="scoped.disabled"
              >
                {{ item.text }}
              </mtd-button>
            </mtd-dropdown-menu-item>
          </template>
        </AuthWrapper>
      </mtd-dropdown-menu>
    </mtd-dropdown>
  </div>
</template>

<script lang="ts">
import Vue from 'vue'
import { Component, Prop } from 'vue-property-decorator'
import AuthWrapper from './AuthWrapper.vue'

interface Action {
  /** 仅支持actionMap中的值 */
  actionType: string
  id?: string
  subResources?: {
    id: string
  }
  icon?: string
  text?: string
  click: () => void
}

@Component({
  components: {
    AuthWrapper,
  },
})
export default class ActionButtons extends Vue {
  @Prop({
    type: Array,
    default() {
      return []
    },
  })
  actions: Array<Action>

  @Prop({
    type: Object,
    required: true,
  })
  authOptions: {
    id: string
    mis: string
    online?: boolean
    /** 迁移动作专用，目标项目组的ID */
    targetProjectId?: number
    subResources?: {
      id: string
    }
    isMonitorOld?: boolean
  }

  /** 平铺的最大数量，多余的操作项会收拢到更多中 */
  @Prop({
    type: Number,
    default: 2,
  })
  maxTiledCount: number

  @Prop({
    type: String,
    default: '14px',
  })
  fontSize: string

  dropdownVisible = false

  get tiledList() {
    return this.actions.slice(0, this.maxTiledCount)
  }

  get moreList() {
    return this.actions.slice(this.maxTiledCount)
  }

  getOptions(item: Action) {
    return {
      ...this.authOptions,
      action: item.actionType,
      id: item.id || this.authOptions.id,
    }
  }

  handleAuthClick(item: Action) {
    if (item.click) {
      item.click()
    }
  }
}
</script>
<style lang="scss" scoped>
.auth-action-buttons {
  .tiled-btn {
    padding: 0 12px 0 0;
    color: #0a70f5;
  }

  .more-dropdown {
    vertical-align: top;

    .more-btn {
      padding: 0 12px 0 0;
      color: #0a70f5;
    }
  }
}
</style>
<style lang="scss">
.auth-action-buttons-dropdown {
  .more-auth-wrapper {
    display: block !important;

    .wrapper__inner {
      width: 100%;
    }

    .more-dropdown-item__btn {
      width: 100%;
      text-align: left;
      padding: 0;
    }
  }
}
</style>
