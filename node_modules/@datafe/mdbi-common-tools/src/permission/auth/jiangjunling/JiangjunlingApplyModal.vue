<template>
  <AuthApplyDynamic
    v-model="$value"
    :env="env"
    :params="params"
    @input="handleInput"
    @status="handleStatus"
    @initFail="handleInitFail"
  />
</template>

<script lang="ts">
// @ts-ignore
import AuthApplyDynamic from '@mt-material/datafe-auth-apply-dynamic'
import Vue from 'vue'
import { Component, Prop } from 'vue-property-decorator'
import { ApplyStatus, APP_TYPE } from '../constants'
import appTypeMap from './appTypeMap'

Vue.use(AuthApplyDynamic)

@Component
export default class JiangjunlingApplyModal extends Vue {
  @Prop({
    type: String,
    required: true,
  })
  appType: APP_TYPE

  @Prop({
    type: String,
    required: true,
  })
  misId: string

  @Prop({
    type: String,
    required: true,
  })
  id: string

  @Prop({
    type: Boolean,
    default: false,
  })
  isMonitorOld: boolean

  @Prop({
    type: Boolean,
    required: true,
  })
  value: boolean

  get jiangjunlingAppType() {
    return appTypeMap[this.appType] || this.appType
  }

  get env() {
    // st是非大仓项目的取值，在此兼容
    return window.__ENV__ === 'st' ? 'staging' : window.__ENV__
  }

  get params() {
    if (this.isMonitorOld) {
      return {
        system: 'mdbi_monitor', // 系统 code
        resourceCode: [`mdbi_monitor_report_${this.id}`], // 资源根节点 code
        misId: this.misId,
      }
    }

    return {
      system: 'MOSHU', // 系统 code
      resourceCode: [`MOSHU::${this.jiangjunlingAppType}::${this.id}`], // 资源根节点 code
      misId: this.misId,
    }
  }

  get $value() {
    return this.value
  }

  set $value(v: boolean) {
    this.$emit('update:value', v)
  }

  status = ApplyStatus.NO_OPERATE

  handleInput(v: boolean) {
    if (!v) {
      this.emitFinishEvent()
    }
  }
  handleStatus(v: string) {
    this.status = v as ApplyStatus
  }
  handleInitFail() {
    this.status = ApplyStatus.FAIL
    this.emitFinishEvent()
  }
  emitFinishEvent() {
    if (this.status === ApplyStatus.SUCCESS) {
      this.$mtd.message({
        message: '申请已发起，请等待审批通过',
        type: 'success',
      })
    }
    this.$emit('finish', this.status)
  }
}
</script>
<style lang="scss" scoped></style>
