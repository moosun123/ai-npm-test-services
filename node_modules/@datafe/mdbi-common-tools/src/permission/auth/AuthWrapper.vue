<template>
  <div v-show="isShow" class="auth-wrapper">
    <mtd-tooltip
      v-model="tooltipVisible"
      :disabled="tooltipDisabled"
      popper-class="auth-wrapper-popper"
      placement="top"
      @click.native.capture="handleClick"
    >
      <span class="wrapper__inner">
        <slot :loading="isLoading" :disabled="authDisabled"></slot>
        <div v-show="!tooltipDisabled" class="mask"></div>
      </span>
      <template #content>
        <slot name="auth-tooltip-content">
          <span style="white-space: normal" v-html="noPermissionText"></span>
          <mtd-button
            v-if="showResourceApplyBtn"
            v-show="!isLoading"
            class="appy-btn"
            type="text"
            size="small"
            @click="handleApply"
          >
            点击申请
          </mtd-button>
        </slot>
      </template>
    </mtd-tooltip>
    <JiangjunlingApplyModal
      v-if="showApplyModal"
      :appType="appType"
      :misId="options && options.mis"
      :id="options && `${options.id}`"
      :isMonitorOld="options && options.isMonitorOld"
      :value.sync="showApplyModal"
    ></JiangjunlingApplyModal>
  </div>
</template>

<script lang="ts">
import Vue from 'vue'
import { Component, Prop, Watch } from 'vue-property-decorator'
import { constants } from '.'
import authManager, { AuthRes } from './authManager'
import JiangjunlingApplyModal from './jiangjunling/JiangjunlingApplyModal.vue'

enum AuthStatus {
  WAIT,
  LOADING,
  FINISH,
}

export interface Options {
  id: string
  online: boolean
  action: string
  mis: string
  subResources?: {
    id?: string
    extra?: string
  }
  /** 需要什么级别的权限才认为是有权限，默认「部分有权限」，权限类型：无权限、部分有权限、全部有权限 */
  needPermissionType?: PermissionType
  /** 迁移动作专用，目标项目的ID */
  targetProjectId?: number
  /** 鉴权触发方式，默认hover */
  triggerType?: string
  /** 鉴权不通过处理方式，默认tooltip提示 */
  failTreatType?: FailTreatType
  isMonitorOld?: boolean
  /** 默认情况下，当id、action、mis为空时不鉴权，设置此参数为true则不验证参数 */
  noOptionsCheck?: boolean
}

export enum FailTreatType {
  HIDE = 'hide',
  TOOLTIP = 'tooltip',
}

export enum PermissionType {
  NO,
  ALL = 'ALL',
  PART = 'PART',
}

export enum InvalidSlot {
  AUTH_TOOLTIP_CONTENT = 'auth-tooltip-content',
}

export enum NoPermissionType {
  NONE,
  SAFEMETA,
  TABLE,
  RESOURCE,
}

@Component({
  components: {
    JiangjunlingApplyModal,
  },
})
export default class AuthWrapper extends Vue {
  @Prop(Object)
  options: Options

  /** 鉴权不可用，该项为true，则不会触发鉴权，也不会触发auth-click */
  @Prop(Boolean)
  disabled?: boolean

  tooltipVisible = false

  authStatus = AuthStatus.WAIT
  permissionType = PermissionType.ALL

  showApplyModal = false
  noPermissionText = ''
  noPermissionType = NoPermissionType.NONE

  get appType() {
    if (!this.options || !this.options.action) {
      return ''
    }

    const { appType } = authManager.parseAction(this.options.action)

    return appType || ''
  }

  get authDisabled() {
    return !this.hasPermission && this.authStatus !== AuthStatus.WAIT
  }

  get realFailTreatType() {
    return this.options.failTreatType || FailTreatType.TOOLTIP
  }

  get realNeedPermissionType() {
    return this.options.needPermissionType === undefined ? PermissionType.PART : this.options.needPermissionType
  }

  /** 是否有权限 */
  get hasPermission() {
    // 实际需要的权限是部分权限，则全部、部分都认为有权限，否则只有全部有权限才认为有权限
    return this.realNeedPermissionType === PermissionType.PART
      ? [PermissionType.PART, PermissionType.ALL].includes(this.permissionType)
      : this.permissionType === PermissionType.ALL
  }

  get isLoading() {
    return this.authStatus === AuthStatus.LOADING
  }

  get tooltipDisabled() {
    return this.authStatus !== AuthStatus.FINISH || this.hasPermission
  }

  get isShow() {
    if (this.realFailTreatType === FailTreatType.TOOLTIP) {
      return true
    }

    // 如果还在验证中，则先隐藏
    if (this.authStatus !== AuthStatus.FINISH) {
      return false
    }

    return this.hasPermission
  }

  get showResourceApplyBtn() {
    return this.noPermissionType === NoPermissionType.RESOURCE
  }

  /** 基于动作判断，是否可申请资源权限 */
  get isAuthManageAction() {
    const { actionMap } = constants
    const authManageList: string[] = [
      actionMap.DASHBOARD.APP.AUTH_MANAGE,
      actionMap.SQL.APP.AUTH_MANAGE,
      actionMap.WORMHOLE.APP.AUTH_MANAGE,
      actionMap.MONITOR.APP.AUTH_MANAGE,
      actionMap.PORTAL.APP.AUTH_MANAGE
    ]
    return authManageList.includes(this.options.action)
  }

  /** 参数变化重置所有鉴权状态 */
  @Watch('options', { immediate: true })
  onOptionsChange() {
    this.reset()
  }

  reset() {
    this.authStatus = AuthStatus.WAIT
    this.permissionType = PermissionType.ALL
  }

  async auth() {
    try {
      this.authStatus = AuthStatus.LOADING
      this.permissionType = PermissionType.NO
      const res = await authManager.singleAuth(this.options.mis, this.options)
      this.resolveAuthRes(res)
      this.authStatus = AuthStatus.FINISH
      if (!this.hasPermission) {
        this.tooltipVisible = true
      }
      this.emitAuthClickEvent()
    } catch (error) {
      this.reset()
      throw error
    }
  }

  async handleApply() {
    this.showApplyModal = true
  }

  async handleClick() {
    if (this.disabled) {
      return
    }

    if (this.isLoading || !this.hasPermission) {
      return
    }

    // 鉴权参数不合法，则认为有权限，直接抛出事件
    if (!this.optionsIsValid()) {
      this.permissionType = PermissionType.ALL
      this.emitAuthClickEvent()
      return
    }

    this.auth()
  }

  emitAuthClickEvent() {
    if (this.hasPermission) {
      this.$emit('auth-click')
    }
  }

  optionsIsValid() {
    if (this.options.noOptionsCheck) {
      return true
    }

    const { id, action, mis } = this.options
    return id && action && mis
  }

  resolveAuthResItem(res: AuthRes): {
    permissionType: PermissionType
    noPermissionType: NoPermissionType
    noPermissionText: string
  } | null {
    // 鉴权结果是个树结构，如果根节点有权限，则判断子节点是否有权限
    if (res.hasPermission) {
      const childResList = (res.subAuthResults || [])
      for (let childRes of childResList) {
        const resolvedInfoOfChild = this.resolveAuthResItem(childRes)
        if (resolvedInfoOfChild) {
          return resolvedInfoOfChild
        }
      }
      // 如果子节点都有权限，则返回null
      return null
    }

    // 如果当前节点无权限，则构建无权限对象
    const permissionType = PermissionType.NO
    let noPermissionType = NoPermissionType.NONE
    const noPermissionTextList: string[] = []
    if (res?.safeMetaResult && res?.safeMetaResult.invalid) {
      noPermissionType = NoPermissionType.SAFEMETA
      noPermissionTextList.push(
        '当前资源使用了安全底表，请登录金融堡垒机操作（<a href="https://km.sankuai.com/page/143144616" target="_blank">堡垒机使用第一篇</a>）',
      )
    } else if (res?.tableAuthResults && res.tableAuthResults.length > 0) {
      noPermissionType = NoPermissionType.TABLE
      noPermissionTextList.push('无以下库表权限，请申请：')
      noPermissionTextList.push(
        ...res.tableAuthResults.map((item) => {
          return `${item.db}.${item.table} ${item.url}`
        }),
      )
    } else if (res.authCode && !this.isAuthManageAction) {
      noPermissionType = NoPermissionType.RESOURCE
      noPermissionTextList.push('无该资源的操作权限')
    } else {
      noPermissionType = NoPermissionType.NONE
      noPermissionTextList.push('无该资源的操作权限')
    }

    return {
      permissionType,
      noPermissionType,
      noPermissionText: noPermissionTextList.join('<br>')
    }
  }

  resolveAuthRes(res: AuthRes) {
    const resolvedInfo = this.resolveAuthResItem(res)

    if (!resolvedInfo) {
      this.permissionType = (res.permissionType || PermissionType.ALL) as PermissionType
      this.noPermissionType = NoPermissionType.NONE
      return
    }

    this.permissionType = resolvedInfo.permissionType
    this.noPermissionType = resolvedInfo.noPermissionType
    this.noPermissionText = resolvedInfo.noPermissionText
  }
}
</script>
<style lang="scss" scoped>
.auth-wrapper {
  display: inline-block;
  position: relative;
  font-size: 0;

  .wrapper__inner {
    display: inline-block;
    font-size: 14px;
  }

  .mask {
    position: absolute;
    inset: 0;
    opacity: 0;
  }
}
</style>
<style lang="scss">
.auth-wrapper-popper {
  .appy-btn {
    color: #fff;
    text-decoration: underline;

    &:hover {
      color: #0a70f5;
    }
  }
  white-space: nowrap;
}
</style>
