import { ErrorMessage, ErrorConfig } from './types'

export default class Base {
  public metricInst: any
  public owl: any
  public owlVersion: string

  constructor() {
    this.owl = window.Owl || window.owl
    this.owlVersion = this.getOwlVersion()
    this.metricInst = this.getMetricInst()
  }
  // 1.8.x & 1.9.x 版本与1.10.x以上版本
  private getOwlVersion() {
    const { owl } = this
    if (!owl) {
      return ''
    }
    const owlVersion = owl.__version__ || ''
    return owlVersion
  }

  private getMetricInst() {
    const { owl, owlVersion } = this
    if (!owl) {
      return null
    }

    const owlVersionSplit = owlVersion.split('.')

    // 1.8.x & 1.9.x 版本与1.10.x以上版本获取实例方式不同
    if (Number(owlVersionSplit[1]) >= 10) {
      return owl('newMetricInst')
    }

    return owl.MetricManager()
  }
  // 手动上报异常信息
  public addError(message: ErrorMessage | string | Error, config?: ErrorConfig) {
    try {
      const { owl, owlVersion } = this
      if (!owl) {
        console.error('手动上报异常失败：建议检查Owl版本')
        return
      }
      const owlVersionSplit = owlVersion.split('.')
      if (Number(owlVersionSplit[1]) >= 10) {
        owl('addError', message, config)
      }
      owl.addError(message, config)
    } catch (err) {
      console.error(err)
    }
  }
}
