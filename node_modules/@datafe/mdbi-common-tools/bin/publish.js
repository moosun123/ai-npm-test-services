#!/usr/bin/env node

const { exec } = require('child_process')
const colors = require('colors-console')

exec('git rev-parse --abbrev-ref HEAD', (_, stdout) => {
  const basic = stdout.substr(0, stdout.length - 1)
  if (basic === 'master') {
    console.log(colors('green', '验证通过: The branch is master'))
    console.log(colors('green', '开始执行yarn build'))
    exec('yarn build', (error) => {
      if (error) {
        console.log(colors('red', 'error: ' + error))
        return
      }
      console.log(colors('green', '开始执行：npm publish --registry="http://r.npm.sankuai.com"'))
      exec('npm publish --registry="http://r.npm.sankuai.com"', (error) => {
        if (error) {
          console.log(colors('red', 'error: ' + error))
          return
        }
      })
    })
  } else {
    console.log(colors('red', '发布失败：发布分支必须为master分支'))
    return false
  }
})
