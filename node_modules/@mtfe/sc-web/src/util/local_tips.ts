/**
 * Created by dongchunhai on 2/5/21.
 */
import tips from "./tips";

export function localHostTips({loginUrl, loginOrigin}) {
  const timestamp = +new Date();
  return new Promise((resolve, reject) => {
    const { destroy } = tips(
      '您的登录状态已失效，点击本消息完成登录，以正常使用服务',
      () => {
        window.open(`${loginUrl}?openerOrigin=${location.origin}&timestamp=${timestamp}`, '_blank');
        window.addEventListener("message", (event: any) => {
          // 拦截非法操作和非本次操作
          const origin = event.origin || event.originalEvent.origin;
          if (origin != loginOrigin || event.data.timestamp != timestamp) return;
          if (event.data.code === 200) {
            resolve(event);
            destroy();
          } else {
            console.error('登陆sc失败，请检查登录窗口是否被浏览器拦截');
            reject();
          }
        })
      }
    );
    // const tips1 = `您的登录状态失效，点击【确定】完成登录`;
    // // const tips2 = `了解原因：https://km.sankuai.com/page/623706367 \n`;
    // if (window.confirm(tips1)) {
    //   window.open(`${loginUrl}?openerOrigin=${location.origin}&timestamp=${timestamp}`, '_blank');
    //   window.addEventListener("message", (event: any) => {
    //     // 拦截非法操作和非本次操作
    //     const origin = event.origin || event.originalEvent.origin;
    //     if (origin != loginOrigin || event.data.timestamp != timestamp) return;
    //     if (event.data.code === 200) {
    //       resolve(event);
    //     } else {
    //       console.error('登陆sc失败，请检查登录窗口是否被浏览器拦截');
    //       reject();
    //     }
    //   })
    // }
  });
}
