<template>
    <div
        :class="{
            [prefix]: true,
            [`${prefix}-prefix`]: hasPrefix,
            [`${prefix}-suffix`]: hasSuffix,
            [`${prefix}-disabled`]: disabled,
            [`${prefix}-readonly`]: readonly,
            [`${prefix}-invalid`]: invalid,
            [`${prefix}-${size}`]: !!size,
            [`${prefix}-${genre}`]: !!genre,
            focus: focused,
        }"
        tabindex="0"
        @click="handleClick"
        @mouseenter="hovering = true"
        @mouseleave="hovering = false"
    >
        <span :class="`${prefix}-prefix-inner`" v-if="hasPrefix">
            <slot name="prefix">
                <i :class="prefixIcon" @click="handlePrefixClick" />
            </slot>
        </span>
        <div :class="[`${prefix}-rendered`, `${localPrefix}-rendered`]">
            <div :class="`${prefix}-placeholder`" v-show="!tags.length && !inputValue">{{ placeholder }}</div>
            <mtd-tag
                v-for="(val, $index) in tags"
                :key="$index"
                :closable="closable"
                :size="size"
                theme=""
                @close="remove($index)"
                @click="handleTagClick"
                >{{ val }}</mtd-tag
            >
            <!-- 此处借鉴mtd-select collapse-tags功能进行改写 -->
            <mtd-tooltip placement="top" theme="light">
                <ul slot="content" :class="`${localPrefix}-tags-ul`">
                    <li
                        :class="`${localPrefix}-tags-li`"
                        v-for="(item, index) in value"
                        :key="index"
                    >
                        <mtd-tag
                            theme=""
                            :size="size"
                            :closable="closable"
                            @close="remove(index)"
                            >{{ item }}</mtd-tag
                        >
                    </li>
                </ul>
                <mtd-tag
                    v-show="omittedValues.length"
                    :size="size"
                    :class="`${localPrefix}-collapse-tags`"
                    theme=""
                    @click="handleTagClick"
                >
                    <slot :omitted-values="omittedValues"
                        >共选&nbsp;{{ value.length }}&nbsp;项</slot
                    >
                </mtd-tag>
            </mtd-tooltip>
            <div v-if="!readonly" :class="`${prefix}-field-wrap`">
                <input
                    type="text"
                    :class="`${prefix}-field`"
                    :value="inputValue"
                    v-on="inputListeners"
                    ref="input"
                />
                <span :class="`${prefix}-field-mirror`" ref="mirror">{{ inputValue }}</span>
            </div>
        </div>
        <span :class="`${prefix}-suffix-inner`" v-if="hasSuffix">
            <Icon v-if="loading" name="loading" />
            <Icon
                :class="`${prefix}-clear`"
                name="error-circle"
                @click.stop="handleClearClick"
                v-else-if="showClear"
            />
            <slot name="suffix" v-else>
                <i :class="suffixIcon" @click="handleSuffixClick" />
            </slot>
        </span>
    </div>
</template>
<script>
import MtdTag from '@components/tag';
import Icon from '@components/icon';
import { CONFIG_PROVIDER, getPrefixCls } from '../../utils/config';

export default {
    name: 'MpaMultipleInput',
    components: {
        MtdTag,
        Icon,
    },
    inheritAttrs: false,
    props: {
        placeholder: String,
        value: {
            type: [Array],
            required: true,
            default() {
                return [];
            },
        },
        inputValue: String,
        closable: Boolean,
        disabled: Boolean,
        readonly: Boolean,
        maxTagCount: Number,
        clearable: Boolean,
        loading: Boolean,
        prefixIcon: String,
        suffixIcon: String,

        invalid: Boolean,
        genre: String,
        size: String,
        focused: Boolean,
    },
    data() {
        return {
            hovering: false,
        };
    },
    inject: {
        config: {
            from: CONFIG_PROVIDER,
            default: {
                getPrefixCls,
            },
        },
    },
    computed: {
        prefix() {
            return this.config.getPrefixCls('multiple-input');
        },
        localPrefix() {
            return this.config.getPrefixCls('', 'mpa-multiple-input');
        },
        hasPrefix() {
            return !!(this.prefixIcon || this.$slots.prefix);
        },
        hasSuffix() {
            return this.loading || this.clearable || !!(this.suffixIcon || this.$slots.suffix);
        },
        hasValue() {
            return !!(this.value && this.value.length);
        },
        tags() {
            if (this.maxTagCount && this.maxTagCount < this.value.length) {
                return this.value.slice(0, this.maxTagCount);
            }
            return this.value;
        },
        omittedValues() {
            const omittedLength = this.tags.length - this.value.length;
            if (omittedLength) {
                return this.value.slice(omittedLength);
            }
            return [];
        },
        showClear() {
            return this.clearable && !this.disabled && this.hasValue && this.hovering;
        },
        inputListeners() {
            const listeners = { ...this.$listeners, input: this.handleInput };
            delete listeners.click;
            delete listeners.focus;
            return listeners;
        },
    },
    watch: {
        inputValue() {
            this.$nextTick(this.syncMirrorWidth);
        },
    },
    methods: {
        syncMirrorWidth() {
            const { mirror, input } = this.$refs;
            const width = mirror.clientWidth;
            input.style.width = width ? `${width}px` : '';
        },

        remove(index) {
            const values = [...this.value];
            const removedValue = values[index];
            values.splice(index, 1);
            this.$emit('remove', removedValue, index);
            this.$emit('input', values);
        },

        handleTagClick(e) {
            e.preventDefault();
        },

        handleFocus(e) {
            if (this.$refs.input) {
                this.$refs.input.focus();
                if (!this.focused) {
                    this.$emit('focus', e);
                }
            }
        },
        handleInput(e) {
            const inputValue = e.target.value;
            this.$emit('update:inputValue', inputValue);
        },
        handleClearClick(e) {
            this.$emit('clear');
            this.$emit('input', []);
        },

        handlePrefixClick(e) {
            this.$emit('click-prefix', e);
        },

        handleSuffixClick(e) {
            this.focus();
            this.$emit('click-suffix', e);
        },

        handleClick(e) {
            this.handleFocus(e);
            this.$emit('click', e);
        },

        focus() {
            this.$refs.input && this.$refs.input.focus();
        },

        blur() {
            this.$refs.input && this.$refs.input.blur();
        },
    },
};
</script>
