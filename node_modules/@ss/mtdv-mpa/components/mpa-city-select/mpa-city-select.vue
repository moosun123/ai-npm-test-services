<template>
    <Popper
        tag="div"
        trigger="click"
        ref="popper"
        :visible="localVisible"
        :placement="placement"
        :toggle-on-reference-click="false"
        :append-to-container="appendToBody"
        @update:visible="handleVisibleChange"
        @clickoutside="handleClickOutside"
    >
        <!-- 外置型category选项卡插槽 -->
        <template v-if="showOutsideCategory"
            ><slot name="category">
                <mtd-radio-group
                    style="margin-right: 12px"
                    v-model="activeCategory"
                    @input="handleCategoryChange"
                >
                    <mtd-radio-button
                        v-for="item in localCategoryData"
                        :key="item.value"
                        :value="item.value"
                        >{{ item.label }}</mtd-radio-button
                    >
                </mtd-radio-group>
            </slot></template
        >
        <Reference>
            <MpaMultipleInput
                v-if="multiple"
                ref="multipleInput"
                :class="[multiple ? prefix + '-input-multiple' : '']"
                :value="multipleInputValue"
                :readonly="true"
                :clearable="clearable"
                :suffix-icon="suffixIcon"
                :placeholder="placeholder"
                :closable="true"
                :max-tag-count="1"
                @remove="handleTagRemove"
                @clear="handleClear"
            ></MpaMultipleInput>
            <MtdInput
                v-else
                ref="input"
                clearable-on-readonly
                :class="[prefix + '-input', isAreaStyle ? prefix + '-input-area' : '']"
                :value="singleInputValue"
                :placeholder="placeholder"
                :clearable="clearable"
                :prefix-icon="prefixIcon"
                :suffix-icon="suffixIcon"
                :genre="genre"
                :readonly="true"
                @clear="handleClear"
            />
        </Reference>
        <Drop :class="[popperClass, prefix + '-popper']" :use-show="false">
            <PopperDropContent
                ref="dropContent"
                v-bind="$props"
                :data="localCityData"
                :category-data="localCategoryData"
                :select-any-level="localSelectAnyLevel"
                :data-source-type="activeCategory"
                @search="handleSearch"
                @category-change="handleCategoryChange"
                @clear="handleClear"
                @cancel="handleCancel"
                @confirm="handleConfirm"
            >
                <!-- 向子组件传递插槽 -->
                <template v-slot:recentView>
                    <slot name="recentView"></slot>
                </template>
            </PopperDropContent>
        </Drop>
    </Popper>
</template>
<script lang="ts">
import { Vue, Component, Prop, Watch, Provide, Ref } from 'vue-property-decorator';
import { Popper, Drop, Reference } from '../popper';
import { getPrefixCls, getIconCls } from '../../utils/config';
import { DEFAULT_FIELD_NAMES } from './constants';
import MtdInput from '@components/input';
import MpaMultipleInput from '@components/mpa-multiple-input';
import PopperDropContent from './components/PopperDropContent.vue';
import {
    ICustomOptionItem,
    SelectedValueList,
    ICustomDataProps,
    SelectedValueItem,
    IFullDataInfo,
    DataSourceType,
    CategoryPositionType,
} from './types';

import {
    filterSearchTree,
    treeToMatrix,
    getTreeByPath,
    getDataByLetter,
    isValueNode,
    getCityByLetter,
    getProvinceByLetter,
} from './utils';

// 兜底数据
import fullData from './data/fullData';
const computedData: IFullDataInfo = getDataByLetter(fullData);

@Component({
    components: {
        Popper,
        Drop,
        Reference,
        MtdInput,
        MpaMultipleInput,
        PopperDropContent,
    },
})
export default class MpaCitySelect extends Vue {
    @Prop({
        type: Array,
        required: false,
        default: () => [],
    })
    value!: SelectedValueList; // 已选中的城市列表values

    @Prop({
        type: Boolean,
        required: false,
        default: false,
    })
    visible!: boolean; // 是否显示城市选择器下拉面板

    @Prop({
        type: Array,
        required: false,
        default: () => [],
    })
    data!: ICustomOptionItem[]; // 自定义城市数据

    @Prop({
        type: Boolean,
        required: false,
        default: true,
    })
    useDefaultData!: boolean; // 是否使用默认城市数据

    @Prop({
        type: Boolean,
        required: false,
        default: true,
    })
    showSelectAll!: boolean; // 是否显示全选按钮

    @Prop({
        type: Object,
        required: false,
        default: () => DEFAULT_FIELD_NAMES,
    })
    dataProps!: ICustomDataProps; // 自定义城市数据的字段名

    @Prop({
        type: String,
        required: false,
        default: 'regions',
    })
    dataSourceType!: DataSourceType; // 城市数据源类型

    @Prop({
        type: Number,
        required: false,
        default: 2,
    })
    leafLevel!: number; // 城市数据的叶子节点层级

    @Prop({
        type: String,
        required: false,
        default: '',
    })
    genre!: string; // 输入框类型，参考mtd-input中genre属性

    @Prop({
        type: Boolean,
        required: false,
        default: false,
    })
    selectAnyLevel!: boolean; // 是否可以选择任意层级的城市

    @Prop({
        type: Boolean,
        required: false,
        default: false,
    })
    clearable!: boolean; // 是否可清空已选中的城市

    @Prop({
        type: Boolean,
        required: false,
        default: false,
    })
    multiple!: boolean; // 是否支持多选

    @Prop({
        type: String,
        required: false,
        default: '选择城市',
    })
    placeholder!: string; // 输入框的占位符

    @Prop({
        type: Function,
        required: false,
    })
    formatter!: (
        labels: SelectedValueList,
        data: ICustomOptionItem,
        val: SelectedValueList,
    ) => string; // 格式化已选中的城市

    @Prop({
        type: String,
        required: false,
        default: '/',
    })
    separator!: string; // 已选中城市的分隔符

    @Prop({
        type: Boolean,
        required: false,
        default: true,
    })
    displayCategory!: boolean; // 是否显示分类选项卡

    @Prop({
        type: String,
        required: false,
        default: 'inside',
    })
    categoryPosition!: CategoryPositionType; // 分类选项卡的位置

    @Prop({
        type: Array,
        required: false,
        default: () => [
            { label: '按行政区', value: 'regions' },
            { label: '按音序', value: 'sequence' },
        ],
    })
    categoryData!: ICustomOptionItem[]; // 分类选项卡的数据

    @Prop({
        type: Boolean,
        required: false,
        default: false,
    })
    loading!: boolean; // 是否正在加载城市数据

    @Prop({
        type: String,
        required: false,
        default: '加载中',
    })
    loadingText!: string; // 加载中的文本

    @Prop({
        type: String,
        required: false,
        default: '搜索省份/城市',
    })
    searchText!: string; // 搜索框的占位符

    @Prop({
        type: Boolean,
        required: false,
        default: false,
    })
    appendToBody!: boolean; // 是否将弹出层插入到 body 中

    @Prop({
        type: String,
        required: false,
        default: '',
    })
    popperClass!: string; // 弹出层的 class

    @Prop({
        type: String,
        required: false,
        default: 'bottom-start',
    })
    placement!: string; // 弹出层的位置

    @Prop({
        type: Boolean,
        required: false,
        default: false,
    })
    blurAutoSave!: boolean; // 是否在失焦时自动保存已选中的城市

    @Ref('dropContent') dropContentCom!: InstanceType<typeof PopperDropContent>;

    @Ref('multipleInput') multipleInputCom!: InstanceType<typeof MpaMultipleInput>;

    @Ref('input') inputCom!: InstanceType<typeof MtdInput>;

    @Provide('prefix')
    private commonPrefix = this.prefix;

    @Provide('handleSelectSingleNode')
    private selectedSingle = this.handleSelectSingleNode;

    @Provide('handleSelectMultipleNodes')
    private selectedMultiple = this.handleSelectMultipleNodes;

    @Provide('clearOtherSelectedStatus')
    private clearSelectedAll = this.clearOtherSelectedStatus;

    @Provide('updateCountryDataState')
    private updateCountryData = this.updateCountryDataState;

    private countryData: ICustomOptionItem = {
        label: '全国',
        value: '全国',
        cityCode: '100000',
        active: false,
        indeterminate: false,
    };

    @Provide('countryData')
    private localCountryData = this.countryData;

    private defaultDataMpas: Record<string, ICustomOptionItem[]> = {
        regions: computedData.provinceList,
        sequence: computedData.cityList,
    };

    private localCityData: ICustomOptionItem[] = [];

    private localVisible: boolean = false;

    private activeCategory: string = '';

    private singleInputValue: string = '';

    private multipleInputValue: string[] = [];

    // 当前选中值
    private selectedValueList: SelectedValueList = [];

    // 上一次点击确定按钮后的选中值
    private prevSelectedValues: SelectedValueList = [];

    private inputValue: string = '';

    // 默认数据
    private get defaultCityData() {
        const { defaultDataMpas, activeCategory } = this;
        return defaultDataMpas[activeCategory];
    }

    // 原始数据副本
    private get originData() {
        const { data, useDefaultData, defaultCityData } = this;
        return JSON.parse(JSON.stringify(useDefaultData ? defaultCityData : data));
    }

    // 自定义field
    private get fieldNames(): ICustomDataProps {
        return {
            ...DEFAULT_FIELD_NAMES,
            ...this.dataProps,
        };
    }

    // 音序场景或默认场景下，禁用选择任一级的能力（数据处理时，选中值不合并）
    private get disableSelectAnyLevel() {
        const { activeCategory, useDefaultData } = this;
        return activeCategory === 'sequence' || useDefaultData;
    }

    private get localSelectAnyLevel() {
        const { disableSelectAnyLevel, selectAnyLevel } = this;
        return disableSelectAnyLevel ? false : selectAnyLevel;
    }

    // 是否显示外置型类别选项卡
    private get showOutsideCategory() {
        const { displayCategory, categoryPosition } = this;
        return displayCategory && categoryPosition === 'outside';
    }

    // input输入框类型
    private get isAreaStyle() {
        return this.genre === 'area';
    }

    // 组件class公共前缀
    private get prefix() {
        return getPrefixCls('', 'mpa-city-select');
    }

    // input组件前置icon
    private get prefixIcon() {
        return this.isAreaStyle ? getIconCls('floor', '') : '';
    }

    // input组件后置icon
    private get suffixIcon() {
        return this.isAreaStyle ? getIconCls('down-thick', '') : getIconCls('floor', '');
    }

    // 类别选项卡数据源
    private get localCategoryData() {
        const { categoryData, activeCategory } = this;
        return (categoryData || []).map((item: ICustomOptionItem) => ({
            ...item,
            active: item.value === activeCategory,
        }));
    }

    // 选中值分隔符
    private get separatorFormatter() {
        return ` ${this.separator} `;
    }

    // 所有选中节点信息
    private get allSelectedNodes() {
        const { localCityData, multiple, disableSelectAnyLevel } = this;
        return filterSearchTree(
            localCityData,
            (node: ICustomOptionItem) => !!node.active || !!node.indeterminate,
            multiple ? (node: ICustomOptionItem) => !!node.active : () => false,
            disableSelectAnyLevel,
        );
    }

    // 所有选中节点的选中值
    private get allSelectedValues() {
        return treeToMatrix(this.allSelectedNodes, 'value');
    }

    // 所有选中节点的文字显示
    private get allSelectedLabels() {
        return treeToMatrix(this.allSelectedNodes, 'label');
    }

    // 城市列表数据添加音序
    private get needCityLetter() {
        return this.dataSourceType === 'sequence';
    }

    // 省份-城市列表数据添加音序
    private get needProvinceLetter() {
        const { dataSourceType, leafLevel } = this;
        return dataSourceType === 'regions' && leafLevel === 2;
    }

    // 全国选中状态
    private get computedCountryStatus() {
        const { localCityData } = this;
        const allSelected: boolean = localCityData.every(
            (child: ICustomOptionItem) => child.active,
        );
        const noneSelected: boolean = localCityData.every(
            (child: ICustomOptionItem) => !child.active,
        );
        const hasSelected: boolean = localCityData.some(
            (child: ICustomOptionItem) => child.indeterminate,
        );
        const selectedLength: number = localCityData.filter(
            (child: ICustomOptionItem) => child.active,
        ).length;
        const someSelected: boolean = selectedLength > 0 && selectedLength < localCityData.length;
        return {
            active: allSelected,
            indeterminate: (!allSelected && !noneSelected) || hasSelected || someSelected,
        };
    }

    // 是否选中全国
    private get isCountrySelected() {
        return this.showSelectAll && this.countryData.active;
    }

    // 组件获得焦点
    public focus() {
        this.handleFocusOrBlur(true);
    }

    // 组件失去焦点
    public blur() {
        this.handleFocusOrBlur();
    }

    private handleFocusOrBlur(focus: boolean = false) {
        const { multiple, multipleInputCom, inputCom } = this;
        const inputElem = multiple ? multipleInputCom : inputCom;
        if (inputElem) {
            if (focus) {
                inputElem.focus();
            } else {
                inputElem.blur();
            }
            this.handleVisibleChange(focus);
        }
    }

    // 外部传参中的选中值变化
    @Watch('value', {
        immediate: true,
    })
    private handleValueChange(newVal: SelectedValueList) {
        this.prevSelectedValues = newVal;
        if (newVal && newVal.length) {
            // 重置全国选中状态
            this.updateCountryDataState();

            // 当前数据结构是否是平铺形式
            const isFlattened: boolean = this.localCityData.some((item: ICustomOptionItem) =>
                isValueNode(item.value),
            );
            this.$nextTick(() => {
                newVal.forEach((value: SelectedValueItem) => {
                    const { result, matched } = getTreeByPath(
                        this.localCityData,
                        isFlattened ? [value.slice(-1)[0]] : value,
                    );
                    // 回显值包含全国
                    if (value.includes(this.countryData.label)) {
                        // this.refreshAfterCancel(true)
                        this.updateCountryDataState(true, false);
                        this.clearOtherSelectedStatus(this.countryData.label);
                    } else if (matched) {
                        // 更新列表状态
                        const node: ICustomOptionItem = result.slice(-1)[0];
                        node.active = true;
                        node.indeterminate = false;
                        if (this.multiple) {
                            this.handleSelectMultipleNodes(node);
                        } else {
                            this.handleSelectSingleNode(node);
                        }
                    }
                });
            });
        } else {
            // 清空选中值
            this.updateInputValue(true);
            this.updateCountryDataState();
            this.updateSearchText();
            this.$nextTick(() => {
                this.resetRenderData();
            });
        }
    }

    // 数据源变化
    @Watch('data', {
        immediate: true,
    })
    private handleCityDataChange(newData: ICustomOptionItem[]) {
        if (newData) {
            newData = this.getTransferData(newData);
            if (this.needCityLetter) {
                newData = getCityByLetter(newData.map(this.getComputedNode));
            } else if (this.needProvinceLetter) {
                newData = getProvinceByLetter(newData.map(this.getComputedNode));
            } else {
                newData = newData.map(this.getComputedNode);
            }
            this.localCityData = newData;
        }
    }

    // 更新数据源
    private updateLocalCityData(data: ICustomOptionItem[] = this.originData) {
        this.localCityData = this.getTransferData(data).map(this.getComputedNode);
    }

    // 构造列表数据结构
    private getComputedNode(node: ICustomOptionItem) {
        node.active = false;
        node.expand = false;
        node.highlight = false;
        node.hidden = false;
        if (this.multiple) {
            node.indeterminate = false;
        }
        let { children } = node;
        if (children && children.length) {
            children = children.map(this.getComputedNode);
        }
        return node;
    }

    // 移除标签
    private handleTagRemove(tag: string, index: number) {
        if (this.isCountrySelected) {
            this.multipleInputValue = [];
            this.updateCountryDataState();
            return;
        }
        this.multipleInputValue.splice(index, 1);
        // 当前数据结构是否是平铺形式
        const isFlattened: boolean = this.localCityData.some((item: ICustomOptionItem) =>
            isValueNode(item.value),
        );

        // 查找被删除tag对应的节点
        const values: SelectedValueItem = this.selectedValueList[index];
        this.selectedValueList.splice(index, 1);
        const { result, matched } = getTreeByPath(
            this.localCityData,
            isFlattened ? [values.slice(-1)[0]] : values,
        );
        if (matched) {
            // 更新列表状态
            const node: ICustomOptionItem = result.slice(-1)[0];
            node.active = false;
            node.indeterminate = false;
            this.handleSelectMultipleNodes(node, true);
            this.handleSelectedChange();
        }
    }

    // 多选-更新子节点状态
    private updateChildrenStatus(node: ICustomOptionItem, active = node.active) {
        const { children } = node;
        if (children && children.length) {
            children.forEach((child: ICustomOptionItem) => {
                if (!child.disabled) {
                    child.active = active;
                    child.indeterminate = false;
                    this.updateChildrenStatus(child, active);
                }
            });
        }
    }

    // 多选-更新节点自身状态
    private updateSelfStatus(node: ICustomOptionItem) {
        let { children } = node;
        if (children && children.length) {
            // 过滤无法选中的节点
            const newChildren = children.filter((child: ICustomOptionItem) => !child.disabled);
            children = newChildren.length === 0 ? children : newChildren;

            const allSelected: boolean = children.every((child: ICustomOptionItem) => child.active);
            const noneSelected: boolean = children.every(
                (child: ICustomOptionItem) => !child.active,
            );
            const hasSelected: boolean = children.some(
                (child: ICustomOptionItem) => child.indeterminate,
            );
            node.active = allSelected;
            node.indeterminate = (!allSelected && !noneSelected) || hasSelected;
        }
    }

    // 多选-更新状态
    private updateMultipleNodesStatus(
        target: ICustomOptionItem,
        node: ICustomOptionItem,
        parent?: ICustomOptionItem,
        ancestor?: ICustomOptionItem,
    ) {
        if (node.value === target.value) {
            if (target.indeterminate) {
                target.active = true;
            }
            target.indeterminate = false;
            this.updateChildrenStatus(node);
            if (parent) {
                this.updateSelfStatus(parent);
            }
            if (ancestor) {
                this.updateSelfStatus(ancestor);
            }
        } else {
            const { children } = node;
            if (children && children.length) {
                children.forEach((child: ICustomOptionItem) => {
                    this.updateMultipleNodesStatus(target, child, node, parent);
                });
            }
        }
    }

    // 多选
    private handleSelectMultipleNodes(target: ICustomOptionItem, isRemove: boolean = false) {
        this.localCityData.forEach((node: ICustomOptionItem) => {
            this.updateMultipleNodesStatus(target, node);
        });

        // 更新全国选项状态
        this.toggleCountryStatus();
        if (this.countryData.active) {
            this.clearOtherSelectedStatus(this.countryData.label);
        }

        if (!isRemove) {
            this.updateInputValue();
        }
    }

    // 单选-更新节点选中状态
    private updateSingleNodeStatus(parent: ICustomOptionItem, target: ICustomOptionItem) {
        parent.active = false;
        if (parent.value === target.value) {
            parent.active = true;
        }
        const { children } = parent;
        if (children && children.length) {
            children.forEach((child: ICustomOptionItem) => {
                this.updateSingleNodeStatus(child, target);
            });
            if (children.some((child: ICustomOptionItem) => child.active)) {
                parent.active = true;
            }
        }
    }

    // 单选
    private handleSelectSingleNode(target: ICustomOptionItem) {
        this.localCityData.forEach((node: ICustomOptionItem) => {
            this.updateSingleNodeStatus(node, target);
        });
        this.updateInputValue();
    }

    // 更新选中值
    private updateSelectedValues(values: SelectedValueList) {
        this.selectedValueList = values;
    }

    // 更新input显示值
    private updateInputValue(clear: boolean = false) {
        this.singleInputValue = '';
        this.multipleInputValue = [];
        this.updateSelectedValues(clear ? [] : this.allSelectedValues);
        if (!clear) {
            const labels: SelectedValueList = this.allSelectedLabels;
            if (this.multiple) {
                if (this.isCountrySelected) {
                    this.multipleInputValue = [this.countryData.label];
                } else {
                    labels.forEach((node: SelectedValueItem) => {
                        this.multipleInputValue.push(node.join(this.separatorFormatter));
                    });
                }
            } else {
                this.singleInputValue = this.formatter
                    ? this.formatter(labels, this.allSelectedNodes[0], this.selectedValueList)
                    : labels.length
                    ? labels[0].join(this.separatorFormatter)
                    : '';
            }
        }
    }

    // 更新全国选中状态
    private updateCountryDataState(active: boolean = false, indeterminate: boolean = false) {
        const { countryData } = this;
        countryData.active = active;
        countryData.indeterminate = indeterminate;
    }

    // 多选时，动态计算全国选中状态
    private toggleCountryStatus() {
        const { active, indeterminate } = this.computedCountryStatus;
        this.updateCountryDataState(active, indeterminate);
    }

    // 选中全国时，清空其他选项选中状态
    private clearOtherSelectedStatus(val: string) {
        if (this.multiple) {
            this.multipleInputValue = val ? [val] : [];
        } else {
            this.singleInputValue = val;
        }
        this.updateSearchText();
        this.resetRenderData();
    }

    // 搜索-文字高亮条件
    private highLightFilter(node: ICustomOptionItem) {
        return node.label.startsWith(this.inputValue) || node.label.endsWith(this.inputValue);
    }

    // 搜索-更新子节点显示状态
    private displayChildNodes(node: ICustomOptionItem) {
        const { children } = node;
        if (children && children.length) {
            children.forEach((child: ICustomOptionItem) => {
                child.hidden = false;
                if (this.highLightFilter(child)) {
                    child.highlight = true;
                }
            });
        }
    }

    // 搜索-更新节点自身显示状态
    private updateNodeHiddenStatus(
        node: ICustomOptionItem,
        parent?: ICustomOptionItem,
        ancestor?: ICustomOptionItem,
    ) {
        node.hidden = true;
        if (this.highLightFilter(node)) {
            node.highlight = true;
            node.hidden = false;
            this.displayChildNodes(node);
            if (parent) {
                parent.hidden = false;
            }
            if (ancestor) {
                ancestor.hidden = false;
            }
        } else {
            const { children } = node;
            if (children && children.length) {
                children.forEach((child: ICustomOptionItem) => {
                    this.updateNodeHiddenStatus(child, node, parent);
                });
            }
        }
    }

    // 搜索
    private handleSearch(text: string) {
        this.handleCityDataChange(this.originData);
        if (text) {
            this.inputValue = text;
            this.localCityData.forEach((node: ICustomOptionItem) => {
                this.updateNodeHiddenStatus(node);
            });
        }
    }

    // 更新搜索框搜索值
    private updateSearchText(val: string = '') {
        if (this.dropContentCom) {
            this.dropContentCom.updateSearchText(val);
        }
    }

    // 清空
    private handleClear() {
        if (this.loading) {
            return;
        }
        this.updateInputValue(true);
        this.updateCountryDataState();
        this.updateSearchText();
        this.resetRenderData();
        this.handleSelectedChange();
    }

    // 组件失去焦点
    private handleClickOutside() {
        if (this.localVisible && this.blurAutoSave) {
            this.handleConfirm();
        } else {
            this.handleCancel(true);
        }
    }

    // popover组件状态变化
    private handleVisibleChange(v: boolean) {
        this.localVisible = v;
        this.updateSearchText();
        this.$emit('update:visible', v);
    }

    private resetRenderData() {
        if (this.useDefaultData) {
            this.updateLocalCityData();
        } else {
            this.handleCityDataChange(this.data as ICustomOptionItem[]);
        }
    }

    // 取消
    private handleCancel(isBlur: boolean = false) {
        if (this.loading) {
            return;
        }
        this.updateInputValue(true);
        this.refreshAfterCancel(isBlur);
        this.handleVisibleChange(false);
    }

    private refreshAfterCancel(isBlur: boolean) {
        // 失去焦点时，如果上一次有选中值，则不重置节点状态
        if ((isBlur && this.prevSelectedValues.length === 0) || !isBlur) {
            // 重置节点选中状态
            this.localCityData.forEach((node: ICustomOptionItem) => {
                node.active = false;
                node.indeterminate = false;
                this.updateChildrenStatus(node, false);
            });

            // 重置全国选中状态
            this.updateCountryDataState();
        }

        // 恢复上一次选中值
        if (this.prevSelectedValues.length) {
            const labels: string = this.prevSelectedValues.join();
            if (labels.includes(this.countryData.label)) {
                this.updateCountryDataState(true, false);
                this.clearOtherSelectedStatus(this.countryData.label);
            } else {
                this.handleValueChange(this.prevSelectedValues);
            }
        }
    }

    // 确认
    private handleConfirm() {
        if (this.loading) {
            return;
        }
        this.handleVisibleChange(false);
        this.handleSelectedChange();
    }

    // 清洗数据结构（只返回必要值）
    private getOriginNode(node: ICustomOptionItem): ICustomOptionItem {
        const { label, value, children, cityId, cityCode } = node;
        const result: ICustomOptionItem = {
            label,
            value,
        };
        if (children) {
            result.children = children.map(this.getOriginNode);
        }
        if (this.useDefaultData) {
            if (cityId) {
                result.cityId = cityId;
            }
            if (cityCode) {
                result.cityCode = cityCode;
            }
        }
        return result;
    }

    // 组件选中值变化
    private handleSelectedChange() {
        if (this.isCountrySelected) {
            const { label } = this.countryData;
            const labels = [label];
            this.prevSelectedValues = [labels];
            this.$emit('update:value', [labels]);
            this.$emit('input', [labels]);
            this.$nextTick(() => {
                this.$emit(
                    'change',
                    [labels],
                    this.getOriginNode(this.countryData),
                    this.multiple ? labels : label,
                );
            });
        } else {
            this.prevSelectedValues = this.selectedValueList;
            this.$emit('update:value', this.selectedValueList);
            this.$emit('input', this.selectedValueList);
            this.$nextTick(() => {
                this.$emit(
                    'change',
                    this.selectedValueList,
                    this.getTransferData(this.allSelectedNodes.map(this.getOriginNode), true),
                    this.multiple ? this.multipleInputValue : this.singleInputValue,
                );
            });
        }
    }

    // 切换类别选项卡
    private handleCategoryChange(value: string) {
        this.activeCategory = value;
        this.handleClear();
        this.$emit('category-change', value);
    }

    // 处理外部传入自定义数据源字段
    private getTransferData(data: ICustomOptionItem[], reverse = false) {
        const { label, value, children, disabled } = this.fieldNames;
        let replaceMaps: ICustomDataProps = {
            [label]: 'label',
            [value]: 'value',
            [children]: 'children',
            [disabled]: 'disabled',
        };
        if (reverse) {
            replaceMaps = {
                label,
                value,
                children,
                disabled,
            };
        }
        let originStr: string = JSON.stringify(data);
        Object.keys(replaceMaps).forEach((key: string) => {
            originStr = originStr.replace(new RegExp(key, 'gm'), replaceMaps[key]);
        });
        return JSON.parse(originStr);
    }

    private created() {
        this.localVisible = !!this.visible;
        this.activeCategory = this.dataSourceType as string;
        // 渲染兜底数据
        if (this.useDefaultData) {
            this.updateLocalCityData(this.defaultCityData);
        }
    }
}
</script>
