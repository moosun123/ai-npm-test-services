<template>
    <div :class="[prefix + '-wrapper' + (multiple ? '-multiple' : '')]">
        <div :class="[prefix + '-main']">
            <div :class="[prefix + '-header']">
                <CityCategoryTabs
                    v-if="showInsideCategory"
                    :data="categoryData"
                    @change="handleCategoryChange"
                ></CityCategoryTabs>
                <mtd-input
                    v-model="searchValue"
                    clearable
                    prefix-icon="mtdicon mtdicon-search"
                    :class="[prefix + '-popper-input']"
                    :placeholder="searchText"
                    @change="debounceChange"
                />
            </div>
            <slot name="recentView"></slot>
            <div :class="[prefix + '-body-wrapper', $slots.recentView ? '' : 'wrapper-custom']">
                <mtd-loading
                    v-show="loading"
                    :class="[prefix + '-loading']"
                    :message="loadingText"
                />
                <div v-show="!loading && isEmpty" :class="[prefix + '-loading']">
                    <mtd-icon class="empty-icon" name="sad-o"></mtd-icon>
                    <span class="empty-text">数据异常</span>
                </div>
                <component
                    v-show="!loading && !isEmpty"
                    :is="currComponent"
                    :select-any-level="selectAnyLevel"
                    :multiple="multiple"
                    :data="data"
                    :leaf-level="leafLevel"
                    :data-source-type="dataSourceType"
                    :show-select-all="showSelectAll"
                    :key="dataSourceType"
                ></component>
            </div>
        </div>
        <div :class="[prefix + '-footer', clearable ? prefix + '-footer-clearable' : '']">
            <mtd-button v-show="clearable" type="text-primary" @click="handleClear"
                >清除</mtd-button
            >
            <mtd-row
                ><mtd-button size="small" :class="[prefix + '-footer-cancel']" @click="handleCancel"
                    >取消</mtd-button
                >
                <mtd-button type="primary" size="small" @click="handleConfirm"
                    >确定</mtd-button
                ></mtd-row
            >
        </div>
    </div>
</template>
<script lang="ts">
import { Vue, Component, Prop, Inject } from 'vue-property-decorator';
import { ICustomOptionItem, DataSourceType, CategoryPositionType } from '../types';
import CityCategoryTabs from './CityCategoryTabs.vue';
import CitySequenceCategory from './CitySequenceCategory.vue';
import CityLevelCategory from './CityLevelCategory.vue';
import CityRegionsCategory from './CityRegionsCategory.vue';
import { debounce } from '../../../utils/utils';

@Component({
    components: {
        CityCategoryTabs,
        CitySequenceCategory,
        CityLevelCategory,
        CityRegionsCategory,
    },
})
export default class MpaCitySelect extends Vue {
    @Prop({
        type: Array,
        required: true,
    })
    data!: ICustomOptionItem[]; // 选项数据

    @Prop({
        type: String,
        required: true,
    })
    dataSourceType!: DataSourceType; // 数据源类型

    @Prop({
        type: Number,
        required: true,
    })
    leafLevel!: number; // 叶子节点级别

    @Prop({
        type: Boolean,
        required: true,
    })
    selectAnyLevel!: boolean; // 是否可以选择任意级别

    @Prop({
        type: Boolean,
        required: true,
    })
    showSelectAll!: boolean; // 是否显示全选

    @Prop({
        type: Boolean,
        required: true,
    })
    clearable!: boolean; // 是否可清空

    @Prop({
        type: Boolean,
        required: true,
    })
    multiple!: boolean; // 是否多选

    @Prop({
        type: String,
        required: true,
    })
    placeholder!: string; // 输入框占位符

    @Prop({
        type: Boolean,
        required: true,
    })
    displayCategory!: boolean; // 是否显示分类

    @Prop({
        type: String,
        required: true,
    })
    categoryPosition!: CategoryPositionType; // 分类位置

    @Prop({
        type: Array,
        required: true,
    })
    categoryData!: ICustomOptionItem[]; // 分类数据

    @Prop({
        type: Boolean,
        required: true,
    })
    loading!: boolean; // 是否加载中

    @Prop({
        type: String,
        required: true,
    })
    loadingText!: string; // 加载中文本

    @Prop({
        type: String,
        required: true,
    })
    searchText!: string; // 搜索框文本

    @Inject()
    private prefix!: string; // 前缀

    private searchValue: string = ''; // 搜索框值

    private debounceChange = debounce(this.inputFilterChange, 200); // 防抖函数

    private get showInsideCategory() {
        // 是否显示内部分类
        const { displayCategory, categoryPosition } = this;
        return displayCategory && categoryPosition === 'inside';
    }

    private get currComponent() {
        // 当前组件
        const { dataSourceType, multiple, leafLevel, selectAnyLevel } = this;
        switch (dataSourceType) {
            // 音序结构
            case 'sequence':
                return CitySequenceCategory;
            // 城市级别结构
            case 'level':
                return CityLevelCategory;
            // 业务大区结构
            case 'bussiness':
                return multiple ? CityRegionsCategory : CityLevelCategory;
            // 行政区结构
            default:
                if (leafLevel === 2) {
                    return selectAnyLevel
                        ? multiple
                            ? CityRegionsCategory
                            : CitySequenceCategory
                        : CitySequenceCategory;
                }
                return selectAnyLevel
                    ? multiple
                        ? CityRegionsCategory
                        : CityLevelCategory
                    : CityLevelCategory;
        }
    }

    private get isEmpty() {
        // 是否为空
        return this.data.length === 0;
    }

    public updateSearchText(val: string = '') {
        // 更新搜索框值
        this.searchValue = val;
    }

    private handleClear() {
        // 清空事件
        this.$emit('clear');
    }

    private handleCancel() {
        // 取消事件
        this.$emit('cancel');
    }

    private handleConfirm() {
        // 确定事件
        this.$emit('confirm');
    }

    private handleCategoryChange(value: string) {
        // 分类改变事件
        this.$emit('category-change', value);
    }

    private inputFilterChange(val: string) {
        // 输入框过滤改变事件
        this.$emit('search', val);
    }
}
</script>
