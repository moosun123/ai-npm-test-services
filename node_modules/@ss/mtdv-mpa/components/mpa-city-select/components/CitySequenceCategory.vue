<template>
    <div :class="[prefix + '-body', 'flex-col']">
        <div :class="[prefix + '-indexbar']">
            <span
                v-for="item in indexbarList"
                :key="item"
                @click="handleScrollIntoView(item, $event)"
                >{{ item }}</span
            >
        </div>
        <div :class="[prefix + '-sequence']">
            <CityCategoryGrid
                :multiple="multiple"
                :show-header="false"
                :show-checkbox="showCheckbox"
                :data="data"
                :select-any-level="selectAnyLevel"
                :show-select-all="showSelectAll"
                :show-nav-select-all="!isSequence"
            ></CityCategoryGrid>
        </div>
    </div>
</template>
<script lang="ts">
import { Vue, Component, Prop, Inject } from 'vue-property-decorator';
import CityCategoryGrid from './CityCategoryGrid.vue';
import { ICustomOptionItem, DataSourceType } from '../types';

@Component({
    components: {
        CityCategoryGrid,
    },
})
export default class CitySequenceCategory extends Vue {
    @Prop({
        type: Array,
        required: true,
    })
    // 数据源，ICustomOptionItem 类型的数组
    data!: ICustomOptionItem[];

    @Prop({
        type: Boolean,
        required: true,
    })
    // 是否支持多选
    multiple!: boolean;

    @Prop({
        type: Boolean,
        required: true,
    })
    // 是否允许选择任意一级
    selectAnyLevel!: boolean;

    @Prop({
        type: Boolean,
        required: true,
    })
    // 是否显示全选
    showSelectAll!: boolean;

    @Prop({
        type: String,
        required: true,
    })
    // 数据源类型
    dataSourceType!: DataSourceType;

    private get showCheckbox() {
        return this.dataSourceType === 'regions' && this.multiple;
    }

    private get isSequence() {
        return this.dataSourceType === 'sequence';
    }

    // 索引bar，优先显示firstLetter属性值（城市音序索引），其次显示value属性值（层级索引）
    private get indexbarList() {
        return Array.from(
            new Set(this.data.map((node: ICustomOptionItem) => node.firstLetter || node.value)),
        );
    }

    @Inject()
    private prefix!: string;

    // 考虑到一个页面，可能引用多个城市选择器组件，所以点击的时候再获取对应元素
    private handleScrollIntoView(selector: string, event: Event) {
        const { target } = event;
        if (target) {
            const parent: HTMLElement = (target as HTMLElement).parentNode as HTMLElement;
            const sibling: HTMLElement = parent.nextSibling as HTMLElement;
            const elem: HTMLElement = sibling.querySelector('.js-' + selector) as HTMLElement;
            if (elem) {
                elem.scrollIntoView(true);
            }
        }
    }
}
</script>
