<template>
    <div :class="[prefix + '-grid', 'flex-col']">
        <div class="grid-header" v-show="showHeader && data.length">
            <span
                v-show="title"
                :style="{
                    width: navWidth,
                }"
                >{{ title }}</span
            >
            <span v-show="subTitle">{{ subTitle }}</span>
        </div>
        <div class="grid-content">
            <!-- 全国 -->
            <div
                v-if="showSelectAll"
                class="grid-content-item"
                :style="{
                    'padding-top': '8px',
                }"
            >
                <div
                    class="nav nav-hover"
                    :style="{
                        width: navWidth,
                        visibility: showNavSelectAll ? 'visible' : 'hidden',
                    }"
                >
                    <mtd-checkbox
                        v-model="countryData.active"
                        v-if="showCheckbox"
                        :indeterminate="countryData.indeterminate"
                        @change="clearOtherOptions"
                    ></mtd-checkbox>
                    <span
                        :class="{
                            active: countryData.active,
                        }"
                        @click="handleCountryClick"
                        >{{ showNavSelectAll ? countryData.label : '' }}</span
                    >
                </div>
                <div v-show="!showNavSelectAll" class="cell">
                    <span
                        :class="{
                            active: countryData.active,
                            'multiple-active': countryData.active && multiple,
                        }"
                        @click="handleCountryClick"
                        >{{ countryData.label
                        }}<mtd-icon
                            v-if="countryData.active && multiple"
                            name="checkmini"
                        ></mtd-icon
                    ></span>
                </div>
            </div>
            <!-- 自定义class，优先firstLetter属性值（城市音序索引），其次value属性值（层级索引） -->
            <div
                v-show="!parent.hidden"
                v-for="parent in data"
                :key="parent.label + parent.value"
                :class="['grid-content-item', 'js-' + (parent.firstLetter || parent.value)]"
            >
                <div
                    v-show="showNav"
                    :class="{
                        nav: true,
                        'nav-hover': selectAnyLevel,
                        'nav-disabled': parent.disabled,
                    }"
                    :style="{
                        width: navWidth,
                    }"
                >
                    <mtd-checkbox
                        v-model="parent.active"
                        v-if="showCheckbox"
                        :indeterminate="parent.indeterminate"
                        :disabled="parent.disabled"
                        @change="handleCheckboxChange(parent)"
                    ></mtd-checkbox>
                    <span
                        :class="{
                            active: parent.active,
                            'high-light': parent.highlight,
                        }"
                        @click="handleParentNodeClick(parent)"
                        >{{ parent.label }}</span
                    >
                </div>
                <div class="cell">
                    <span
                        v-for="child in parent.children"
                        v-show="!child.hidden"
                        :key="child.value"
                        :class="{
                            active: child.active,
                            'multiple-active': child.active && multiple,
                            'high-light': child.highlight,
                            'cell-disabled': child.disabled,
                        }"
                        @click="handleChildNodeClick(child)"
                        >{{ child.label
                        }}<mtd-icon v-if="child.active && multiple" name="checkmini"></mtd-icon
                    ></span>
                </div>
            </div>
        </div>
    </div>
</template>
<script lang="ts">
import { Vue, Component, Prop, Inject } from 'vue-property-decorator';
import { ICustomOptionItem } from '../types';

@Component
export default class CityCategoryGrid extends Vue {
    // 是否多选
    @Prop({
        type: Boolean,
        required: true,
    })
    multiple!: boolean;

    // 是否显示复选框
    @Prop({
        type: Boolean,
        required: false,
        default: false,
    })
    showCheckbox!: boolean;

    // 是否显示头部
    @Prop({
        type: Boolean,
        required: false,
        default: true,
    })
    showHeader!: boolean;

    // 数据源
    @Prop({
        type: Array,
        required: true,
    })
    data!: ICustomOptionItem[];

    // 标题
    @Prop({
        type: String,
        required: false,
        default: '省份',
    })
    title!: string;

    // 副标题
    @Prop({
        type: String,
        required: false,
        default: '城市',
    })
    subTitle!: string;

    // 是否显示左侧索引列
    @Prop({
        type: Boolean,
        required: false,
        default: true,
    })
    showNav!: boolean;

    // 是否可以选择任意层级
    @Prop({
        type: Boolean,
        required: true,
    })
    selectAnyLevel!: boolean;

    // 是否显示全选
    @Prop({
        type: Boolean,
        required: true,
    })
    showSelectAll!: boolean;

    // 左侧索引列，是否显示全国（对应的是：右侧内容列，是否显示全国）
    @Prop({
        type: Boolean,
        required: false,
        default: true,
    })
    showNavSelectAll!: boolean;

    @Inject()
    private prefix!: string;

    @Inject()
    private countryData!: ICustomOptionItem;

    @Inject()
    private handleSelectSingleNode!: (node: ICustomOptionItem) => void;

    @Inject()
    private handleSelectMultipleNodes!: (node: ICustomOptionItem) => void;

    @Inject()
    private clearOtherSelectedStatus!: (val: string) => void;

    @Inject()
    private updateCountryDataState!: (active?: boolean, indeterminate?: boolean) => void;

    // 父级节点最多字符数
    private get maxStrLength() {
        const strLens: number[] = this.data.map((node: ICustomOptionItem) => node.label.length);
        return Math.min(Math.max(...strLens), 5);
    }

    // nav图层宽度
    private get navWidth() {
        // 14 是单个汉字宽度，24是checkbox宽度 + maginRight
        return 14 * this.maxStrLength + (this.showCheckbox ? 24 : 0) + 'px';
    }

    // 点击复选框
    private handleCheckboxChange(parent: ICustomOptionItem) {
        if (parent.disabled) {
            return;
        }
        this.handleSelectMultipleNodes(parent);
    }

    // 点击单个城市
    private handleChildNodeClick(child: ICustomOptionItem) {
        if (child.disabled) {
            return;
        }
        if (this.multiple) {
            child.active = !child.active;
            this.handleSelectMultipleNodes(child);
        } else {
            if (child.active) {
                return;
            }
            child.active = true;
            this.handleSelectSingleNode(child);

            // 重置全国选中状态
            this.updateCountryDataState();
        }
    }

    // 点击父节点
    private handleParentNodeClick(parent: ICustomOptionItem) {
        const { multiple, selectAnyLevel } = this;
        if (!multiple && selectAnyLevel && !parent.disabled) {
            parent.active = true;
            this.handleSelectSingleNode(parent);

            // 重置全国选中状态
            this.updateCountryDataState();
        }
    }

    // 选择全国
    private handleCountryClick() {
        const active = this.multiple ? !this.countryData.active : true;
        this.updateCountryDataState(active, false);
        this.clearOtherOptions();
    }

    // 选择全国时，清空其他选项选中状态
    private clearOtherOptions() {
        const { active, label, indeterminate } = this.countryData;
        if (indeterminate) {
            this.updateCountryDataState(true, false);
        }
        this.updateCountryDataState(active, false);
        this.clearOtherSelectedStatus(active ? label : '');
    }
}
</script>
