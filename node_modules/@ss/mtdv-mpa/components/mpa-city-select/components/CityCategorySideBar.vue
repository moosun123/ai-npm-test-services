<template>
    <div :class="[prefix + '-side', 'flex-col']">
        <div class="title">{{ title }}</div>
        <div class="menu">
            <!-- 全国 -->
            <div
                v-if="showSelectAll"
                :class="['menu-item', countryData.active ? 'menu-item-active' : '']"
                @click="handleCountryClick"
            >
                <mtd-checkbox
                    v-if="multiple"
                    v-model="countryData.active"
                    :indeterminate="countryData.indeterminate"
                    @change="clearOtherOptions"
                ></mtd-checkbox>
                <div class="text">
                    <span>{{ countryData.label }}</span>
                </div>
            </div>
            <div
                v-for="item in list"
                v-show="!item.hidden"
                :key="item.value + item.label"
                :class="[
                    'menu-item',
                    item.active ? 'menu-item-active' : '',
                    item.expand ? 'menu-item-expand' : '',
                ]"
                @click="handleExpand(item)"
            >
                <mtd-checkbox
                    v-if="multiple"
                    v-model="item.active"
                    :indeterminate="item.indeterminate"
                    :disabled="item.disabled"
                    @change="toggleCheckboxStatus(item)"
                ></mtd-checkbox>
                <div
                    :class="{
                        text: true,
                        'text-disabled': item.disabled,
                    }"
                    @mouseenter="handleMouseEnter(item, $event)"
                    @mouseleave="handleHideTooltip"
                >
                    <span
                        :class="{
                            'high-light': item.highlight,
                        }"
                        >{{ item.label }}</span
                    >
                </div>
                <mtd-icon v-show="showExpand" name="right"></mtd-icon>
            </div>
        </div>
        <mtd-tooltip
            placement="right"
            ref="textTooltip"
            trigger="custom"
            :popper-class="[prefix + '-text-popper']"
            :visible="tooltipVisible"
        >
            <span slot="content">{{ tooltipContent }}</span>
        </mtd-tooltip>
    </div>
</template>
<script lang="ts">
import { Vue, Component, Prop, Inject, Ref } from 'vue-property-decorator';
import { ICustomOptionItem } from '../types';

@Component
export default class CityCategorySideBar extends Vue {
    // 选项列表
    @Prop({
        type: Array,
        required: true,
        default: () => [],
    })
    list!: ICustomOptionItem[];

    // 是否多选
    @Prop({
        type: Boolean,
        required: true,
    })
    multiple!: boolean;

    // 是否可以选择任意一级
    @Prop({
        type: Boolean,
        required: true,
    })
    selectAnyLevel!: boolean;

    // 是否显示全选
    @Prop({
        type: Boolean,
        required: true,
    })
    showSelectAll!: boolean;

    // 标题
    @Prop({
        type: String,
        required: false,
        default: '省份',
    })
    title!: string;

    // 是否显示展开箭头
    @Prop({
        type: Boolean,
        required: false,
        default: true,
    })
    showExpand!: boolean;

    @Ref('textTooltip') textTooltipCom!: any;

    @Inject()
    private prefix!: string;

    @Inject()
    private countryData!: ICustomOptionItem;

    @Inject()
    private handleSelectMultipleNodes!: (val: ICustomOptionItem) => void;

    @Inject()
    private handleSelectSingleNode!: (node: ICustomOptionItem) => void;

    @Inject()
    private updateCountryDataState!: (active?: boolean, indeterminate?: boolean) => void;

    @Inject()
    private clearOtherSelectedStatus!: (val: string) => void;

    private tooltipVisible: boolean = false;

    private tooltipContent: string = '';

    // 初始化展开状态
    private initExpandStatus(node: ICustomOptionItem) {
        node.expand = false;
        const { children } = node;
        if (children) {
            children.forEach(this.initExpandStatus);
        }
    }

    // 展开
    private handleExpand(current: ICustomOptionItem) {
        const { list, initExpandStatus, selectAnyLevel, multiple } = this;

        list.forEach(initExpandStatus);
        current.expand = true;

        // 可选任一级且是单选时，选中当前节点
        if (selectAnyLevel && !multiple && !current.disabled) {
            this.handleSelectSingleNode(current);

            // 重置全国选中状态
            this.updateCountryDataState();
        }
    }

    // 更新复选框选中项状态
    private toggleCheckboxStatus(current: ICustomOptionItem) {
        if (current.disabled) {
            return;
        }
        this.handleSelectMultipleNodes(current);
    }

    // 选择全国时，清空其他选项选中状态
    private clearOtherOptions() {
        const { active, label, indeterminate } = this.countryData;
        if (indeterminate) {
            this.updateCountryDataState(true, false);
        }
        this.updateCountryDataState(active, false);
        this.clearOtherSelectedStatus(active ? label : '');
    }

    // 单选时，选中全国
    private handleCountryClick() {
        if (this.multiple) {
            return;
        }
        this.updateCountryDataState(true, false);
        this.clearOtherOptions();
    }

    // 是否显示tooltips
    private handleMouseEnter(item: ICustomOptionItem, event: Event) {
        const target: HTMLElement = event.target as HTMLElement;
        const { scrollWidth, clientWidth } = target;
        if (scrollWidth > clientWidth) {
            this.showTooltip(target, item.label);
        }
    }

    // 获得popper实例
    private getPopper() {
        return this.textTooltipCom.getPopper();
    }

    // 显示tooltips
    private showTooltip(reference: HTMLElement, content: string) {
        const popper = this.getPopper();
        if (!popper) {
            return;
        }
        popper.destroy();
        this.tooltipVisible = true;
        this.tooltipContent = content;
        popper.reference = reference;
        popper.updatePopper();
    }

    // 隐藏tooltips
    private handleHideTooltip() {
        this.tooltipVisible = false;
    }
}
</script>
