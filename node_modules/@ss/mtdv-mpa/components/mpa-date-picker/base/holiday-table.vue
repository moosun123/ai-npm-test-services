<template>
  <div class="mpa-date-picker">
    <div :class="{
      [`${prefix}-cells mpa-date-picker-cells mpa-date-picker-holiday-wrap`]: true}">
      <div
        :class="[`${prefix}-holiday-cell`, getCellCls(cell)]"
        v-for="(cell, key) in holidayMap[tableYear]"
        :key="String(cell) + key"
        @click="handleClick(cell, $event)"
        @mouseenter="handleMouseMove(cell)"
      >
        <span :class="[`${prefix}-holiday-cell-key`]">{{key}}</span>
        <p :class="[`${prefix}-holiday-cell-dates`]">{{formatMD(cell[0])}}-{{formatMD(cell[cell.length - 1])}}</p>
      </div>
    </div>
  </div>
</template>
<script>
import dayjs from './../../../utils/date';
import {
  clearHours, isInRange,
} from './../../../utils/date';
import {
  NORMAL_HOLIDAY, dayText
} from './../../../utils/specialDayRange';
import jsCalendar from './../../../utils/js-calendar';
import { CONFIG_PROVIDER,
  getPrefixCls
} from './../../../utils/config';
import mixin from './mixin';

export default {
  mixins: [ mixin ],
  props: {

  },
  inject: {
    config: {
      default: {
        getPrefixCls,
      },
    },
  },
  computed: {
    yearArr() {
      const data = Object.keys(this.holidays.details).sort((a, b) => a - b);
      return data.map(a => Number(a));
    },
    prefix() {
      return this.config.getPrefixCls('date-picker');
    },
    calendar() {
      return new jsCalendar.Generator({
        onlyDays: !this.showWeekNumbers,
        weekStart: this.weekStart,
        isoWeek: this.isoWeek,
      });
    },
    tableYear() {
      return this.tableDate.getFullYear();
    },
    holidayMap() {
      const obj = {};
      const years = this.yearArr;
      NORMAL_HOLIDAY.map((h) => {
        years.map((y) => {
          if (!obj[y]) {
            obj[y] = {};
          }
          // 中秋节等节日重叠处理（后续多节日场景扩展数组数据结构）
          if (h === dayText.NationalAndMidAutumn) {
            if (obj[y][dayText.midAutumn] && obj[y][dayText.midAutumn].length === 0) {
              h = dayText.midAutumn;
            }
          } else {
            if (!obj[y][h]) {
              obj[y][h] = [];
            }
          }
          for (const i of Object.keys(this.holidays.details[y])) {
            if (i === h) {
              obj[y][h] = this.holidays.details[y][i].dates;
            }
          }
        });
      });
      return obj;
    }
  },
  methods: {
    formatMD(date) {
      return dayjs(date).format('MMDD');
    },
    getCellCls(cell) {
      const { prefix } = this;
      const prefixCls = `${prefix}-cells`;
      return [
        {
          [`${prefixCls}-holiday-selected`]: dayjs(cell[0]).isSame(dayjs(this.dates[0]), 'day') &&
            dayjs(cell[cell.length - 1]).isSame(dayjs(this.dates[1]), 'day')
        },
      ];
    },
    getLunarDate(date) {
      // 计算农历并截取日
      if (!date) return '';
      const lunarDate = LunarCalendar.solar2lunar(date);
      if (lunarDate.festival.length) {
        return lunarDate.festival[0];
      } else {
        const LunarDateDay = lunarDate.IDayCn;
        return LunarDateDay;
      }
    },
    handleClick(cell) {
      if (cell.disabled || cell.type === 'weekLabel') return;
      let newDate = new Date(clearHours(cell));
      if (['workday', 'weekends'].includes(this.pickerType)) {
        newDate = [this.state.from, this.state.to];
      }
      if (this.pickerType === 'holiday') {
        newDate = [new Date(cell[0]), new Date(cell[cell.length - 1])];
      }
      this.$emit('pick', newDate);
      this.$emit('pick-click');
      if (this.pickerTable) {
        const panelType = this.pickerTable.split('-')[0]; // year | month | date
        this.$emit('panel-change', newDate, panelType);
      }
    },
    handleMouseMove(cell) {
      if (!this.isWeek && !this.state.selecting) return;
      if (cell.disabled) return;
      const newDate = cell;
      this.$emit('change-range', newDate);
    },
  },
};
</script>

<style lang="scss" scoped></style>
