<template>
  <div class="mpa-date-picker">
    <div :class="classes">
      <span
        :class="getCellCls(cell)"
        v-for="(cell, i) in cells"
        :key="i"
        @click="handleClick(cell)"
      ><em>{{ cell.text }}</em></span>
    </div>
  </div>
</template>
<script>
import dayjs, { clearHours } from './../../../utils/date';
import { deepCopy } from './../../../utils/utils';
import mixin from './mixin';
import Locale from './../../../mixins/locale';
import {
  CONFIG_PROVIDER,
  getPrefixCls,
} from './../../../utils/config';

export default {
  mixins: [ mixin, Locale ],

  props: {/* in mixin */},
  inject: {
    config: {
      from: CONFIG_PROVIDER,
      default: {
        getPrefixCls,
      },
    },
  },
  computed: {
    prefix() {
      return this.config.getPrefixCls('date-picker');
    },
    prefixCls() {
      return `${this.prefix}-cells`;
    },
    classes() {
      const { prefixCls } = this;
      return [
        `${prefixCls}`,
        'mpa-date-picker-cells',
        `${prefixCls}-quarter`,
      ];
    },
    year() {
      return this.tableDate.getFullYear();
    },
    cells() {
      const cells = [];
      const cellTmpl = {
        text: '',
        selected: false,
        disabled: false,
      };

      const selectedQuarters = this.dates.filter(Boolean).filter((date) => {
        return date.getFullYear() === this.year;
      }).map((date) => {
        return this.getQuarter(date);
      });
      const focusedDate = clearHours(
        new Date(this.focusedDate.getFullYear(), 0, 1),
      );
      const disabledTestFn = typeof this.disabledDate === 'function' &&
        this.disabledDate;
      for (let i = 1; i < 5; i++) {
        const cell = deepCopy(cellTmpl);
        cell.date = new Date(this.year, (i - 1) * 3, 1);
        cell.disabled = (cell.date && disabledTestFn) &&
            disabledTestFn(cell.date);
        const day = clearHours(cell.date);
        cell.selected = selectedQuarters.indexOf(i) > -1;
        cell.focused = day === focusedDate;
        cell.range = this.pickerType === 'quarterrange'
          && (new Date(day) > this.dates[0] && new Date(day) < this.dates[1]);
        cell.text = `${this.t(`el.datepicker.quarter${i}`)}`;
        cells.push(cell);
      }
      return cells;
    },
  },
  methods: {
    getQuarter(date) {
      return dayjs(date).quarter();
    },
    getCellCls(cell) {
      const { prefixCls } = this;
      return [
        `${prefixCls}-cell`,
        `mpa-date-picker-cells-cell-quarter`,
        {
          [`${prefixCls}-cell-selected`]: cell.selected,
          [`${prefixCls}-cell-disabled`]: cell.disabled,
          [`${prefixCls}-cell-focused`]: cell.focused,
          [`${prefixCls}-cell-range`]: cell.range && !cell.start && !cell.end,
        },
      ];
    },
  },
};
</script>
