<template>
  <div class="mpa-date-picker">
    <div :class="{
        [`${prefix}-cells mpa-date-picker-cells`]: true,
        [`${prefix}-cells-show-week-numbers mpa-date-picker-cells-show-week-numbers`]: showWeekNumbers,
        [`${prefix}-week-cells`]: isWeek,
      }">
      <div :class="[`${prefix}-cells-header`]">
        <span v-for="day in headerDays" :key="day"><em>{{ day }}</em></span>
      </div>
      <span
        :class="[`${prefix}-cells-cell`, getCellCls(cell)]"
        v-for="(cell, i) in cells"
        :key="String(cell.date) + i"
        @click="handleClick(cell, $event)"
        @mouseenter="handleMouseMove(cell)"
      >
        <i
          v-if="workCellIcon && isHolidayOrWorkday(cell.date) === 'holiday'"
          :class="[
            `${prefix}-icon`,
            `${prefix}-icon-holiday`
          ]"
          >休</i
        >
        <i
          v-if="workCellIcon && isHolidayOrWorkday(cell.date) === 'workday'"
          :class="[
            `${prefix}-icon`,
            `${prefix}-icon-workday`
          ]"
          >班</i
        >
        <em :class="[`${prefix}-cells-cell-wrap`]">
          <span
            v-if="cell.type !== 'weekLabel'"
            :class="[
              `${prefix}-date`,
              !cell.date ? `${prefix}-week-num` : ''
            ]">
            <slot :cell="cell" name="cell"> {{ `${cell.desc}` }} </slot>
          </span>
          <span
            v-else
            :class="[
              `${prefix}-date`,
              !cell.date ? `${prefix}-week-num` : ''
            ]">
            <slot :cell="cell" name="weekCell"> {{ `${cell.desc}` }} </slot>
          </span>
          <span :class="
            [`${prefix}-date-lunar`,
            cell.selected ? `${prefix}-cell-selected` : `${prefix}-cell-unselected`,
            ]
          ">
            {{ getLunarDate(cell.date) }}
          </span>
        </em>
      </span>
    </div>
  </div>
</template>
<script>
import dayjs from './../../../utils/date';
import {
  clearHours, isInRange,
} from './../../../utils/date';
import Locale from '../../../mixins/locale';
import jsCalendar from './../../../utils/js-calendar';
import LunarCalendar from './../../../utils/chineseCalendar';

import mixin from './mixin';
import {
  dateToString, getDatesInRange, updateDayjsLocaleConfig
} from './../../../utils/date';
import {
  CONFIG_PROVIDER,
  getPrefixCls,
} from './../../../utils/config';

export default {
  mixins: [ Locale, mixin ],

  props: {
    /* more props in mixin */
    showWeekNumbers: {
      type: Boolean,
      default: false,
    },
    isoWeek: {
      type: Boolean,
      default: false,
    },
    workCellIcon: {
      type: Boolean,
      default: false,
    },
    holidays: {
      type: Object,
    },
    weekDate: {
      type: String,
      default: '',
    }
  },
  inject: {
    config: {
      from: CONFIG_PROVIDER,
      default: {
        getPrefixCls,
      },
    },
  },
  computed: {
    prefix() {
      return this.config.getPrefixCls('date-picker');
    },
    calendar() {
      return new jsCalendar.Generator({
        onlyDays: !this.showWeekNumbers,
        weekStart: this.weekStart,
        weekYearFirstStart: this.weekYearFirstStart,
        isoWeek: this.isoWeek,
      });
    },
    headerDays() {
      const { weekStart } = this;
      const translatedDays = [
        'sun', 'mon', 'tue',
        'wed', 'thu', 'fri',
        'sat',
      ].map(item => {
        return this.t('el.datepicker.weeks.' + item);
      });
      const weekDays = translatedDays.splice(weekStart, 7 - weekStart)
        .concat(translatedDays.splice(0, weekStart));
      return this.showWeekNumbers ? [''].concat(weekDays) : weekDays;
    },
    cells() {
      const that = this;
      const { isWeek } = this;
      const tableYear = this.tableDate.getFullYear();
      const tableMonth = this.tableDate.getMonth();

      // timestamp of today
      const today = clearHours(new Date());

      // timestamp of selected days
      const selectedDays = this.dates.map(clearHours);

      const rangeStart = this.state.from &&
        clearHours(this.state.from);
      const rangeEnd = this.state.to && clearHours(this.state.to);
      const rangeDates = [[rangeStart, rangeEnd]];

      if (isWeek) {
        const minDay = selectedDays[0];
        const maxDay = selectedDays[selectedDays.length - 1];
        rangeDates.push([minDay, maxDay]);
      }
      // 节假日 disabled 逻辑
      const singleWeek = this.selectionMode === 'week';
      const isRange = this.selectionMode === 'range' || singleWeek;
      let holidayList = [];
      for (const yearKey in this.holidays['details']) {
        if (this.holidays['details'].hasOwnProperty(yearKey)) {
          const currentYear = this.holidays['details'][yearKey] || {};
          for (const i of Object.keys(currentYear)) {
            const d1 = new Date(currentYear[i].dates[0]);
            const d2 = new Date(currentYear[i].dates[1]);
            const range = this.holidays['range'][i] && this.holidays['range'][i][0] || 0;
            const range2 = this.holidays['range'][i] && this.holidays['range'][i][1] || 0;
            if (currentYear[i].isHoliday) {
              holidayList = holidayList.concat(getDatesInRange(dayjs(d1).add(range, 'd'), dayjs(d2).add(range2, 'd')));
            }
          }
        }
      }
      const disabledHDate = function disabledDate(d) {
        return d && !holidayList.includes(dayjs(d).format('YYYY-MM-DD'));
      };
      const disabledWeekDate = function disabledDate(d) {
        return d && String(d.getDay()) !== that.weekDate;
      };
      const disabledTestFn = typeof this.disabledDate === 'function' &&
        this.disabledDate;
      let nowWeekNum;
      if (this.isoWeek) {
        nowWeekNum = dayjs(rangeStart).isoWeek();
      } else {
        nowWeekNum = dayjs(rangeStart).week();
      }
      const nowWeekYear = dayjs(rangeStart).year();
      return this.calendar(tableYear, tableMonth, (cell) => {
        const time = cell.date && clearHours(cell.date);
        const dateIsInCurrentMonth = cell.type === 'monthDay';
        const selected = time &&
          ((isWeek && singleWeek) || dateIsInCurrentMonth || this.pickerType === 'holidayrange') &&
          (selectedDays.indexOf(time) > -1);
        return {
          ...cell,
          type: time === today ? 'today' : cell.type,
          selected,
          disabled: (cell.date && disabledTestFn) &&
            disabledTestFn(new Date(time)) ||
            (this.pickerType === 'holidayrange' && disabledHDate(new Date(time))) ||
            (this.pickerType === 'weekday' && disabledWeekDate(new Date(time))) ||
            (cell.date && (this.pickerType === 'workday' && (cell.date.getDay() === 6 || cell.date.getDay() === 0)) ||
            (cell.date && this.pickerType === 'weekends' && (cell.date.getDay() === 1 || cell.date.getDay() === 2 ||
              cell.date.getDay() === 3 || cell.date.getDay() === 4 || cell.date.getDay() === 5))),
          range: (!selected && isRange &&
            (dateIsInCurrentMonth || isWeek || this.pickerType === 'holidayrange') &&
            (rangeDates.some((dates) => isInRange(time, dates[0], dates[1])))) ||
            (time === false && isWeek && nowWeekNum === cell.week && cell.year === nowWeekYear),
        };
      }).cells;
    },
  },
  created() {
    updateDayjsLocaleConfig(this.focusedDate, this.weekStart, this.weekYearFirstStart, this.isoWeek);
  },
  methods: {
    getCellCls(cell) {
      const { prefix } = this;
      const prefixCls = `${prefix}-cells`;
      return [
        {
          [`${prefixCls}-cell-selected`]: cell.selected || cell.start ||
            cell.end,
          [`${prefixCls}-cell-disabled`]: cell.disabled,
          [`${prefixCls}-cell-today`]: cell.type === 'today',
          [`${prefixCls}-cell-prev-month`]: cell.type === 'prevMonth',
          [`${prefixCls}-cell-next-month`]: cell.type === 'nextMonth',
          [`${prefixCls}-cell-week-label`]: cell.type === 'weekLabel',
          [`${prefixCls}-cell-week-label-range`]: cell.type === 'weekLabel' && cell.range && !cell.start && !cell.end,
          [`${prefixCls}-cell-range`]: cell.range && !cell.start && !cell.end,
          [`${prefixCls}-focused`]: clearHours(cell.date) ===
            clearHours(this.focusedDate),
        },
      ];
    },
    getLunarDate(date) {
      // 计算农历并截取日
      if (!date) return '';
      const lunarDate = LunarCalendar.solar2lunar(date);
      if (lunarDate.festival.length) {
        return lunarDate.festival[0];
      } else {
        const LunarDateDay = lunarDate.IDayCn;
        return LunarDateDay;
      }
    },
    isHolidayOrWorkday(date) {
      if (!date) {
        return '';
      }
      let holidayList = [];
      let workdayList = [];
      const currentYear = this.holidays.details[date.getFullYear()] || {};
      // 跨年假期（一般为元旦、春节）
      const nextYear = this.holidays.details[date.getFullYear() + 1] || {};
      workdayList = currentYear && currentYear['调班'] && currentYear['调班'].dates || [];
      for (const i of Object.keys(currentYear)) {
        if (currentYear[i].isHoliday) {
          holidayList = holidayList.concat(getDatesInRange(currentYear[i].dates[0], currentYear[i].dates[1]));
        }
      }
      for (const i of Object.keys(nextYear)) {
        if (i === '元旦' || i === '春节') {
          holidayList = holidayList.concat(getDatesInRange(nextYear[i].dates[0], nextYear[i].dates[1]));
        }
      }
      const dateString = dateToString(date, '-');
      if (workdayList.includes(dateString)) {
        return 'workday';
      } else if (holidayList && holidayList.includes(dateString)) {
        return 'holiday';
      }
      return '';
    }
  },
};
</script>

<style lang="scss" scoped></style>
