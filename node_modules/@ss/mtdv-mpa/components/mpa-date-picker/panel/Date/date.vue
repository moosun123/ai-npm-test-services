<template>
  <div :class="classes">
    <div :class="[panelPrefix + '-sidebar']" v-if="shortcuts.length || $slots.shortcuts">
      <slot name="shortcuts">
        <div :class="[panelPrefix + '-shortcut']"
          v-for="shortcut in shortcuts"
          :key="shortcut.text"
          @click="handleShortcutClick(shortcut)">{{ shortcut.text }}</div>
      </slot>
    </div>
    <div :class="[panelPrefix + '-body']">
      <div :class="`${prefix}-time-header`" v-if="showTime">
        <picker-input
          :current-value="visibleDate"
          size="small"
          readonly
        />
        <time-picker
          ref="timePicker"
          size="small"
          icon=""
          v-bind="timePickerOptions"
          :value="visibleTime"
          :open.sync="openTime"
          placement="bottom-end"
          :time-disabled="timeDisabled"
          @input="handleTimeChange"
          :append-to-container="false"
        />
      </div>
      <div :class="[prefix + '-header']"
        :style="headerStyle" 
        v-show="currentView !== 'time'">
        <span
          :class="iconBtnCls('prev', '-double')"
          @click="changeYear(-1)"
          v-if="validHolidayPrev">
          <Icon name="fast-backward" />
        </span>
        <span
          v-if="pickerTable === 'date-table'"
          :class="iconBtnCls('prev')"
          @click="changeMonth(-1)"
          v-show="currentView === 'date'">
          <Icon name="left" />
        </span>
        <date-panel-label
          :date-panel-label="datePanelLabel"
          :current-view="pickerTable.split('-').shift()"
          :date-prefix-cls="prefix" />
        <span
          :class="iconBtnCls('next', '-double')"
          @click="changeYear(+1)"
          v-if="validHolidayForward">
          <Icon name="fast-forward" />
        </span>
        <span
          v-if="pickerTable === 'date-table'"
          :class="iconBtnCls('next')"
          @click="changeMonth(+1)"
          v-show="currentView === 'date'">
            <Icon name="right" />
        </span>
      </div>
      <div :class="['mpa-date-picker-weekbar']" v-show="pickerType === 'weekday'">
        <mtd-radio-group v-model="weekDate">
          <mtd-radio value="1">周一</mtd-radio>
          <mtd-radio value="2">周二</mtd-radio>
          <mtd-radio value="3">周三</mtd-radio>
          <mtd-radio value="4">周四</mtd-radio>
          <mtd-radio value="5">周五</mtd-radio>
          <mtd-radio value="6">周六</mtd-radio>
          <mtd-radio value="0">周日</mtd-radio>
        </mtd-radio-group>
      </div>
      <div :class="[panelPrefix + '-content']">
        <component
          :is="pickerTable"
          ref="pickerTable"
          v-if="currentView !== 'time'"
          :week-date="weekDate"
          :table-date="panelDate"
          :show-week-numbers="isWeek || showWeekNumbers"
          :work-cell-icon="workCellIcon"
          :iso-week="isoWeek"
          :is-week="isWeek"
          :value="dates"
          :picker-type="pickerType"
          :selection-mode="isWeek ? 'week' : selectionMode"
          :disabled-date="disabledDate"
          :holidays="holidaysData"
          :focused-date="focusedDate"
          :range-state="rangeState"
          :week-start="weekStart"
          :week-year-first-start="weekYearFirstStart"
          :picker-table="pickerTable"
          @pick="panelPickerHandlers"
          @change-range="handleChangeRange"
          @panel-change="handlePanelChange"
        >
          <template slot-scope="scope" slot="cell">
            <slot :cell="scope.cell" name="cell" />
          </template>
          <template slot-scope="scope" slot="weekCell">
            <slot :cell="scope.cell" name="weekCell" />
          </template>
        </component>
      </div>
      <time-picker
        ref="timePicker"
        size="small"
        icon=""
        :time-place="timePlace"
        v-if="timePlace === 'right' && pickerTable === 'date-table'"
        v-bind="timePickerOptions"
        :value="visibleTime"
        :open="openTime2"
        placement="bottom-end"
        :time-disabled="timeDisabled"
        @input="handleTimeChange"
        :append-to-container="false"
      />
      <Confirm
        v-if="confirm"
        :show-time="showTime"
        :show-btn-now="showBtnNow"
        @click-now="handlePickClickNow"
        @confirm="handlePickSuccess"
      >
        <template slot v-if="$slots.confirm">
          <slot name="confirm" />
        </template>
      </Confirm>
    </div>
  </div>
</template>
<script>
import DateTable from '../../base/date-table.vue';
import HolidayTable from '../../base/holiday-table.vue';
import YearTable from '../../base/year-table.vue';
import HalfyearTable from '../../base/halfyear-table.vue';
import MonthTable from '../../base/month-table.vue';
import QuarterTable from '../../base/quarter-table.vue';
import TimePicker from '@components/time-picker';
import Confirm from '../../base/confirm.vue';
import datePanelLabel from './date-panel-label.vue';
import PickerInput from '../../input.js';
import Mixin from '../panel-mixin';
import DateMixin from './date-panel-mixin';
import Locale from '../../../../mixins/locale';
import Icon from '@components/icon';

import {
  DEFAULT_FORMATS,
  TYPE_VALUE_RESOLVER_MAP,
  siblingMonth,
  formatDateLabels,
} from '../../../../utils/date';

export default {
  name: 'DatePickerPanel',
  components: {
    DateTable,
    HolidayTable,
    YearTable,
    HalfyearTable,
    MonthTable,
    QuarterTable,
    TimePicker,
    datePanelLabel,
    Confirm,
    PickerInput,
    Icon,
  },
  mixins: [ Mixin, Locale, DateMixin ],
  inheritAttrs: false,
  props: {
    // more props in the mixin
    multiple: {
      type: Boolean,
      default: false,
    },
    defaultTime: {
      type: String,
    },
  },
  data() {
    const {selectionMode, value} = this;
    const dates = value.slice().sort();
    return {
      weekDate: this.panelDate ? String(this.panelDate.getDay()) :  String(new Date().getDay()),
      currentView: selectionMode || 'date',
      pickerTable: this.getTableType(selectionMode),
      dates,
      panelDate: this.startDate || dates[0] || new Date(),
      openTime: false,
      openTime2: true,
      rangeState: {},
    };
  },
  computed: {
    headerStyle() {
      const style = {};
      if (this.pickerType !== 'weekday') {
        return style;
      }
      style.borderBottom = 'none';
      return style;
    },
    validHolidayPrev() {
      if (this.selectionMode === 'holiday') {
        if (this.panelDate.getFullYear() < this.firstYear + 1) {
          return false;
        }
      }
      return true;
    },
    validHolidayForward() {
      if (this.selectionMode === 'holiday') {
        if (this.panelDate.getFullYear() > this.lastYear - 1) {
          return false;
        }
      }
      return true;
    },
    isWeek() {
      return ['week', 'workday', 'weekends'].includes(this.pickerType);
    },
    classes() {
      const { panelPrefix } = this;
      return [
        `${panelPrefix}-body-wrapper`,
        `mpa-picker-panel-body-wrapper`,
        {
          [`${panelPrefix}-with-sidebar`]: this.shortcuts.length,
        },
      ];
    },
    panelPickerHandlers() {
      return this.pickerTable === `${this.currentView}-table` ? this.handlePick
        : this.handlePreSelection;
    },
    datePanelLabel() {
      const date = this.panelDate;
      const { labels, separator } = formatDateLabels(
        this.t,
        date,
      );

      const handler = (type) => {
        return () => {
          this.pickerTable = this.getTableType(type); // eslint-disable-line
          return this.pickerTable;
        };
      };

      return {
        separator,
        labels: labels.map((obj) => {
          obj.handler = handler(obj.type);
          return obj;
        }),
      };
    },
    timeDisabled() {
      return !this.dates[0];
    },
    visibleTime() {
      return this.dates[0];
    },
    visibleDate() {
      return this.formatDate(this.value, 'date');
    },
  },
  watch: {
    value(newVal) {
      this.handleValueChange(newVal);
    },
    currentView() {
      if (this.currentView === 'time') {
        this.$nextTick(() => {
          const spinner = this.$refs.timePicker.$refs.timeSpinner;
          spinner.updateScroll();
        });
      }
    },
    selectionMode(type) {
      this.currentView = type;
      this.pickerTable = this.getTableType(type);
    },
    panelDate(val) {
      if (val) {
        this.weekDate = String(this.panelDate.getDay());
      }
      this.weekDate = String(new Date().getDay());
    },
    focusedDate(date) {
      const isDifferentYear = date.getFullYear() !==
        this.panelDate.getFullYear();
      const isDifferentMonth = isDifferentYear ||
        date.getMonth() !== this.panelDate.getMonth();
      if (isDifferentYear || isDifferentMonth) {
        this.panelDate = date;
      }
    },
    visible(v) {
      if (!v) {
        this.handleValueChange(this.value);
      }
    },
    pickerTable() {
      this.$emit('current-view-change');
    },
  },
  mounted() {
    this.weekDate = this.panelDate ? String(this.panelDate.getDay()) : String(new Date().getDay());
  },
  methods: {
    handleValueChange(newVal) {
      this.dates = newVal;
      this.panelDate = this.startDate || (this.multiple
        ? this.dates[this.dates.length - 1] : this.dates[0]) || new Date();
      this.rangeState = {};
    },
    reset() {
      this.currentView = this.selectionMode;
      this.pickerTable = this.getTableType(this.currentView);
    },
    changeYear(dir) {
      if (this.selectionMode === 'year' || this.pickerTable === 'year-table') {
        this.panelDate = new Date(
          this.panelDate.getFullYear() + dir * 10,
          0,
          1,
        );
      } else {
        this.panelDate = siblingMonth(this.panelDate, dir * 12);
      }
      this.handlePanelChange();
    },
    getTableType(currentView) {
      return currentView.match(/^time/) ? 'time-picker'
        : `${currentView}-table`;
    },
    changeMonth(dir) {
      this.panelDate = siblingMonth(this.panelDate, dir);
      this.handlePanelChange();
    },
    handlePreSelection(value) {
      if (Array.isArray(value)) {
         this.panelDate = value[0];
      } else {
         this.panelDate = value;
      }
      if (this.pickerTable === 'year-table') {
        this.pickerTable = this.getTableType(this.pickerType === 'quarter' ? 'quarter' : 'month');
      } else {
        this.pickerTable = this.getTableType(this.currentView);
      }
    },
    handlePick(value, type) {
      if (['workday', 'weekends', 'holiday'].includes(this.pickerType)) {
        this.$emit('pick', value, false);
      } else {
        const { selectionMode, panelDate, defaultTime } = this;
        if (selectionMode === 'year') value = new Date(value.getFullYear(), 0, 1);
        else if (selectionMode === 'month') {
          value = new Date(
            panelDate.getFullYear(),
            value.getMonth(), 1,
          );
        } else {
          value = new Date(value);
          if (defaultTime) {
            const defaultTimes = defaultTime.split(':');
            const hours = defaultTimes[0];
            const mins = defaultTimes[1];
            const sec = defaultTimes[2];
            value.setHours(hours, mins, sec);
          }
        }
        if (this.pickerType === 'datetime') {
          const current = this.dates[0];
          const defaultTimes = (defaultTime || '0:0:0').split(':');
          const hours = current ? current.getHours() : defaultTimes[0];
          const mins = current ? current.getMinutes() : defaultTimes[1];
          const sec = current ? current.getSeconds() : defaultTimes[2];
          value.setHours(hours, mins, sec);
        }
        this.dates = [value];
      }
      this.$emit('pick', value, false);
    },
    handleTimeChange(time) {
      const hours = time ? time.getHours() : 0;
      const mins = time ? time.getMinutes() : 0;
      const sec = time ? time.getSeconds() : 0;
      const d = this.visibleTime ? new Date(this.visibleTime) : new Date();
      d.setHours(hours, mins, sec);
      this.$emit('pick', d, false);
    },
    formatDate(value, type) {
      let format = this.format;
      if (format) {
        format = format.split(' ')[0];
      }

      format = format || DEFAULT_FORMATS[type];
      const { formatter } = (
        TYPE_VALUE_RESOLVER_MAP[type] ||
        TYPE_VALUE_RESOLVER_MAP['default']
      );
      return formatter(value, format);
    },
    handleChangeRange(val) {
      if (val && this.visible) {
        this.rangeState = {
          from: val,
          to: val,
        };
      }
    },
    handlePanelChange(newData, panelType) {
      if (this.pickerTable) {
        const tempPanelType = this.pickerTable.split('-')[0];
        this.$emit('panel-change', newData || this.panelDate, panelType || tempPanelType);
      }
    },
  },
};
</script>
