<template>
  <div :class="[panelPrefix + '-body-wrapper']" @mousedown.prevent>
    <div :class="[panelPrefix + '-body']">
      <div :class="[timePrefix + '-header']" v-if="showDate">
        {{ visibleDate }}
      </div>
      <div :class="[panelPrefix + '-content']">
        <time-spinner
          ref="timeSpinner"
          :show-seconds="showSeconds"
          :show-minutes="showMinutes"
          :steps="steps"
          :hours="timeSlots[0]"
          :minutes="timeSlots[1]"
          :seconds="timeSlots[2]"
          :disabled-hours="disabledHMS.disabledHours"
          :disabled-minutes="disabledHMS.disabledMinutes"
          :disabled-seconds="disabledHMS.disabledSeconds"
          :hide-disabled-options="hideDisabledOptions"
          @change="handleChange"
        />
      </div>
      <Confirm
        v-if="confirm"
        :show-btn-now="showBtnNow"
        @click-now="handlePickClickNow"
        @confirm="handlePickSuccess"
      />
    </div>
  </div>
</template>
<script>
import TimeSpinner from '../../base/time-spinner.vue';
import Confirm from '../../base/confirm.vue';
import Options from '../../time-mixins';

import Mixin from '../panel-mixin';
import Locale from '../../../../mixins/locale';

import { initTimeDate } from '../../../../utils/date';

const capitalize = (str) => str[0].toUpperCase() + str.slice(1);
const returnFalse = () => false;

export default {
  name: 'TimePickerPanel',
  components: { TimeSpinner, Confirm },
  mixins: [Mixin, Locale, Options],
  props: {
    disabledDate: {
      type: Function,
      default: returnFalse,
    },
    steps: {
      type: Array,
      default: () => [],
    },
    format: {
      type: String,
      default: 'HH:mm:ss',
    },
    value: {
      type: Array,
      required: true,
    },
    timePlace: {
      type: String,
      default: 'default',
    }
  },
  data() {
    return {
      date: this.value[0] || initTimeDate(),
      showDate: false,
    };
  },
  computed: {
    timePrefix() {
      return this.config.getPrefixCls('time-picker');
    },
    showSeconds() {
      return !!(this.format || '').match(/s$/);
    },
    showMinutes() {
      return !!(this.format || '').match(/m/);
    },
    visibleDate() {
      const date = this.date;
      const month = date.getMonth() + 1;
      const tYear = this.t('el.datepicker.year');
      const tMonth = this.t(`el.datepicker.month${month}`);
      return `${date.getFullYear()}${tYear} ${tMonth}`;
    },
    timeSlots() {
      if (!this.value[0]) return [];
      return ['getHours', 'getMinutes', 'getSeconds']
        .map(slot => this.date[slot]());
    },
    disabledHMS() {
      // 时
      const disabledHours = typeof this.disabledHours === 'function' ? this.disabledHours() : this.disabledHours;

      // 分
      const disabledMinutes = typeof this.disabledMinutes === 'function'
        ? this.disabledMinutes(this.value[0] ? this.value[0].getHours() : undefined)
        : this.disabledMinutes;

      // 秒
      const disabledSeconds = typeof this.disabledSeconds === 'function'
        ? this.disabledSeconds(
          this.value[0] ? this.value[0].getHours() : undefined,
          this.value[0] ? this.value[0].getMinutes() : undefined)
        : this.disabledSeconds;

      const result = {
        disabledHours,
        disabledMinutes,
        disabledSeconds,
      };

      return result;
    },
  },
  watch: {
    value(dates) {
      let newVal = dates[0] || initTimeDate();
      newVal = new Date(newVal);
      this.date = newVal;
    },
  },
  methods: {
    handleChange(date, emit = true) {
      const newDate = new Date(this.date);
      Object.keys(date).forEach(
        type => newDate[`set${capitalize(type)}`](date[type]),
      );

      if (emit) this.$emit('pick', newDate, true);
    },
  },
};
</script>
