<template>
    <div>
        <MpaConditionExpression
            ref="expression"
            :conditionData="conditionData"
            @addCondition="addCondition"
            @compChanged="compChanged"
        />
        <div style="margin-top: 20px; text-align: left">
            <mtd-button class="btn-demo-item" icon="mtdicon mtdicon-add" @click="addRootCondition"
                >添加规则</mtd-button
            >
        </div>
    </div>
</template>
<style></style>
<script lang="ts">
import { Vue, Component } from 'vue-property-decorator';
import MpaConditionExpression from '../../mpa-condition-expression.vue';
import TestCondition from '../../test/test-condition.vue';
import UaCondition from '../../test/ua-condition.vue';
Vue.component(TestCondition.name, TestCondition);
Vue.component(UaCondition.name, UaCondition);
@Component({
    components: {
        MpaConditionExpression,
    },
})
export default class MutlComp extends Vue {
    private conditionData = {
        conditionType: 'and',
        childConditionList: [
            {
                conditionType: 'and',
                operatorList: ['copy', 'delete', 'filters'],
                comp: 'ua-condition',
                data: {
                    type: 2,
                    labelId: '21',
                    operator: '>',
                    value: '10',
                },
                childConditionList: [
                    {
                        comp: 'test-condition',
                        data: {
                            key: '01',
                            operator: 'in',
                            value: '兔',
                        },
                    },
                    {
                        comp: 'test-condition',
                        data: {
                            key: '01',
                            operator: 'in',
                            value: '兔',
                        },
                    },
                ],
            },
            {
                conditionType: 'and',
                comp: 'ua-condition',
                operatorList: ['copy', 'delete'],
                data: {
                    type: 1,
                    labelId: '01',
                    operator: 'in',
                    value: '兔',
                },
            },
        ],
    };
    private validate() {
        (this.$refs.expression as MpaConditionExpression).validate();
    }

    private addRootCondition() {
        (this.$refs.expression as MpaConditionExpression).addRootCondition({
            comp: 'ua-condition',
            operatorList: ['copy', 'delete', 'filters'],
            data: {
                type: 2,
                labelId: '21',
                operator: '>',
                value: '10',
            },
        });
    }

    private compChanged({ val, old, root }) {
        if (val.type !== old.type) {
            if (!root.hasOwnProperty('childConditionList')) {
                this.$set(root, 'childConditionList', []);
            } else {
                root.childConditionList = [];
            }
            if (root)
                if (val.type === 1) {
                    root.operatorList = ['copy', 'delete'];
                } else {
                    root.operatorList = ['copy', 'delete', 'filters'];
                }
        }
    }

    private addCondition({ name, comp, callback }) {
        if (comp === 'ua-condition') {
            callback({
                comp: 'test-condition',
                operatorList: ['copy', 'delete'],
                data: {
                    key: '01',
                    operator: 'in',
                    value: '',
                },
            });
        } else {
            callback({
                comp: 'ua-condition',
                operatorList: ['copy', 'delete', 'filters'],
                data: {
                    type: 2,
                    labelId: '21',
                    operator: '>',
                    value: '10',
                },
            });
        }
    }
}
</script>
<style lang="scss" scoped>
</style>
