<template>
    <div
        :class="{
            'mpa-condition-expression-wrap': true,
            'is-enter': isEnter,
            'show-title': showTitle,
        }"
        v-if="showWrap"
    >
        <div class="mpa-condition-expression-wrap-header" v-if="showTitle || showEditTitle">
            <condition-title
                :contenteditable="editHeader"
                :name="name"
                :index="index"
                :showExpand="!!childrenLen"
                :isExpand.sync="isShow"
                @editName="editName"
                @deleteItem="deleteItem"
                :disabled="disabled">
            </condition-title>
            <div class="header-right" v-if="showRightOperate">
                <mtd-button
                    size="small"
                    icon="mtdicon mtdicon-file-add-o"
                    type="text"
                    :disabled="addDisabled"
                    @click="addCondition"
                    >添加条件</mtd-button
                >
            </div>
        </div>
        <div :class="{'mpa-condition-expression-wrap-container': true, 'show-edit-title': showEditTitle, 'show-filter-heigh-light': showFilterHeighLight}" v-show="isShow">
            <div
                :class="{ 'condition-group-filter': true, disabled: disabled  }"
                :style="{width: filterTextWidth}"
                v-if="isFilter && showFilterCondition"
            >
                {{this.filterText}}
            </div>
            <div
                :class="{ 'condition-group-container': true, 'has-filter': isFilter, 'bg-first': showFirstConditionType, 'bg-second': showSecondConditionType }"
                v-if="showLeftCondition && showRootCondition"
            >
                <mtd-select
                    v-model="conditionType"
                    class="condition-selector"
                    popper-class="condition-selector-popper"
                    style="width: 30px"
                    size="small"
                    :disabled="disabled"
                    v-if="showConditionSelector"
                >
                    <mtd-option
                        v-for="item in conditionOptions"
                        :key="item.value"
                        :label="item.label"
                        :value="item.value"
                        :disabled="item.disabled"
                    >
                        <div class="mtd-option-item">
                            <i v-if="isDefaultConditionOptions" :class="'mpa-icon' + ' ' + 'mpa-icon-' + item.value"></i> <span>{{item.label}}</span>
                        </div>
                    </mtd-option>
                </mtd-select>
            </div>
            <div :class="{'condition-children-list': true, 'is-filter': isFilter}" >
                <slot></slot>
                <div class="condition-add" v-if="showAdd">
                    <mtd-button
                        size="small"
                        icon="mtdicon mtdicon-file-add-o"
                        type="text"
                        :disabled="addDisabled"
                        @click="addCondition"
                        >添加条件</mtd-button
                    >
                </div>
                <template v-if="deepLevel == 0">
                    <slot name="addGroups"></slot>
                </template>
            </div>

        </div>
    </div>
</template>
<script lang="ts">
import { Component, Prop } from 'vue-property-decorator';
import { Operator } from '../constant/index';
import props from '../mixin/props.vue';
import { mixins } from 'vue-class-component';
import ConditionTitle from './condition-title.vue';
@Component({
    components: {
        ConditionTitle
    }
})
export default class ConditionWrap extends mixins(props) {
    @Prop({ type: Number, default: 0 })
    private childrenLen;

    @Prop({ type: Number, default: 0 })
    private deepLevel;

    @Prop({ type: Boolean, default: false })
    private isFilter;

    @Prop({ type: Object, default: () => {} })
    private parent;

    @Prop({ type: Number, default: 0 })
    private index;

    @Prop({ type: Object, default: () => {} })
    private root;

    @Prop({ type: Boolean, default: false })
    private showHeader;

    @Prop({ type: String, default: '' })
    private name;

    @Prop({ type: Boolean, default: true })
    private hasRootCondition;

    private value = 'and';

    private isIn = false;

    private isShow = true;

    private get showRootCondition() {
        if (this.deepLevel === 0) {
            return this.hasRootCondition;
        }
        return true;
    }

    private get useableOperators() {
        return [
            {
                label: '添加条件',
                value: Operator.ADD,
                icon: 'mtdicon-file-add-o',
                disabled: this.addDisabled,
            },
            {
                label: '删除条件',
                value: Operator.DELETE,
                icon: 'mtdicon-delete-o',
                disabled: this.root.min
                    ? this.root.min >= this.parent[this.childConditionListAttr].length
                    : false,
            },
        ];
    }

    private get operatorList() {
        return this.root.operatorList || [];
    }

    private get useableOperatorList() {
        return this.useableOperators.filter(it => this.operatorList.includes(it.value));
    }

    private get showTitle() {
        return this.deepLevel === this.baseHoverLevel && this.showHeader;
    }

    private get showEditTitle() {
        return this.deepLevel === this.baseHoverLevel && this.editHeader;
    }

    private get isConditionGroup() {
        return this.deepLevel === this.addChildButtonLevel && this.addChildBtn;
    }

    private get showLeftCondition() {
        if (this.isFilter) {
            if (this.filterText) {
                return this.childrenLen > 1;
            } else {
                return this.childrenLen > 0;
            }
        } else {
            return this.showConditionSelector;
        }
    }

    private get showFilterCondition() {
        return this.childrenLen > 0;
    }

    private get showConditionSelector() {
        return this.isConditionGroup ? this.childrenLen > 0 : this.childrenLen > 1;
    }

    private get addDisabled() {
        if (this.disabled) {
            return true;
        }
        return this.root.max ? this.root.max === this.childrenLen : false;
    }

    private get isEnter() {
        return this.isOperateLevel && this.isIn;
    }

    private get isOperateLevel() {
        return this.showHeader ? this.deepLevel === this.baseHoverLevel : this.deepLevel === this.fixedHovelLevel;
    }

    private get showAdd() {
        return this.isOperateLevel && this.addChildBtn && !this.isFilter && this.childrenLen;
    }

    private get showWrap() {
        if (this.showTitle) {
            return this.deepLevel === this.baseHoverLevel ? true : !!this.childrenLen;
        } else {
            return !!this.childrenLen;
        }
    }

    private get showFirstConditionType() {
        return this.root[this.conditionTypeAttr] === this.firstConditionTypeValue || !this.root[this.conditionTypeAttr];
    }

    private get showSecondConditionType() {
        return this.root[this.conditionTypeAttr] === this.secondConditionTypeValue;
    }

    private get showFilterHeighLight() {
        return this.filterHeighLight && this.isFilter;
    }

    private get showRightOperate() {
        const hasShowAdd = this.showHeader && !this.showAdd;
        return !this.disabled && hasShowAdd;
    }

    private get conditionType() {
        return this.root[this.conditionTypeAttr] || this.conditionOptions[0].value;
    }

    private set conditionType(val) {
        this.$set(this.root, this.conditionTypeAttr, val);
    }

    private onMouseMove() {
        // this.isIn = true;
    }
    private onMouseLeave() {
        // this.isIn = false;
    }

    private addCondition() {
        let root = this.root;
        if (!this.showHeader) {
            const { comp, data } = root;
            if (this.root && ((comp && data) || !this.root[this.childConditionListAttr])) {
                root = {
                    name: '',
                    max: this.root.max,
                    min: this.root.min,
                    [this.childConditionListAttr]: [this.root],
                    [this.conditionTypeAttr]: this.conditionOptions[0].value,
                };
                this.parent[this.childConditionListAttr].splice(this.index, 1, root);
            }
        } else {
            this.$set(this.root, this.childConditionListAttr, this.root[this.childConditionListAttr] || []);
        }

        this.$emit('addCondition', { root, name: this.name });
    }

    private delete() {
        if (this.parent && this.parent[this.childConditionListAttr]) {
            this.parent[this.childConditionListAttr].splice(this.index, 1);
            if (!this.parent[this.childConditionListAttr].length) {
                this.$emit('deleteCondition');
            }
        }
    }

    private add() {
        if (this.root) {
            this.$set(this.root, this.childConditionListAttr, this.root[this.childConditionListAttr] || []);
            this.$emit('addCondition', { root: this.root, name: this.name });
        }
    }

    private deleteItem() {
        this.$mtd
            .confirm({
                title: '确认删除',
                message: '是否确认删除该条件',
                type: 'info',
                okButtonText: '确认',
                showCancelButton: true,
                onOk: () => {
                    this.delete();
                },
            })
            .catch(() => {});
    }

    private clickItems(value) {
        switch (value) {
            case Operator.ADD:
                this.add();
                break;
            case Operator.DELETE:
                this.deleteItem();
            default:
                break;
        }
    }

    private editName(name) {
        this.root.name = name;
    }
}
</script>
<style scoped>
</style>
