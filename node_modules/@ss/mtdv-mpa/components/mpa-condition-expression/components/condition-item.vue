<template>
    <div class="mpa-condition-expression-item" v-if="comp">
        <div class="item-wrap">
            <div class="comp-container">
                <component
                    :is="comp"
                    ref="comp"
                    v-model="propData"
                    @updateValidate="updateValidate"
                    :disabled="disabled"
                    :index="index"
                ></component>
            </div>
            <div class="item-operator" v-if="!disabled">
                <span v-for="item in selectedOperatorList" :key="item.value">
                    <mtd-icon-button
                        class="mpa-icon-button"
                        size="small"
                        type="secondary"
                        :disabled="item.disabled"
                        :icon="'mtdicon' + ' ' + item.icon"
                        @click="clickIcon(item.value)"
                    />
                </span>
            </div>
        </div>
        <span class="error-tips">{{ root.error }}</span>
    </div>
</template>
<script lang="ts">
import { Operator } from '../constant/index';
import { Component, Prop, Watch } from 'vue-property-decorator';
import { mixins } from 'vue-class-component';
import _ from 'lodash';
import props from '../mixin/props.vue';
import { typeOf } from '../../../utils/utils';
@Component
export default class ConditionItem extends mixins(props) {
    @Prop({
        type: Object,
        default: () => {
            return {};
        },
    })
    private parent;

    @Prop({ type: Number, default: 0 })
    private index;

    @Prop({ type: String, default: '' })
    private comp;

    @Prop({ type: Object, default: () => {} })
    private propData;

    @Prop({ type: String, default: '' })
    private parentName;

    private weakMap = new WeakMap();

    private old = null;

    private get operatorObj() {
        const { min = 0, max = 0 } = this.parent;
        const childrenLen = this.parent[this.childConditionListAttr].length;
        return {
            [Operator.DELETE]: {
                name: '删除',
                icon: 'mtdicon-delete-o',
                value: Operator.DELETE,
                disabled: min ? childrenLen <= min : false,
                on: {
                    click: () => {},
                },
            },
            [Operator.COPY]: {
                name: '复制',
                icon: 'mtdicon-copy-o',
                value: Operator.COPY,
                disabled: max ? childrenLen >= max : false,
                on: {
                    click: () => {},
                },
            },
            [Operator.FILTERS]: {
                name: '新增子条件',
                icon: 'mtdicon-filter-o',
                value: Operator.FILTERS,
                on: {
                    click: () => {},
                },
            },
        };
    }

    private get root() {
        return this.parent && this.parent[this.childConditionListAttr]
            ? this.parent[this.childConditionListAttr][this.index]
            : this.parent;
    }

    private get operatorList() {
        return this.root.operatorList || [Operator.DELETE];
    }

    private get selectedOperatorList() {
        return this.operatorList
            .map(it => {
                return this.operatorObj[it] || null;
            })
            .filter(it => !!it);
    }

    @Watch('propData', { deep: true })
    private onPropDataChanged(val) {
        this.$emit('compChanged', {
            val,
            old: this.old,
            root: this.root,
        });
        this.old = _.cloneDeep(val);
        this.$nextTick(() => {
            if (this.root && this.root.compInstance) {
                if (
                    this.root.compInstance.validate &&
                    typeOf(this.root.compInstance.validate) === 'function'
                ) {
                    Promise.resolve(this.root.compInstance.validate()).then(res => {
                        let errorTxt = '';
                        if (typeof res !== 'boolean') {
                            errorTxt = res;
                        }
                        this.$set(this.root, 'error', errorTxt);
                    });
                }
            }
        });
    }

    private delete() {
        if (this.parent && this.parent[this.childConditionListAttr]) {
            this.parent[this.childConditionListAttr].splice(this.index, 1);
            if (!this.parent[this.childConditionListAttr].length) {
                this.$emit('deleteCondition');
            }
        }
    }

    private removeCompInstance(root) {
        if (root.hasOwnProperty('compInstance')) {
            this.weakMap.set(root, root.compInstance);
            delete root.compInstance;
        }
        if (root[this.childConditionListAttr] && root[this.childConditionListAttr].length) {
            root[this.childConditionListAttr].forEach(it => {
                this.removeCompInstance(it);
            });
        }
    }

    private installCompInstance(root) {
        if (this.weakMap.get(root)) {
            this.$set(root, 'compInstance', this.weakMap.get(root));
        }
        if (root[this.childConditionListAttr] && root[this.childConditionListAttr].length) {
            root[this.childConditionListAttr].forEach(it => {
                this.installCompInstance(it);
            });
        }
    }

    private copy() {
        if (this.parent && this.parent[this.childConditionListAttr]) {
            this.removeCompInstance(this.root);
            const tempRoot = _.cloneDeep(this.root);
            this.installCompInstance(this.root);
            this.parent[this.childConditionListAttr].push(tempRoot);
        }
    }

    private updateValidate() {}

    private clickIcon(type) {
        switch (type) {
            case Operator.DELETE:
                this.$mtd
                    .confirm({
                        title: '确认删除',
                        message: '是否确认删除该条件',
                        type: 'info',
                        okButtonText: '确认',
                        showCancelButton: true,
                        onOk: () => {
                            this.delete();
                        },
                    })
                    .catch(() => {});
                break;
            case Operator.COPY:
                this.copy();
                break;
            case Operator.FILTERS:
                this.$emit('addCondition', {
                    name: this.parentName,
                    parentData: this.propData,
                    comp: this.comp,
                    root: this.root,
                });
                break;
            default:
                break;
        }
    }

    private mounted() {
        if (this.root) {
            this.$set(this.root, 'compInstance', this.$refs['comp']);
        }
        this.old = _.cloneDeep(this.propData);
    }
}
</script>
