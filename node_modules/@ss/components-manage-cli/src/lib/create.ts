import * as fs from 'fs';
import * as path from 'path';
import { buildTS } from './buildTs';
import { buildCSS } from './buildCss';
import { buildEntry } from './buildEntry';
import { removeNamespace, getExtFromTechnology, handleMaintainer, readProgramConfig } from '../util/common';
import {
    esComponentTemplate,
    esDemoTemplate,
    esRegistryTemplate,
    tsComponentTemplate,
    tsDemoTemplate,
    tsRegistryTemplate,
    typeDefTemplate,
    testTemplate,
    componentDocTemplate,
    sassTemplate,
} from '../util/template';
import { fatalLog } from '@ss/components-manage-tools';
import { DISABLE_COMPONENT_NAME_INSPECTION } from '../contant';

const upperCamelCase = require('uppercamelcase');

export function create() {
    const programPath = process.cwd();
    const { technology } = readProgramConfig(programPath);

    process.on('exit', () => {
        console.log();
    });

    if (!process.argv[3]) {
        fatalLog('[ç»„ä»¶å]å¿…å¡« - Please enter new component name');
    }

    if (!process.argv[4]) {
        fatalLog('[ç»„ä»¶ä¸­æ–‡å]å¿…å¡« - Please enter new component cn name');
    }
    const maintainer = handleMaintainer(process.argv[5] || '');

    const { namespace, themes } = fs.existsSync(path.join(programPath, './mtd.config.js')) ? require(path.join(programPath, './mtd.config.js')) : require(path.join(programPath, './config.js'));
    const ComponentsFile = require(path.join(programPath, './components.json'));

    const componentName = process.argv[3];
    const chineseName = process.argv[4] || '';

    if (!DISABLE_COMPONENT_NAME_INSPECTION) {
        let cmpNamespace;
        if (namespace) {
            cmpNamespace = namespace;
        } else {
            cmpNamespace = require(path.join(programPath, './config.js')).namespace;
        }
        if (!componentName.startsWith(cmpNamespace)) {
            fatalLog(`ç»„ä»¶åç§°å¿…é¡»ä»¥${cmpNamespace}å¼€å¤´,å½“å‰å¡«å†™çš„ç»„ä»¶åä¸º${componentName}`);
        }
    }

    function resolve(...dirs) {
        return path.join(programPath, ...dirs);
    }

    function createComponentPackage(name) {
        return function (...dirs) {
            return resolve('components', name, ...dirs);
        };
    }

    function saveFile(file, content) {
        const dir = path.dirname(file);
        if (!fs.existsSync(dir)) {
            fs.mkdirSync(dir);
        }
        fs.writeFileSync(file, content + '\n');
        console.log('save file: ', file, ' done');
    }

    const exportName = upperCamelCase(componentName);
    const resolvePackage = createComponentPackage(componentName);

    if (ComponentsFile[componentName]) {
        console.error(`${componentName} å·²å­˜åœ¨.`);
        process.exit(1);
    }
    // æ·»åŠ åˆ° components.json
    ComponentsFile[componentName] = `components/${componentName}`;
    saveFile(resolve('components.json'), JSON.stringify(ComponentsFile, null, '  '));
    const nameWithoutPrefix = removeNamespace(namespace, componentName);
    const componentClassName = `${namespace}-${nameWithoutPrefix}`;
    // åˆå§‹åŒ–ç»„ä»¶ç›¸å…³æ–‡ä»¶
    const Files = [
        {
            file: resolvePackage(technology === 'es' ? 'index.js' : 'index.ts'),
            content:
                technology === 'es'
                    ? esRegistryTemplate(exportName, componentName)
                    : tsRegistryTemplate(exportName, componentName),
        },
        {
            file: resolvePackage(`${componentName}.vue`),
            content:
                technology === 'es'
                    ? esComponentTemplate(exportName, componentClassName)
                    : tsComponentTemplate(exportName, componentClassName),
        },
        {
            file: resolve(`components/${componentName}/doc/demo.vue`),
            content: technology === 'es' ? esDemoTemplate(exportName) : tsDemoTemplate(exportName),
        },
        {
            file: resolve(`types/${componentName}.d.ts`),
            content: typeDefTemplate(exportName),
        },
        {
            file: resolve(`components/${componentName}/doc/api.json`),
            content: componentDocTemplate(componentName, chineseName, maintainer),
        },
    ];

    themes.forEach(theme => {
        Files.push({
            file: resolve('components', theme, `${componentName}.scss`),
            content: sassTemplate(removeNamespace(namespace, componentName)),
        });
    });

    // æ›´æ–°index.scssæ–‡ä»¶
    Files.push({
        file: resolve('components/theme-chalk/index.scss'),
        content: `${fs.readFileSync(resolve('components/theme-chalk/index.scss'), 'utf-8')}@import "./${componentName}.scss";`,
    });

    Files.forEach(file => {
        saveFile(file.file, file.content);
    });

    fs.mkdirSync(resolve('components', componentName, 'components'));

    // æ·»åŠ åˆ° nav.config.json
    const navConfigFile = require(resolve('nav.config.json'));

    function findComponentConfig(navConfig) {
        return navConfig.find(nav => nav.path === '/components');
    }

    const componentNavs = findComponentConfig(navConfigFile);
    // æ·»åŠ åˆ°æœ€åä¸€ä¸ª group ä¸­
    const { groups } = componentNavs;
    groups[groups.length - 1].list.push({
        path: componentName,
        name: exportName,
        cnName: chineseName,
    });

    saveFile(resolve('nav.config.json'), JSON.stringify(navConfigFile, null, '  '));
    const testFileName = `tests/unit/${componentName}.spec.${getExtFromTechnology(technology)}`;
    fs.writeFileSync(resolve(testFileName), testTemplate(exportName, componentName));

    buildEntry();
    buildTS();
    buildCSS();

    console.log(`[success]æ–‡ä»¶ç”Ÿæˆå®Œæˆï¼Œå¯ä»¥è¿›å…¥components/${componentName}æ–‡ä»¶å¤¹å¼€å‘ç»„ä»¶å•¦ğŸŒ`);
}