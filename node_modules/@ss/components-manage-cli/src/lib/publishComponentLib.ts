import { join } from 'path';
import { checkDocAPI, getMaterialVersion, getFrameworkVersion } from '../util/common';
import { injectReportLogic } from '../util/report';
import { extractReleaseInfo } from '../util/release';
import { publishApi } from '@ss/components-manage-tools';
const fs = require('fs');

export async function publishComponentLib(options: any) {
    if (options.skipCheck) {
        options.skipCheckBranch = true;
        options.skipTest = true;
    }
    const dir = process.cwd();
    checkDocAPI(dir);

    const config = require(join(dir, 'template.json'));
    if (config.framework === 'vue') {
        injectReportLogic();
    }

    const data = await extractReleaseInfo(options);
    data.techStackVersion = getFrameworkVersion(config.framework);
    data.materialVersion = getMaterialVersion();
    data.isFollowLowcode = fs.existsSync(join(process.cwd(), 'lowcode'));
    data.noPublishLowcode = options.publishNoLowcode ? true : false;
    await publishApi(data, 'component', true);
}
