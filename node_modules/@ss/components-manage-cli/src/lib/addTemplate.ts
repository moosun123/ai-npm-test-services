import { checkLogin, infoLog, fatalLog, successLog, warningLog } from '@ss/components-manage-tools';
import { askInstallInCwd } from '../util/questions';
import fs from 'fs';
import path from 'path';
import fetch from 'node-fetch';
import { execSync } from 'child_process';
import { hasYarn, hasProjectYarn } from '@vue/cli-shared-utils';
import { envHost } from '../util/constant';

async function getTemplateInfo(params) {
    const stringData = JSON.stringify(params);
    try {
        const value = await fetch(`${envHost}/openapi/template/download`, {
            method: 'POST',
            body: stringData,
            headers: {
                'Content-Type': 'application/json',
            },
        });
        const res = await value.json();
        if (res.code !== 0) {
            fatalLog(`${res.message}`);
        }
        return res.data;
    } catch (error) {
        fatalLog(`è·å–æ¨¡æ¿ä¿¡æ¯å¤±è´¥ï¼š${error}`);
    }
}

function installDep(depends) {
    if (!depends) return '';
    let bin = hasYarn() && hasProjectYarn(process.cwd()) ? 'yarn add' : 'npm i';
    let shell = '';
    let npmMap = ' --registry=http://r.npm.sankuai.com';

    if (depends.dependencies) {
        shell += `${bin}`;
        Object.keys(depends.dependencies).forEach(pkgName => {
            shell += ` ${pkgName}@${depends.dependencies[pkgName]}`;
        });
        shell += npmMap;
    }

    if (depends.devDependencies) {
        shell += shell ? ` && ${bin} -D` : ` ${bin} -D`;
        Object.keys(depends.devDependencies).forEach(pkgName => {
            shell += ` ${pkgName}@${depends.devDependencies[pkgName]}`;
        });
        shell += npmMap;
    }

    if (shell) {
        infoLog(`å¼€å§‹å®‰è£…æ¨¡æ¿ä¾èµ–...`);
        try {
            execSync(shell, { stdio: 'inherit' });
        } catch (err) {
            warningLog(`å®‰è£…æ¨¡æ¿ä¾èµ–å¤±è´¥ï¼š${err}`);
        }
    }
}

export async function addTemplate(tplId: string, target: string, fileName: string, cmd: any) {
    const token = checkLogin();
    if (!target) {
        const result = await askInstallInCwd();
        if (!result.isOk) process.exit(0);
        target = '/';
    }

    // è·å–æ¨¡æ¿ç›¸å…³æ•°æ®
    let { url, depends } = await getTemplateInfo({ token, tplId });
    if (!url) fatalLog(`è·å–æ¨¡æ¿ url å¤±è´¥`);

    // ä¸‹è½½å¹¶è§£å‹æ¨¡æ¿åŒ…
    let dirPath = path.join(process.cwd(), target);
    if (!fs.existsSync(dirPath)) {
        fs.mkdirSync(dirPath);
        infoLog(`ç›®å½•ä¸å­˜åœ¨ï¼Œå·²è‡ªåŠ¨åˆ›å»ºï¼š${dirPath}\n`);
    }
    infoLog('å¼€å§‹ä¸‹è½½æ¨¡æ¿...\n');

    let temporaryPkg = `${tplId}-temp`;
    target = path.join(dirPath, temporaryPkg);
    let stream = fs.createWriteStream(target);

    try {
        const res = await fetch(url);
        await new Promise((resolve, reject) => {
            res.body.pipe(stream).on('close', function (err) {
                if (err) {
                    reject(err);
                } else {
                    resolve(null);
                }
            });
        });
        infoLog('æ¨¡æ¿å‹ç¼©åŒ…ä¸‹è½½å®Œæ¯•ï¼Œå¼€å§‹è§£å‹\n');
    } catch (err) {
        fatalLog(`ä¸‹è½½æ¨¡æ¿å‹ç¼©åŒ…å¤±è´¥ï¼š${err}`);
    }

    try {
        // æ·»åŠ  { stdio : 'pipe' } å¯éšè—é»˜è®¤ stdout
        const realPath = dirPath.endsWith('/') ? dirPath : `${dirPath}/`;
        execSync(
            `mkdir ${realPath}.temDir && tar -zxvkf ${target} -C ${realPath}.temDir && mv ${realPath}.temDir/* ${realPath}${fileName} && rm -rf ${realPath}.temDir`,
            { stdio: 'pipe' },
        );
        infoLog(`è§£å‹å®Œæˆ`);
    } catch (err) {
        if (err.toString().includes('Already exists')) {
            fatalLog(`${err}\nè§£å‹å¤±è´¥ï¼šè¯·åˆ é™¤ä¸Šè¿°æ–‡ä»¶æˆ–ç›®å½•åé‡æ–°è¿è¡Œå‘½ä»¤`);
        } else {
            fatalLog(`è§£å‹å¤±è´¥ï¼š${err}`);
        }
    }

    try {
        execSync(`rm ${target}`, { stdio: 'pipe' });
    } catch (err) {
        warningLog(`åˆ é™¤å‹ç¼©åŒ…${temporaryPkg}å¤±è´¥ï¼š${err}`);
    }

    // å®‰è£…ä¾èµ–æµç¨‹
    if (!cmd.skipInstallDep) installDep(depends);

    successLog(`ğŸ‰æ¨¡æ¿å·²æˆåŠŸæ·»åŠ ï¼Œè¯·å¼€å§‹ä½¿ç”¨å§`);
    process.exit(0);
}
