<template>
  <mtd-autocomplete v-model="value"
    @search="handleSearch"
    @blur="handleBlur"
    @change="handleChange"
    @select="handleSelect"
    placeholder="请输入">
    <mtd-option v-for="(item, i) in options"
      :key="i"
      :label="item.label"
      :value="item.value" />
  </mtd-autocomplete>
</template>
<script>
import {
  setInputValue,
  waitImmediate,
  triggerEvent,
  triggerClick,
} from '@test/util';

export default {
  data () {
    return {
      options: [],
      value: '',

      handleSelect () {},
      handleBlur () {},
      handleChange () {},
    };
  },
  methods: {
    handleSearch (value) {
      this.options = value.split('').map((v, index) => {
        return {
          label: value.slice(0, index + 1),
          value: value.slice(0, index + 1),
        };
      });
    },
    async doTest (done) {
      this.handleSelect = sinon.spy();
      this.handleBlur = sinon.spy();
      this.handleChange = sinon.spy();

      const text = '李白';

      const input = this.$el.querySelector('input');
      triggerEvent(input, 'focus', true, true);
      setInputValue(input, text);
      await waitImmediate();
      expect(this.value).to.be.eql(text);

      const option = document.body.querySelector('.mtd-autocomplete-dropdown-menu .mtd-dropdown-menu-item');
      triggerEvent(input, 'blur', true, true);
      triggerClick(option, true, true);

      expect(this.value).to.be.eql(text.charAt(0));
      this.handleSelect.should.have.been.calledOnce();
      this.handleBlur.should.have.been.calledOnce();
      this.handleChange.should.have.been.calledOnce();

      expect(this.handleSelect.calledAfter(this.handleChange), 'select should after change').to.be.true();
      expect(this.handleBlur.calledAfter(this.handleSelect), 'blur should after select').to.be.true();
      done();
    },
  },
};
</script>
