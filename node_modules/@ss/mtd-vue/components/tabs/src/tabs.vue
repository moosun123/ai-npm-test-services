<script>
import TabNav from './tab-nav';
import { warn } from '@/utils/console';
import { CONFIG_PROVIDER,
  getPrefixCls,
  getSize,
} from '@/utils/config';

function hasContent (panes, vnodes) {
  /* 当 pane 中子节点中有 v-if 时，pane.$slots.default 会为 undefined
   * 而 vnode 中的 componentOptions.children 会包含相关 vnode
   * to fix: https://tt.sankuai.com/ticket/detail?id=4028083
  */
  return panes.some((pane) => pane.hasContent);
}

function getComponentName (vnode) {
  if (!vnode) return '';
  if (vnode.componentOptions) {
    return vnode.componentOptions.Ctor.options.name;
  }

  if (!vnode.$vnode) return '';
  if (vnode.$vnode.componentOptions) {
    return vnode.$vnode.componentOptions.Ctor.options.name;
  }
  return '';
}

function isTabPane (vnode) {
  const name = getComponentName(vnode);
  return name.indexOf('TabDrop') > -1 || name.indexOf('TabPane') > -1;
}

const MAX_LEVEL = 3;

export function findTabPanes (vnodes, level) {
  return (vnodes || []).reduce((array, vnode) => {
    if (isTabPane(vnode)) {
      array.push(vnode);
    } else if (level < MAX_LEVEL) {
      const child = (vnode && vnode.componentInstance ? vnode.componentInstance.$children : vnode.children) || [];

      if (child.length) {
        return array.concat(findTabPanes(child, level + 1));
      }
    }
    return array;
  }, []);
}

function getTabPanes (vnodes) {
  return findTabPanes(vnodes, 0).map((vnode) => {
    // 必须要求 vnode 已经 mounted
    return vnode.componentInstance || vnode.$vnode.componentInstance;
  }).filter(Boolean);
}

export default {
  name: 'MtdTabs',

  components: {
    TabNav,
  },

  props: {
    type: String,
    closable: Boolean,
    addable: Boolean,
    value: [String, Number, Object, Array],
    tabPosition: {
      type: String,
      default: 'top',
    },
    size: {
      type: String,
      default: 'large',
    },
    lineSize: Number,
    // position left 数量
    verticalHeightNumber: {
      type: Number,
      default () {
        return 1000;
      },
    },
    dropAutosize: Boolean, // 未来将默认为 true，暂时不写属性说明
    flex: Boolean, // 未来将默认 flex，文档暂时不做说明
    tabComponent: {
      type: [String, Object],
    },
  },
  inject: {
    config: {
      from: CONFIG_PROVIDER,
      default: {
        getPrefixCls,
        getSize,
      },
    },
  },
  data () {
    return {
      currentValue: this.value,
      panes: [],
      tabStyle: {
        height: null,
      },
      showPanel: true,
    };
  },

  computed: {
    prefix () {
      return this.config.getPrefixCls('tabs');
    },
    _size () {
      return this.config.getSize(this);
    },
    hasInputListener () {
      return 'input' in this.$listeners;
    },
  },

  watch: {
    value (value) {
      this.setCurrentValue(value);
    },
  },

  created () {
    this.$on('tab-nav-update', this.calcPaneInstances.bind(null, { force: true }));
  },

  mounted () {
    // 判断是否需要
    this.calcHeight();
    this.calcPaneInstances();
  },

  updated () {
    this.calcPaneInstances();
  },

  methods: {
    calcHeight () {
      if (this.tabPosition === 'left') {
        setTimeout(() => {
          const { nav } = this.$refs;
          if (nav) {
            const { offsetHeight } = nav.$el;
            this.tabStyle.height = offsetHeight + 'px';
          }
        }, 0);
      }
    },
    calcPaneInstances (options) {
      const panes = getTabPanes(this.$slots.default);
      const changed = !(panes.length === this.panes.length &&
        panes.every((pane, index) => {
          return pane === this.panes[index];
        }));
      if (changed || (options && options.force)) {
        this.panes = panes;
        const nav = this.$refs.nav;
        nav && nav.updateNav();
        this.setCurrentValue(this.value);
        this.showPanel = this.panes && hasContent(this.panes, this.$slots.default);
        this.calcHeight();
      }
    },
    handleTabClick (event, tab, tabValue, index) {
      if (tab && tab.disabled) { return; }
      this.setValue(tabValue, index);
      this.$emit('tab-click', event, tab);
    },
    handleTabRemove (event, pane) {
      if (pane.disabled) return;
      event.stopPropagation();
      this.$emit('tab-remove', event, pane.value);
    },
    handlePrevClick (event) {
      this.$emit('prev-click', event);
    },
    handleNextClick (event) {
      this.$emit('next-click', event);
    },
    setValue (value, index) {
      if (this.value !== value) {
        this.$emit('input', value);
      }
      if (!this.hasInputListener) {
        // 兼容历史版本，后期移除 currentValue
        this.setCurrentValue(value, index);
        warn('Tabs', 'value is control props, it must has input event handler');
      }
    },
    setCurrentValue (value) {
      this.currentValue = value;
    },
    addTabButton (event) {
      this.$emit('tab-add', event);
    },
  },

  render (h) {
    const {
      type,
      handleTabClick,
      handleTabRemove,
      handlePrevClick,
      handleNextClick,
      currentValue,
      panes,
      closable,
      addable,
      tabPosition,
      _size,
      $attrs,
      verticalHeightNumber,
      tabStyle,
      showPanel,
      lineSize,
      dropAutosize,
      prefix,
      flex,
    } = this;
    const navData = {
      props: {
        currentValue,
        closable,
        addable,
        type,
        panes,
        size: _size,
        lineSize,
        tabPosition,
        verticalHeightNumber,
        dropAutosize,
        prefix,
        getPrefixCls: this.config.getPrefixCls,
        tabComponent: this.tabComponent,
      },
      on: {
        onTabClick: handleTabClick,
        onTabRemove: handleTabRemove,
        onPrevClick: handlePrevClick,
        onNextClick: handleNextClick,
      },
      ref: 'nav',
    };
    Object.assign(navData.props, $attrs);
    const borderStyle = {};

    if (!type) {
      if (tabPosition === 'top') {
        borderStyle['height'] = lineSize || lineSize === 0 ? `${lineSize}px` : '';
      } else {
        borderStyle['width'] = lineSize || lineSize === 0 ? `${lineSize}px` : '';
      }
    }

    const nav = (
      <div class={ [`${prefix}-nav`, tabPosition] }>
        <tab-nav { ...navData }></tab-nav>
        <div
          class={`${prefix}-bottom-border`}
          style={borderStyle}
        ></div>
      </div>
    );
    const panels = (
      <div
        class={`${prefix}-content`}
        ref="panes"
        v-show={showPanel}
      >
        {this.$slots.default}
      </div>
    );
    return (
      <div
        class={{
          [`${prefix}`]: true,
          [`${prefix}-flex`]: flex,
          [`${prefix}-nocard`]: !type,
          [`${prefix}-card`]: type === 'card',
          [`${prefix}-border-card`]: type === 'border-card',
          [`${prefix}-left`]: this.tabPosition === 'left',
          [`${prefix}-${this._size}`]: this._size,
        }}
        style={tabStyle}
        ref='tab'
      >
        { [nav, panels] }
      </div>
    );
  },
};
</script>
