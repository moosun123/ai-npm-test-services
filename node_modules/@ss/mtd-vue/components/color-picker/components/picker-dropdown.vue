<template>
  <transition :name="tn">
    <div
      :class="`${prefix}-dropdown`">
      <div :class="`${prefix}-dropdown-main-wrapper`">
        <hue-slider ref="hue" :color="color" vertical style="float: right;" />
        <sv-panel ref="sl" :color="color" />
      </div>
      <alpha-slider v-if="showAlpha" ref="alpha" :color="color" />
      <predefine v-if="predefine" :color="color" :colors="predefine" />
      <div :class="`${prefix}-dropdown-btns`">
        <span :class="`${prefix}-dropdown-value`">
          <mtd-input
            v-model="customInput"
            @keyup.native.enter="handleConfirm"
            @blur="handleConfirm"
            :validate-event="false"
            size="small" />
        </span>
        <mtd-button
          size="small"
          type="text"
          @click="clearColor">
          清空
        </mtd-button>
        <mtd-button
          plain
          size="small"
          :class="`${prefix}-dropdown-btn`"
          @click="confirmValue">
          确定
        </mtd-button>
      </div>
    </div>
  </transition>
</template>

<script>
import SvPanel from './sv-panel';
import HueSlider from './hue-slider';
import AlphaSlider from './alpha-slider';
import Predefine from './predefine';
import Locale from '@/mixins/locale';
import MtdInput from '@components/input';
import MtdButton from '@components/button';
import { CONFIG_PROVIDER,
  getPrefixCls,
} from '@/utils/config';

export default {
  name: 'MtdColorPickerDropdown',

  components: {
    SvPanel,
    HueSlider,
    AlphaSlider,
    MtdInput,
    MtdButton,
    Predefine,
  },

  mixins: [Locale],

  props: {
    color: {
      required: true,
      type: Object,
    },
    showAlpha: Boolean,
    predefine: Array,
  },

  inject: {
    config: {
      from: CONFIG_PROVIDER,
      default: {
        getPrefixCls,
      },
    },
  },

  data () {
    return {
      customInput: '',
    };
  },

  computed: {
    tn () {
      return this.config.getPrefixCls('zoom-in-top');
    },
    prefix () {
      return this.config.getPrefixCls('color');
    },
    currentColor () {
      return this.color ? this.color.value : '';
    },
  },

  watch: {
    visible (val) {
      if (val === true) {
        this.$nextTick(() => {
          const { sl, hue, alpha } = this.$refs;
          sl && sl.update();
          hue && hue.update();
          alpha && alpha.update();
        });
      }
    },

    currentColor: {
      immediate: true,
      handler (val) {
        this.customInput = val;
      },
    },
  },

  methods: {
    confirmValue () {
      this.$emit('pick');
    },

    handleConfirm () {
      this.color.fromString(this.customInput);
    },

    clearColor () {
      this.$emit('clear');
      this.customInput = '';
    },
  },
};
</script>
