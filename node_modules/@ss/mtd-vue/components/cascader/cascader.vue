<template>
  <popper
    :class="{
      [`${prefix}`]: true,
      [`${prefix}-disabled`]: disabled,
      [`${prefix}-${_size}`]: _size,
      'focus': visible,
    }"
    :popper-disabled="disabled"
    :visible="visible"
    trigger="click" ref="popper" :placement="placement"
    :append-to-container="appendToContainer"
    :get-popup-container="getPopupContainer"
    :popper-options="popperOptions"
    @clickoutside="handleClickoutside"
  >
    <Reference>
      <div>
        <select-input :size="_size" ref="input"
          v-model="inputValue" :placeholder="currentPlaceholder"
          :disabled="disabled" :readonly="!filterable"
          :clearable="clearable"
          :suffix-icon="sIcon"
          :invalid="invalid"
          @focus="handleFocus"
          @click.native="handleInputClick"
          @clear="handleClear"
          @input="handleInput"
          @compositionstart="handleComposition"
          @compositionupdate="handleComposition"
          @compositionend="handleComposition"
          v-if="!multiple"
        />
        <mtd-multiple-input v-else
          ref="multipleInput"
          :value="valueStrs"
          :size="_size"
          :input-value="inputValue"
          :max-tag-count="maxTagCount"
          :readonly="disabled || !filterable"
          :disabled="disabled"
          :clearable="clearable"
          :closable="!disabled"
          :suffix-icon="sIcon"
          :placeholder="placeholder"
          :focused="visible"
          :invalid="invalid"
          @update:inputValue="handleInputChange"
          @remove="handleTagRemove"
          @clear="handleClear"
          @focus="handleFocus"
          @click.native="handleInputClick"

          @compositionstart="handleComposition"
          @compositionupdate="handleComposition"
          @compositionend="handleComposition"
        />
      </div>
    </Reference>
    <Drop use-show :class="[popperClass, `${prefix}-popper`]">
      <slot name="addendum-header" />
      <mtd-cascader-menus ref="menus"
        :filterable="filterable && !remote"
        :filter="filter" :filter-method="filterMethod"
        :filter-parent="!changeOnSelect" :menu-width="inputWidth"
        :data="data" :show-select-all="showSelectAll"

        :props="fieldNames" :change-on-select="changeOnSelect"
        :expand-trigger="expandTrigger" :load-data="loadData"
        :loading="loading" :loading-text="loadingText"
        :no-data-text="noDataText" :no-match-text="noMatchText"
        :expandable-on-disabled="expandableOnDisabled"
        :default-expand-first-item="defaultExpandFirstItem && value && value.length === 0"
        :expanded-value="expandedValue"
        @expanded-change="handleExpandedChange"

        :value="expandedValue"
        @select="handleSelect"
        @click="handleClickItem"
        :update-after-loaded="updateAfterLoaded"

        :multiple="multiple"
        :check-strictly="checkStrictly"
        :checked-strategy="checkedStrategy"
        :checked-values="value"
        :disabled-strictly="disabledStrictly"
        @update:checkedValues="handleCheckedChange"
      >
        <template slot-scope="{ node, data }">
          <slot :node="node" :data="data"><span>{{ node.label }}</span></slot>
        </template>
      </mtd-cascader-menus>
      <slot name="addendum-footer" />
    </Drop>
  </popper>
</template>
<script>
import { Popper, Reference, Drop } from '@components/popper';
import SelectInput from '@components/select-input';
import { hasProps } from '@/utils/vnode';
import Menus from './menus';
import { DEFAULT_FIELD_NAMES, getActivePaths } from './util.js';
import debounce from 'throttle-debounce/debounce';
import MtdMultipleInput from '../multiple-input';
import {
  CONFIG_PROVIDER,
  getPrefixCls,
  getIconCls,
  getSize,
} from '@/utils/config';

function ValuesCached () {
  this.keys = []; // 二维数组
  this.values = []; //
}

/**
 * @param key string[] | number[] | object[]
 */
ValuesCached.prototype.indexOf = function (key) {
  const { keys } = this;
  let result = -1;
  for (let i = 0; i < keys.length; i++) {
    const current = keys[i];
    if (current === key ||
      (current.length === key.length && current.every((k, i) => k === key[i]))
    ) {
      result = i;
      break;
    }
  }
  return result;
};
/**
 * @param key string[] | number[] | object[]
 * @param value string[]
 */
ValuesCached.prototype.set = function (key, value) {
  this.keys.push(key);
  this.values.push(value);
};

ValuesCached.prototype.get = function (key) {
  const index = this.indexOf(key);
  if (index > -1) {
    return this.values[index];
  }
  return undefined;
};

export default {
  name: 'Cascader',
  components: {
    Popper,
    Reference,
    Drop,
    SelectInput,
    MtdMultipleInput,
    MtdCascaderMenus: Menus,
  },
  props: {
    icon: String,
    data: {
      type: Array,
      default () {
        return [];
      },
    },
    value: {
      type: Array,
      default () {
        return [];
      },
    },
    noDataText: String,
    props: {
      type: Object,
      default () {
        return {};
      },
    },
    changeOnSelect: Boolean,
    expandTrigger: String,
    formatter: Function,
    separator: {
      type: String,
      default: ' / ',
    },
    loadData: Function,
    filterable: Boolean,
    debounce: {
      type: Number,
      default: 300,
    },
    filterMethod: Function,
    remote: Boolean,
    remoteMethod: Function,
    noMatchText: String,
    invalid: Boolean,
    loading: Boolean,
    loadingText: String,
    disabled: Boolean,
    clearable: Boolean,
    size: String,
    placeholder: {
      type: String,
      default () {
        return '请选择';
      },
    },
    popperClass: String,
    placement: {
      type: String,
      default: 'bottom-start',
    },
    visible: Boolean,
    appendToContainer: {
      type: Boolean,
      default: true,
    },
    getPopupContainer: Function,

    multiple: Boolean,
    checkStrictly: Boolean,
    checkedStrategy: {
      type: String,
      default: 'parent',
      validator (v) {
        return ['all', 'parent', 'children'].indexOf(v) > -1;
      },
    },
    maxTagCount: Number,
    popperOptions: Object,
    closeOnSelect: Boolean,
    reserveKeyword: {
      type: Boolean,
      default: true,
    },
    expandableOnDisabled: {
      // see: https://ones.sankuai.com/ones/product/4348/workItem/requirement/detail/9014200
      type: Boolean,
      default: false,
    },
    disabledStrictly: {
      type: Boolean,
      default: true,
    },
    useCache: {
      // todo:临时属性，用于是否启用 value 匹配缓存，后续通过变更实现来去除改属性
      type: Boolean,
      default: false,
    },
    defaultExpandFirstItem: {
      type: Boolean,
      default: false,
    },
    showSelectAll: { // 先不建议使用，和其他属性还未做兼容
      type: Boolean,
      default: false,
    },
    updateAfterLoaded: Boolean,
  },
  inject: {
    config: {
      from: CONFIG_PROVIDER,
      default: {
        getPrefixCls,
        getIconCls,
        getSize,
      },
    },
  },
  data () {
    return {
      inputValue: '',
      expandedValue: this.multiple ? [] : this.value,
      focused: false,
      previousQuery: null,
      filter: '',
      inputWidth: '',
      valueStrs: '',
      cached: new ValuesCached(),
    };
  },
  computed: {
    sIcon () {
      return hasProps(this, 'icon') ? this.icon : this.config.getIconCls('down-thick');
    },
    prefix () {
      return this.config.getPrefixCls('cascader');
    },
    _size () {
      return this.config.getSize(this);
    },
    fieldNames () {
      return {
        ...DEFAULT_FIELD_NAMES,
        ...this.props,
      };
    },
    currentPlaceholder () {
      return !this.filterable || !this.focused ? this.placeholder
        : (this.valueStrs[0] || this.placeholder);
    },
  },
  watch: {
    visible: {
      immediate: true,
      handler (n) {
        n ? this.handleMenuVisible() : this.handleMenuHidden();
      },
    },
    value: {
      immediate: true,
      handler (n, v) {
        /**
         * 保留历史计算结果，所以没有将其作为计算属性
         * 存在远程搜索的情况，在此情况下历史 data 会被重新赋值，如果重新计算会找不到原有对应值
         * */
        this.updateValueStrs();
      },
    },
    valueStrs: {
      immediate: true,
      handler (n, old) {
        if (!this.multiple) {
          if ((!old || n[0] !== old[0])) {
            const isQuerying = this.previousQuery;
            if (!n[0] && isQuerying) {
              // 修复 Cascader 异步搜索的时候会清空query的问题 [TT](https://tt.sankuai.com/ticket/detail?id=70083671)
              // value 对应不上 data 里面的时候保留query
              return;
            }
            this.setInputValue(n, { force: true });
          }
        } else {
          this.$nextTick(() => {
            this.updatePopper();
          });
        }
      },
    },
    expandedValue () {
      this.$nextTick(() => {
        this.updatePopper();
      });
    },
    data (n, v) {
      this.updateValueStrs();
      if (this.visible && n !== v) {
        this.expandedValue = this.multiple ? [] : this.value;
      }
    },
  },

  created () {
    this.debouncedQuery = !this.debounce ? this.handleQuery
      : debounce(this.debounce, this.handleQuery);
  },
  methods: {
    openMenu () {
      if (!this.visible) {
        this.$emit('update:visible', true);
      }
    },
    closeMenu () {
      if (this.visible) {
        this.$emit('update:visible', false);
      }
    },
    handleMenuVisible () {
      const nextExpandedValue = this.multiple ? [] : this.value;
      if (nextExpandedValue.length !== 0) {
        this.expandedValue = nextExpandedValue;
      };
      this.focused = true;
      this.setInputValue(['']);
      const { input } = this.$refs;
      if (input) {
        this.inputWidth = `${input.$el.getBoundingClientRect().width}px`;
      }
      this.$nextTick(this.updatePopper);
      this.$nextTick(this.scrollMenu);
    },
    handleMenuHidden () {
      this.setInputValue(this.valueStrs);
      this.focused = false;
      this.filter = '';
      this.previousQuery = '';
    },
    handleClickoutside (e) {
      if (this.disabled) {
        return;
      }
      this.closeMenu();
      this.$emit('clickoutside', e);
      this.$emit('blur', e);
    },
    handleFocus (e) {
      this.focused = true;
      this.$emit('focus', e);
    },
    handleClear () {
      // 如果是过滤中点击清空按钮则清空当前搜索条件，否则清空当前值
      if (this.visible && this.filterable && this.inputValue) {
        this.setInputValue(['']);
      } else {
        this.$emit('clear');
        this.setValue([], [], []);
      }
    },
    handleInput (v) {
      if (!this.visible) {
        // to fix: https://tt.sankuai.com/ticket/detail?id=5934989
        this.openMenu();
      }
      this.debouncedQuery(this.inputValue);
    },
    handleInputChange (v) {
      this.inputValue = v;
      this.$nextTick(this.updatePopper);
      this.handleInput(v);
    },
    handleComposition (e) {
      const { type } = e;
      if (type === 'compositionend') {
        this.isOnComposition = false;
        // 当混合输入前后值不变时，不会触发后续的 input 事件，所以需要再次触发 query
        this.debouncedQuery(this.inputValue);
      } else {
        this.isOnComposition = true;
      }
    },
    handleInputClick () {
      if (this.disabled) {
        return;
      }
      if (!this.visible) {
        this.openMenu();
      } else if (!this.filterable) {
        this.closeMenu();
      }
    },
    handleQuery (val) {
      if (this.previousQuery === val || this.isOnComposition) {
        return;
      }
      this.previousQuery = val;
      if (this.remote) {
        this.remoteMethod && this.remoteMethod(val);
      } else {
        this.filter = val;
      }
      // 如果通过样式修改面板高为不定高后，依赖此方法重新定位
      this.$nextTick(() => {
        this.updatePopper();
      });
      this.$emit('filter', val);
    },

    setValue (values, nodes) {
      this.$emit('input', values);
      const datas = nodes.map((node) => node.data);
      this.$emit('change', values, datas, nodes);
    },
    setInputValue (values, option = {}) {
      if (this.filterable || option.force) {
        this.inputValue = this.multiple ? '' : values[0];
      }
    },
    setMultipleValue (values, paths, lastNode) {
      this.$emit('input', values);
      const datas = paths.map((path) => {
        return path.map((node) => node.data);
      });
      this.$emit('change', values, datas, paths, lastNode);
      if (this.filterable) {
        this.focus();
      }
    },
    handleSelect (value, nodes) {
      this.setValue(value, nodes);
      this.closeMenu();
    },
    handleClickItem (value, nodes) {
      this.setValue(value, nodes);

      if (this.closeOnSelect) {
        this.closeMenu();
      }
    },
    handleExpandedChange (values, nodes) {
      this.expandedValue = values;
      const datas = nodes.map((node) => node.data);
      // 展开项发生变化
      this.$emit('active-item-change', datas);
    },
    handleCheckedChange (values, paths, lastNode) {
      if (!this.reserveKeyword) {
        this.filter = '';
        this.inputValue = '';
        this.previousQuery = '';
      }
      this.setMultipleValue(values, paths, lastNode);
    },
    handleTagRemove (tag, index) {
      const { menus } = this.$refs;

      const oldNodes = menus.getNodes(this.value[index]);
      if (oldNodes && oldNodes.length) {
        const last = oldNodes[oldNodes.length - 1];
        const {
          nextCheckedValues,
          checkedPaths,
          lastNode,
        } = menus.setChecked(last, { checked: false });
        this.setMultipleValue(nextCheckedValues, checkedPaths, lastNode);
        menus.setNextRefresh(); // 防止用户手动赋值没有响应
      }
    },
    scrollMenu () {
      const menus = this.$refs.menus;
      if (menus) {
        menus.scrollIntoView();
      }
    },
    focus () {
      if (this.multiple) {
        this.$refs.multipleInput.focus();
      } else {
        this.$refs.input.focus();
      }
      this.openMenu();
    },
    blur () {
      if (this.multiple) {
        this.$refs.multipleInput.blur();
      } else {
        this.$refs.input.blur();
      }
      this.closeMenu();
    },
    updatePopper () {
      if (this.visible) {
        this.$refs.popper.updatePopper();
      }
    },
    updateValueStrs () {
      const labelField = this.fieldNames.label;
      const values = this.multiple ? this.value : [this.value];
      const { cached } = this;
      const newCached = new ValuesCached();
      this.valueStrs = values.map((value) => {
        let actived = this.useCache ? cached.get(value) : undefined;
        if (!actived) {
          const { result, matched } = getActivePaths(this.data, value, this.fieldNames);
          actived = result;
          if (this.useCache && matched) {
            newCached.set(value, actived);
          }
        } else {
          newCached.set(value, actived);
        }
        const labels = actived.map((item) => item[labelField]);
        if (this.formatter) {
          return this.formatter(labels, actived, value);
        }
        return labels.join(`${this.separator}`);
      }).filter((str) => str !== null && str !== undefined);
      this.cached = newCached;
    },

    getNodes (values) {
      const { menus } = this.$refs;
      if (menus) {
        return menus.getNodes(values);
      }
      return [];
    },
    getNode (value) {
      const { menus } = this.$refs;
      if (menus) {
        return menus.getNode(value);
      }
      return undefined;
    },
  },
};
</script>
