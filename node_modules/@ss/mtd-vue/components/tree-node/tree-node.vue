<template>
  <div :class="[prefix, className, {
    [`${prefix}-leaf`]: node.isLeaf,
    [`${prefix}-expanded`]: node.expanded,
    [`${prefix}-disabled`]: disabled,
    [`${prefix}-selected`]: node.selected,
  }]"
    :draggable="draggable"
    @dragstart.stop="handleDragStart"
    @dragover.stop="handleDragOver"
    @dragend.stop="handleDragEnd"
    @drop.stop="handleDrop"
    v-show="node.visible"
  >
    <div :class="`${prefix}-content`"
      :style="{ 'padding-left': `${indent}px` }"
       @click.stop="handleClick"
    >
      <i
        :class="{
          [hiddenCls]: !expandable,
          [`${prefix}-expand-icon`]: !loading,
          [expandIcon]: !loading,
          [`${prefix}-loading-icon`]: loading,
          [iconPrefix('loading')]: loading,
        }"
        @click.stop="handleExpandIconClick" />
      <mtd-checkbox @click.native.stop v-if="checkable"
        size="large" :checked="node.checked"
        :indeterminate="node.indeterminate"
        :is-under-control="false"
        :disabled="disableCheckbox"
        @input="handleCheckboxInput"
      />
      <i :class="[`${prefix}-icon`, node.icon]" v-if="node.icon" />
      <span :class="`${prefix}-content-wrapper`">
        <slot :node="node" :data="data">{{ node.title }}</slot>
      </span>
    </div>
    <div :class="`${prefix}-extend-wrapper`"
      :style="{ 'padding-left': `${indent}px` }"
      v-if="!!$scopedSlots.extend">
      <div :class="`${prefix}-extend`">
        <slot :node="node" :data="data" name="extend" />
      </div>
    </div>
    <mtd-collapse-transition>
      <div :class="`${prefix}-children`"
        v-if="expandable && node.expanded && node.children">
        <mtd-tree-node
          v-for="child in node.children"
          :expand-icon="expandIcon"
          :key="child.key"
          :node="child"
          :data="child.data"
        />
      </div>
    </mtd-collapse-transition>
  </div>
</template>
<script>
import MtdCheckbox from '@components/checkbox';
import MtdCollapseTransition from '@/transitions/collapse-transition';
import { isFunction, isArray } from '@/utils/type';
import {
  CONFIG_PROVIDER,
  getPrefixCls,
  getIconCls,
} from '@/utils/config';

export default {
  name: 'TreeNode',
  components: {
    MtdCheckbox,
    MtdCollapseTransition,
  },
  inheritAttrs: false,
  props: {
    nodeClass: {
      type: [String, Function],
      default: '',
    },
    expandIcon: String,
    node: {
      type: Object,
      required: true,
    },
    data: {
      type: Object,
      required: true,
    },
    selectable: Boolean,
    destroyOnCollapse: Boolean,
    expandOnClickNode: Boolean,
    checkOnClickNode: Boolean,
    indent: Number,
    loadData: Function,

    draggable: Boolean,
  },
  inject: {
    config: {
      from: CONFIG_PROVIDER,
      default: {
        getPrefixCls,
        getIconCls,
      },
    },
  },
  data () {
    return {
      loading: false,
    };
  },
  computed: {
    hiddenCls () {
      return this.config.getPrefixCls('visible-hidden');
    },
    prefix () {
      return this.config.getPrefixCls('tree-node');
    },
    iconPrefix () {
      return this.config.getIconCls;
    },
    className () {
      const { nodeClass } = this;
      return isFunction(nodeClass) ? nodeClass(this.node, this.data)
        : nodeClass;
    },
    disabled () {
      return this.node.disabled;
    },
    expandable () {
      return !!this.node.children || (this.loadData && !this.node.isLeaf);
    },
    disableCheckbox () {
      return this.node.disableCheckbox;
    },
    checkable () {
      return this.node.checkable;
    },
    checked () {
      return this.node.checked;
    },
    nextNode () {
      const parent = this.node.$parent;
      if (parent) {
        const index = parent.children.indexOf(this.node);
        if (index > -1) {
          return parent.children[index + 1];
        }
      }
      return null;
    },
    previousNode () {
      const parent = this.node.$parent;
      if (parent) {
        const index = parent.children.indexOf(this.node);
        if (index > -1) {
          return index > 0 ? parent.children[index - 1] : null;
        }
      }
      return null;
    },
    hasNoChildren () {
      // 空数组也代表无子
      return (
        !this.node.children ||
        (isArray(this.node.children) && this.node.children.length === 0)
      );
    },
  },
  methods: {
    handleClick (e) {
      if (this.expandOnClickNode) {
        this.handleExpandIconClick();
      }
      if (this.checkOnClickNode) {
        this.handleCheckboxInput(!this.checked);
      }
      if (this.selectable && !this.disabled && !this.node.selected) {
        this.$emit('selected', this.node, true);
      }
      this.$emit('node-click', this.node, this.data, e);
    },
    handleExpandIconClick () {
      if (this.expandable && !this.loading) {
        const expanded = !this.node.expanded;
        if (expanded && this.loadData && !this.node.loaded &&
          !this.node.isLeaf && this.hasNoChildren
        ) {
          this.loading = true;
          this.loadData(this.node, this.handleLoadData);
        }
        this.$emit('expandedChange', this.node, expanded);
        // todo 看下 loadData 时需不需要发送 expanded 事件
      }
    },
    handleCheckboxInput (v) {
      if (!this.disabled && !this.disableCheckbox) {
        this.$emit('checkedChange', this.node, v);
      }
    },
    handleLoadData (children) {
      this.loading = false;
      this.$emit('loadedData', this.node, this.data, children);
    },

    handleDragStart (event) {
      if (!this.draggable) return;
      this.$emit('tree-node-drag-start', event, this);
    },

    handleDragOver (event) {
      if (!this.draggable) return;
      this.$emit('tree-node-drag-over', event, this);
      event.preventDefault();
    },

    handleDrop (event) {
      event.preventDefault();
    },

    handleDragEnd (event) {
      if (!this.draggable) return;
      this.$emit('tree-node-drag-end', event, this);
    },
  },
};
</script>
