<template>
  <div :is="tag"
    :class="`${prefix}-config-provider`"
    v-on="$listeners"
  >
    <slot />
  </div>
</template>
<script>
import {
  CONFIG_PROVIDER,
  getConfig,
  getPrefix,
  getIconPrefix,
  getSize,
} from '@/utils/config';
import { hasProps } from '@/utils/vnode';

// skip undefined prop merged and return new object.
function combine (option1, option2) {
  const option = { ...option1 };
  Object.keys(option2).forEach((key) => {
    const value = option2[key];
    if (value !== undefined) {
      option[key] = value;
    }
  });
  return option;
}

export default {
  name: 'MtdConfigProvider',
  props: {
    prefixCls: String,
    iconPrefixCls: String,
    tag: {
      type: String,
      default: 'div',
    },
    getPopupContainer: Function,
    componentSize: String,
  },
  provide () {
    return {
      [CONFIG_PROVIDER]: this,
    };
  },
  inject: {
    config: {
      from: CONFIG_PROVIDER,
      default: {
        options: {},
      },
    },
  },
  computed: {
    options () {
      return combine(this.config.options, this.$props);
    },
    prefix: {
      get () {
        return this.options.prefixCls || getPrefix();
      },
    },
    iconPrefix: {
      get () {
        return this.options.iconPrefixCls || getIconPrefix();
      },
    },
    _componentSize: {
      get () {
        return this.options.componentSize || getSize();
      },
    },
  },
  methods: {
    getSize (comp) {
      return hasProps(comp, 'size') ? comp.size : (this._componentSize || comp.size);
    },
    getPrefixCls (suffixCls, customizePrefixCls) {
      return customizePrefixCls || `${this.prefix}-${suffixCls}`;
    },
    getIconCls (suffixCls, customizePrefixCls) {
      return customizePrefixCls || `${this.iconPrefix} ${this.iconPrefix}-${suffixCls}`;
    },
    getPContainer () {
      const fn = this.options.getPopupContainer || getConfig().getPopupContainer;
      return fn();
    },
  },
};
</script>
