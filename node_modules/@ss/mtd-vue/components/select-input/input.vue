<template>
  <div :class="[`${prefix}-wrapper`, `${selectPrefix}-input`, {
      [`${prefix}-prefix`]: hasPrefix,
      [`${prefix}-suffix`]: hasSuffix,
      [`${prefix}-disabled`]: disabled,
      [`${prefix}-invalid`]: invalid,
      [`${prefix}-readonly`]: readonly,
      [`${prefix}-${_size}`]: !!_size,
      [`${prefix}-${genre}`]: !!genre,
    }]"
    @mouseenter="hovering = true"
    @mouseleave="hovering = false"
  >
    <span :class="`${prefix}-prefix-inner`" v-if="hasPrefix">
      <slot name="prefix">
        <i :class="prefixIcon" @click="handlePrefixClick" />
      </slot>
    </span>
    <input v-bind="$attrs" :type="type" :value="value"
      :readonly="readonly"
      :disabled="disabled"
      :class="prefix"
      v-on="inputLisenters"
      autocomplete="off"
      ref="input">
    <span :class="`${prefix}-suffix-inner`" v-if="hasSuffix">
      <i :class="`${prefix}-clear ${iconPrefix('error-circle')}`"
        @click.stop="handleClearClick"
        v-if="showClear" />
      <slot name="suffix" v-else>
        <i :class="suffixIcon" @click="handleSuffixIconClick" />
      </slot>
    </span>
  </div>
</template>
<script>
import { CONFIG_PROVIDER,
  getPrefixCls,
  getIconCls,
  getSize,
} from '@/utils/config';

export default {
  name: 'MtdSelectInput',
  inheritAttrs: false,
  props: {
    type: {
      type: String,
      default: 'text',
    },
    size: String,
    clearable: Boolean,
    disabled: Boolean,
    readonly: Boolean,
    invalid: Boolean,
    value: [String, Number, Array],
    prefixIcon: String,
    suffixIcon: String,
    multiple: Boolean,
    inputWidth: Number,
    genre: String,
    filterable: {
      type: Boolean,
      default () {
        return false;
      },
    },
  },
  inject: {
    config: {
      from: CONFIG_PROVIDER,
      default: {
        getPrefixCls,
        getIconCls,
        getSize,
      },
    },
  },
  data () {
    return {
      focused: false,
      hovering: false,
      query: '',
    };
  },
  computed: {
    prefix () {
      return this.config.getPrefixCls('input');
    },
    _size () {
      return this.config.getSize(this);
    },
    iconPrefix () {
      return this.config.getIconCls;
    },
    selectPrefix () {
      return this.config.getPrefixCls('select');
    },
    hasPrefix () {
      return !!(this.prefixIcon || this.$slots.prefix);
    },
    hasSuffix () {
      return this.clearable || !!(this.suffixIcon || this.$slots.suffix);
    },
    hasValue () {
      return (this.value === 0) || !!this.value;
    },
    inputLisenters () {
      const lisenters = Object.assign({}, this.$listeners, {
        input: this.handleInput,
      });
      if (lisenters.change) {
        // it will trigger change event twice if not remove
        delete lisenters.change;
      }
      return lisenters;
    },
    showClear () {
      return this.clearable && !this.disabled &&
        this.hasValue && (this.focused || this.hovering);
    },
  },
  watch: {
    value (val) {
      this.query = val;
    },
  },
  methods: {
    handleInput (event) {
      this.$emit('input', event.target.value);
    },
    handleClearClick () {
      this.$emit('clear');
      this.$emit('input', '');
    },
    handlePrefixClick (e) {
      this.$emit('click-prefix', e);
    },
    handleSuffixIconClick (e) {
      this.focus();
      this.$emit('click-suffix', e);
    },
    focus () {
      this.$refs.input.focus();
    },
    blur () {
      this.$refs.input.blur();
    },
  },
};
</script>
