<template>
  <div :class="prefix">
    <transfer-panel
      v-bind="$props"
      ref="leftPanel"
      :data="sourceData"
      :title="titles[0]"
      :default-checked="sourceDefaultChecked"
      :placeholder="filterPlaceholder"
      @checked-change="onSourceCheckedChange"
    >
      <template slot-scope="scope">
        <slot v-bind="scope" />
      </template>
      <template slot="footer" v-if="$slots.leftFooter">
        <slot name="leftFooter" />
      </template>
    </transfer-panel>
    <div :class="`${prefix}-buttons`">
      <mtd-button
        type="primary"
        :class="[`${prefix}-button`,
         hasOperations ? `${prefix}-button-with-texts` : '']"
        @click="addToLeft"
        :disabled="rightChecked.length === 0">
        <Icon name="left" />
        <span v-if="operations[0] !== undefined">{{ operations[0] }}</span>
      </mtd-button>
      <mtd-button
        type="primary"
        :class="[`${prefix}-button`,
        hasOperations ? `${prefix}-button-with-texts` : '']"
        @click="addToRight"
        :disabled="leftChecked.length === 0">
        <span v-if="operations[1] !== undefined">{{ operations[1] }}</span>
        <Icon name="right" />
      </mtd-button>
    </div>
    <transfer-panel
      v-bind="$props"
      ref="rightPanel"
      :data="targetData"
      :title="titles[1]"
      :default-checked="targetDefaultChecked"
      :placeholder="filterPlaceholder"
      @checked-change="onTargetCheckedChange">
      <template slot-scope="scope">
        <slot v-bind="scope" />
      </template>
      <template slot="footer" v-if="$slots.rightFooter">
        <slot name="rightFooter" />
      </template>
    </transfer-panel>
  </div>
</template>

<script>
import MtdButton from '@components/button';
import TransferPanel from '@components/transfer-panel';
import Icon from '@components/icon';
import {
  CONFIG_PROVIDER,
  getPrefixCls,
} from '@/utils/config';

export default {
  name: 'MtdTransfer',
  components: {
    TransferPanel,
    MtdButton,
    Icon,
  },
  props: {
    data: {
      type: Array,
      default () {
        return [];
      },
    },
    titles: {
      type: Array,
      default () {
        return ['未选', '已选'];
      },
    },
    operations: {
      type: Array,
      default () {
        return [];
      },
    },
    filterPlaceholder: {
      type: String,
      default: '请输入字段名称',
    },
    filterMethod: Function,
    sourceDefaultChecked: {
      type: Array,
      default () {
        return [];
      },
    },
    targetDefaultChecked: {
      type: Array,
      default () {
        return [];
      },
    },
    value: {
      type: Array,
      default () {
        return [];
      },
    },
    format: {
      type: Object,
      default () {
        return {};
      },
    },
    filterable: Boolean,
    props: {
      type: Object,
      default () {
        return {
          label: 'label',
          key: 'key',
          disabled: 'disabled',
        };
      },
    },
    targetOrder: {
      type: String,
      default: 'original',
    },
    noMatchText: String,
    noDataText: String,
  },
  inject: {
    config: {
      from: CONFIG_PROVIDER,
      default: {
        getPrefixCls,
      },
    },
  },
  data () {
    return {
      leftChecked: [],
      rightChecked: [],
    };
  },
  computed: {
    prefix () {
      return this.config.getPrefixCls('transfer');
    },
    dataObj () {
      const key = this.props.key;
      return this.data.reduce((o, cur) => (o[cur[key]] = cur) && o, {});
    },

    sourceData () {
      return this.data
        .filter(item => this.value.indexOf(item[this.props.key]) === -1);
    },
    targetData () {
      if (this.targetOrder === 'original') {
        return this.data
          .filter(item => this.value.indexOf(item[this.props.key]) > -1);
      } else {
        return this.value.reduce((arr, cur) => {
          const val = this.dataObj[cur];
          if (val) {
            arr.push(val);
          }
          return arr;
        }, []);
      }
    },
    hasOperations () {
      return this.operations.length === 2;
    },
  },
  methods: {
    onSourceCheckedChange (val, movedKeys) {
      this.leftChecked = val;
      if (movedKeys === undefined) return;
      this.$emit('select-change', val, 'source');
    },
    onTargetCheckedChange (val, movedKeys) {
      this.rightChecked = val;
      if (movedKeys === undefined) return;
      this.$emit('select-change', val, 'target');
    },
    addToLeft () {
      const currentValue = [...this.value];

      this.rightChecked.forEach(item => {
        const index = currentValue.indexOf(item);
        if (index > -1) {
          currentValue.splice(index, 1);
        }
      });
      this.$emit('input', currentValue);
      this.$emit('change', currentValue, 'source', this.rightChecked);
    },
    addToRight () {
      let currentValue = this.value.slice();
      const itemsToBeMoved = [];
      const key = this.props.key;
      this.data.forEach(item => {
        const itemKey = item[key];
        if (
          this.leftChecked.indexOf(itemKey) > -1 &&
          !(this.value.indexOf(itemKey) > -1)
        ) {
          itemsToBeMoved.push(itemKey);
        }
      });
      currentValue = this.targetOrder === 'unshift'
        ? itemsToBeMoved.concat(currentValue)
        : currentValue.concat(itemsToBeMoved);
      this.$emit('input', currentValue);
      this.$emit('change', currentValue, 'target', this.leftChecked);
    },
  },
};
</script>
