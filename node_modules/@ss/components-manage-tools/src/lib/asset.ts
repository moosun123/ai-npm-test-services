import { fatalLog } from '../util/log';
import { envHost, getSignature } from '../util/constant';

const fetch = require('node-fetch');

const handleParams = (params: any) => {
    const queryList: any = [];
    Object.keys(params).map((key: any) => {
        if (params[key]) {
            queryList.push(`${key}=${params[key]}`);
        }
    });
    return queryList.length > 0 ? queryList.join('&') : '';
}

export const getAssetList = async (params: any) => {
    const _octo = await getSignature();
    try {
        const query: any = handleParams(params);
        const value = await fetch(query ? `${envHost}/openapi/v1/lowcode/assetList?${query}` : `${envHost}/openapi/v1/lowcode/assetList`, {
            method: 'GET',
            headers: {
                "Content-Type": 'application/json',
                "oceanus-auth": _octo
            },
        });
        const res = await value.json();
        if (res.code !== 0) {
            fatalLog(res.message);
        } else {
            return res.data || {};
        }
    } catch (e: any) {
        fatalLog(`getAssetList failed: ${e}.`);
    }
}

export const getAssetContent = async (params: any) => {
    const _octo = await getSignature();
    try {
        const query: any = handleParams(params);
        const value = await fetch(query ? `${envHost}/openapi/v1/lowcode/assetContent?${query}` : `${envHost}/openapi/v1/lowcode/assetContent`, {
            method: 'GET',
            headers: {
                "Content-Type": 'application/json',
                "oceanus-auth": _octo
            },
        });
        const res = await value.json();
        if (res.code !== 0) {
            fatalLog(res.message);
        } else {
            return res.data || {};
        }
    } catch (e: any) {
        fatalLog(`getAssetContent failed: ${e}.`);
    }
}