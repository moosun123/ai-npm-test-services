import * as fs from 'fs';
import * as path from 'path';
import { fatalLog, successLog } from '../util/log';

const inquirer = require('inquirer');

const questions: any[] = [
    {
        type: 'input',
        name: 'token',
        message: 'è¯·è¾“å…¥ç”¨æˆ·token',
        default: '',
    },
];

const homeDir = process.env['HOME'];
const deployEnv = process.env['DEPLOY_ENV'];
const configPath = deployEnv === 'test' ? path.join(homeDir, './.cmrc-test') : path.join(homeDir, './.cmrc-prod');

export async function handleLogin(options) {
    let token = options.token;
    if (!token) {
        const answer: any = await inquirer.prompt(questions);
        token = answer.token;
    }
    fs.writeFileSync(configPath, `token: ${token}`);
    successLog('ğŸš€tokenå†™å…¥æˆåŠŸ');
    process.exit(0);
}

export function checkLogin() {
    if (!fs.existsSync(configPath)) {
        fatalLog('æ‚¨å°šæœªç™»å½•ï¼Œè¯·ç™»å½•åå†å‘å¸ƒï¼Œå‘½ä»¤ä¸ºyarn sign');
    }
    const configContent = fs.readFileSync(configPath).toString().trim();
    if (!configContent) {
        fatalLog('ç™»é™†å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•ï¼Œå‘½ä»¤ä¸ºyarn sign');
    }

    const configList = configContent.split(':');
    if (configList.length !== 2) {
        fatalLog('ç™»é™†å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•ï¼Œå‘½ä»¤ä¸ºyarn sign');
    }

    const token = configList[1].trim();
    if (!token) {
        fatalLog('ç™»é™†å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•ï¼Œå‘½ä»¤ä¸ºyarn sign');
    }
    return token;
}
